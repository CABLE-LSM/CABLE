<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Documentation for CABLE">
    <meta name="author" content="CABLE community" >
    <link rel="icon" href="../favicon.png">

    <title>cable_input.F90 &ndash; CABLE</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">CABLE </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
            <li><a href="../lists/files.html">Source Files</a></li>
            <li><a href="../lists/modules.html">Modules</a></li>
            <li><a href="../lists/procedures.html">Procedures</a></li>
                   <li><a href="../lists/types.html">Derived Types</a></li>
            <li><a href="../lists/programs.html">Programs</a></li>
       
            </ul>
        
            </li>
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>
                             <li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/programs.html">Programs</a></li>
          </ul>
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
  <div class="row">
    <h1>cable_input.F90
    <small>Source File</small>
    </h1>
    <div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 3.3% of total for source files.">1641 statements</a>
     </li> 
    <li><i class="fa fa-code"></i><a href="../src/cable_input.F90"> Source File</a></li>
  </ul>
  <ol class="breadcrumb in-well text-right">
     <li class="active">cable_input.F90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    <div id="sidebar">
  <h3>Contents</h3>
 
<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      <a class="list-group-item" href="../module/cable_input_module.html">cable_input_module</a>
    </div>
  </div>
</div>
<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/cable_input.f90.html#src">cable_input.F90</a>
  </div>
</div>

</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 6.0.2 (20221011.1828)
 -->
<!-- Title: sourcefile~~cable_input.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilecable_inputf90EfferentGraph" width="641pt" height="535pt"
 viewBox="0.00 0.00 641.00 534.54" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~cable_input.f90~~EfferentGraph" class="graph" transform="scale(0.572321 0.572321) rotate(0) translate(4 929.98)">
<title>sourcefile~~cable_input.f90~~EfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-929.98 1116,-929.98 1116,4 -4,4"/>
<!-- sourcefile~cable_input.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~cable_input.f90</title>
<polygon fill="none" stroke="black" points="1112,-447.83 1023,-447.83 1023,-423.83 1112,-423.83 1112,-447.83"/>
<text text-anchor="middle" x="1067.5" y="-433.43" font-family="Helvetica,sans-Serif" font-size="10.50">cable_input.F90</text>
</g>
<!-- sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~casa_dimension.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/casa_dimension.f90.html" xlink:title="casa_dimension.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="472,-325.83 360,-325.83 360,-301.83 472,-301.83 472,-325.83"/>
<text text-anchor="middle" x="416" y="-311.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_dimension.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-435.83C860.71,-444.33 892.35,-519.25 848,-578.83 813.99,-624.52 816.97,-658.92 762,-673.83"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M760,-673.83C691.51,-692.42 694.92,-613.2 638,-570.83 585.2,-531.52 558.77,-538.09 514,-489.83 469.94,-442.34 438.77,-371.16 424.96,-335.63"/>
<polygon fill="#ff0000" stroke="#ff0000" points="428.21,-334.32 421.39,-326.21 421.66,-336.8 428.21,-334.32"/>
</g>
<!-- sourcefile~cable_parameters.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~cable_parameters.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/cable_parameters.f90.html" xlink:title="cable_parameters.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="821.5,-487.83 700.5,-487.83 700.5,-463.83 821.5,-463.83 821.5,-487.83"/>
<text text-anchor="middle" x="761" y="-473.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_parameters.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_parameters.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_parameters.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-435.83C892.52,-440.58 845.9,-451.76 811.72,-461.1"/>
<polygon fill="#ff0000" stroke="#ff0000" points="810.67,-457.75 801.97,-463.8 812.55,-464.5 810.67,-457.75"/>
</g>
<!-- sourcefile~popluc.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~popluc.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/popluc.f90.html" xlink:title="POPLUC.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="799.5,-207.83 722.5,-207.83 722.5,-183.83 799.5,-183.83 799.5,-207.83"/>
<text text-anchor="middle" x="761" y="-193.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">POPLUC.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~popluc.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~popluc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-79.83C904.85,-60.84 820.19,-138.19 781.6,-176.05"/>
<polygon fill="#ff0000" stroke="#ff0000" points="778.74,-173.96 774.1,-183.48 783.66,-178.93 778.74,-173.96"/>
</g>
<!-- sourcefile~casa_parm.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~casa_parm.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/casa_parm.f90.html" xlink:title="casa_parm.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="620,-325.83 532,-325.83 532,-301.83 620,-301.83 620,-325.83"/>
<text text-anchor="middle" x="576" y="-311.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_parm.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_parm.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_parm.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-435.83C876.44,-442.4 900,-363.47 848,-336.83 779.16,-301.57 687.46,-302.01 630.34,-306.91"/>
<polygon fill="#ff0000" stroke="#ff0000" points="629.73,-303.45 620.09,-307.87 630.38,-310.42 629.73,-303.45"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1022.73,-433.34C997.45,-432.52 965.09,-432.54 936.5,-435.83"/>
</g>
<!-- sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~cable_define_types.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/cable_define_types.f90.html" xlink:title="cable_define_types.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="318,-325.83 191,-325.83 191,-301.83 318,-301.83 318,-325.83"/>
<text text-anchor="middle" x="254.5" y="-311.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_define_types.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1065.87,-448.21C1062.48,-509.21 1044.49,-777.05 987,-831.83 801.81,-1008.31 617.61,-910.57 417,-751.83"/>
</g>
<!-- sourcefile~cbl_sinbet.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~cbl_sinbet.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/cbl_sinbet.f90.html" xlink:title="cbl_sinbet.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="976.5,-822.83 894.5,-822.83 894.5,-798.83 976.5,-798.83 976.5,-822.83"/>
<text text-anchor="middle" x="935.5" y="-808.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cbl_sinbet.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cbl_sinbet.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cbl_sinbet.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1066.03,-448.08C1063.81,-493.25 1051.52,-653.59 987,-763.83 980.64,-774.7 970.98,-784.58 961.8,-792.44"/>
<polygon fill="#ff0000" stroke="#ff0000" points="959.52,-789.78 953.96,-798.8 963.93,-795.21 959.52,-789.78"/>
</g>
<!-- sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~cable_iovars.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/cable_iovars.f90.html" xlink:title="cable_iovars.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="463,-704.83 369,-704.83 369,-680.83 463,-680.83 463,-704.83"/>
<text text-anchor="middle" x="416" y="-690.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_iovars.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M760,-673.83C681.94,-696.67 649.64,-637.25 577,-673.83"/>
</g>
<!-- sourcefile~cable_initialise.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~cable_initialise.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/cable_initialise.f90.html" xlink:title="cable_initialise.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="987,-604.83 884,-604.83 884,-580.83 987,-580.83 987,-604.83"/>
<text text-anchor="middle" x="935.5" y="-590.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_initialise.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_initialise.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_initialise.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1056.51,-447.89C1034.36,-474.65 980.86,-539.25 953.4,-572.42"/>
<polygon fill="#ff0000" stroke="#ff0000" points="950.38,-570.58 946.7,-580.51 955.77,-575.04 950.38,-570.58"/>
</g>
<!-- sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~cable_common.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/cable_common.f90.html" xlink:title="cable_common.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="308,-227.83 201,-227.83 201,-203.83 308,-203.83 308,-227.83"/>
<text text-anchor="middle" x="254.5" y="-213.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_common.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1066.17,-423.46C1064.17,-360.05 1051.59,-72.27 987,-18.83 952.88,9.4 839.47,8.47 577,-41.83"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M415,-117.83C363.55,-138.94 309.62,-175.61 279.51,-197.61"/>
<polygon fill="#ff0000" stroke="#ff0000" points="277.28,-194.91 271.32,-203.67 281.44,-200.54 277.28,-194.91"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M575,-41.83C497.92,-53.28 489.09,-88.26 417,-117.83"/>
</g>
<!-- sourcefile~casa_inout.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~casa_inout.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/casa_inout.f90.html" xlink:title="casa_inout.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="978.5,-369.83 892.5,-369.83 892.5,-345.83 978.5,-345.83 978.5,-369.83"/>
<text text-anchor="middle" x="935.5" y="-355.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_inout.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_inout.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_inout.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1046.47,-423.81C1024.87,-410.86 990.28,-390.1 965.66,-375.33"/>
<polygon fill="#ff0000" stroke="#ff0000" points="967.14,-372.13 956.76,-369.99 963.54,-378.14 967.14,-372.13"/>
</g>
<!-- sourcefile~cable_abort.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~cable_abort.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/cable_abort.f90.html" xlink:title="cable_abort.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="621.5,-763.83 530.5,-763.83 530.5,-739.83 621.5,-739.83 621.5,-763.83"/>
<text text-anchor="middle" x="576" y="-749.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_abort.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_abort.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_abort.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1065.67,-448.09C1061.71,-496.03 1040.34,-671.95 936.5,-749.83"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-749.83C910.96,-767.49 726.11,-760.08 631.87,-755.06"/>
<polygon fill="#ff0000" stroke="#ff0000" points="631.84,-751.55 621.66,-754.5 631.46,-758.54 631.84,-751.55"/>
</g>
<!-- sourcefile~casa_variable.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node13" class="node">
<title>sourcefile~casa_variable.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node13"><a xlink:href=".././sourcefile/casa_variable.f90.html" xlink:title="casa_variable.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="626,-405.83 526,-405.83 526,-381.83 626,-381.83 626,-405.83"/>
<text text-anchor="middle" x="576" y="-391.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_variable.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_variable.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_variable.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M760,-435.83C712.4,-433.14 659.46,-419.81 622.82,-408.89"/>
<polygon fill="#ff0000" stroke="#ff0000" points="623.52,-405.44 612.93,-405.88 621.48,-412.14 623.52,-405.44"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-435.83C858.32,-444.45 838.54,-440.16 762,-435.83"/>
</g>
<!-- sourcefile~casa_phenvar.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node14" class="node">
<title>sourcefile~casa_phenvar.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node14"><a xlink:href=".././sourcefile/casa_phenvar.f90.html" xlink:title="casa_phenvar.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="626.5,-447.83 525.5,-447.83 525.5,-423.83 626.5,-423.83 626.5,-447.83"/>
<text text-anchor="middle" x="576" y="-433.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_phenvar.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_phenvar.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_phenvar.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M760,-435.83C719,-433.51 672.76,-433.53 637.02,-434.13"/>
<polygon fill="#ff0000" stroke="#ff0000" points="636.69,-430.63 626.75,-434.32 636.81,-437.63 636.69,-430.63"/>
</g>
<!-- sourcefile~cable_read.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node15" class="node">
<title>sourcefile~cable_read.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node15"><a xlink:href=".././sourcefile/cable_read.f90.html" xlink:title="cable_read.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="805,-801.83 717,-801.83 717,-777.83 805,-777.83 805,-801.83"/>
<text text-anchor="middle" x="761" y="-787.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_read.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_read.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_read.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-749.83C900.1,-775.63 851.81,-785.18 815.06,-788.53"/>
<polygon fill="#ff0000" stroke="#ff0000" points="814.72,-785.05 805.03,-789.32 815.27,-792.03 814.72,-785.05"/>
</g>
<!-- sourcefile~casa_ncdf.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node16" class="node">
<title>sourcefile~casa_ncdf.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node16"><a xlink:href=".././sourcefile/casa_ncdf.f90.html" xlink:title="casa_ncdf.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="457.5,-207.83 374.5,-207.83 374.5,-183.83 457.5,-183.83 457.5,-207.83"/>
<text text-anchor="middle" x="416" y="-193.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_ncdf.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_ncdf.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~casa_ncdf.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1066.89,-423.66C1067.84,-370 1063.51,-153.96 936.5,-79.83"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-79.83C852.92,-32.22 600.8,-104.58 514,-141.83 489.8,-152.22 463.8,-166.9 444.81,-178.34"/>
<polygon fill="#ff0000" stroke="#ff0000" points="442.81,-175.46 436.1,-183.65 446.46,-181.43 442.81,-175.46"/>
</g>
<!-- sourcefile~cable_metutils.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node17" class="node">
<title>sourcefile~cable_metutils.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node17"><a xlink:href=".././sourcefile/cable_metutils.f90.html" xlink:title="cable_metutils.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="987,-51.83 884,-51.83 884,-27.83 987,-27.83 987,-51.83"/>
<text text-anchor="middle" x="935.5" y="-37.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_metutils.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_metutils.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_metutils.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M1065.26,-423.45C1059.3,-365.86 1031.94,-124.52 987,-65.83 984.67,-62.79 981.9,-60.08 978.85,-57.66"/>
<polygon fill="#ff0000" stroke="#ff0000" points="980.57,-54.6 970.31,-51.93 976.67,-60.41 980.57,-54.6"/>
</g>
<!-- sourcefile~cable_luc_expt.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node18" class="node">
<title>sourcefile~cable_luc_expt.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node18"><a xlink:href=".././sourcefile/cable_luc_expt.f90.html" xlink:title="cable_LUC_EXPT.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="635,-207.83 517,-207.83 517,-183.83 635,-183.83 635,-207.83"/>
<text text-anchor="middle" x="576" y="-193.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_LUC_EXPT.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_luc_expt.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~cable_input.f90&#45;&gt;sourcefile~cable_luc_expt.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M934.5,-79.83C906.82,-62.1 701.26,-144.14 614.97,-179.88"/>
<polygon fill="#ff0000" stroke="#ff0000" points="613.43,-176.73 605.54,-183.8 616.11,-183.19 613.43,-176.73"/>
</g>
<!-- sourcefile~casa_dimension.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~casa_dimension.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M359.66,-313.83C349.5,-313.83 338.76,-313.83 328.18,-313.83"/>
<polygon fill="#ff0000" stroke="#ff0000" points="328.12,-310.33 318.12,-313.83 328.12,-317.33 328.12,-310.33"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M575,-475.83C547.38,-469.24 536.8,-473.75 514,-456.83 470.52,-424.57 440.14,-366.73 425.99,-335.41"/>
<polygon fill="#ff5900" stroke="#ff5900" points="429.2,-333.99 421.98,-326.23 422.78,-336.8 429.2,-333.99"/>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M700.26,-482.77C664.09,-485.27 617.33,-485.46 577,-475.83"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_parm.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge25" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_parm.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M700.17,-464.92C690.7,-461.26 681.55,-456.36 674,-449.83 645.44,-425.11 659.94,-403.58 638,-372.83 627.26,-357.78 612.39,-343.3 600.02,-332.46"/>
<polygon fill="#ff5900" stroke="#ff5900" points="602.2,-329.72 592.32,-325.89 597.65,-335.04 602.2,-329.72"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M730.13,-487.88C656.82,-516.6 470.12,-584.36 417,-551.83"/>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M415,-551.83C328.93,-501.65 279.9,-384.29 262.64,-335.6"/>
<polygon fill="#ff5900" stroke="#ff5900" points="265.92,-334.36 259.35,-326.05 259.3,-336.64 265.92,-334.36"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M755.18,-487.9C741.72,-520.07 700.57,-608.51 638,-654.83 615.18,-671.73 602.66,-661.66 577,-673.83"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge22" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M575,-475.83C461.67,-448.78 438.02,-415.55 354,-334.83 345.03,-326.22 297.38,-267.65 271.78,-236.01"/>
<polygon fill="#ff5900" stroke="#ff5900" points="274.5,-233.81 265.5,-228.23 269.06,-238.21 274.5,-233.81"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_abort.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge26" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_abort.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M754.32,-488.06C731.57,-537 647.67,-716.64 638,-725.83 634.43,-729.22 630.36,-732.2 626.04,-734.82"/>
<polygon fill="#ff5900" stroke="#ff5900" points="624.09,-731.89 616.93,-739.69 627.4,-738.06 624.09,-731.89"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_variable.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge28" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_variable.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M706.03,-463.83C695.02,-460.21 683.81,-455.61 674,-449.83 654.77,-438.5 657.01,-426.52 638,-414.83 635.19,-413.1 632.21,-411.49 629.15,-409.99"/>
<polygon fill="#ff5900" stroke="#ff5900" points="630.33,-406.69 619.77,-405.85 627.5,-413.09 630.33,-406.69"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_phenvar.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge27" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~casa_phenvar.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M705.09,-463.83C683.46,-459.1 658.55,-453.66 636.49,-448.83"/>
<polygon fill="#ff5900" stroke="#ff5900" points="637.09,-445.38 626.57,-446.67 635.59,-452.22 637.09,-445.38"/>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_luc_expt.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge29" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_luc_expt.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M700.45,-467.12C690.48,-463.25 681.09,-457.72 674,-449.83 616.54,-385.91 677.26,-336.29 638,-259.83 629,-242.3 613.69,-226.26 600.66,-214.62"/>
<polygon fill="#ff5900" stroke="#ff5900" points="602.78,-211.84 592.92,-207.97 598.22,-217.14 602.78,-211.84"/>
</g>
<!-- sourcefile~cable_pft_params.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node19" class="node">
<title>sourcefile~cable_pft_params.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node19"><a xlink:href=".././sourcefile/cable_pft_params.f90.html" xlink:title="cable_pft_params.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="636,-645.83 516,-645.83 516,-621.83 636,-621.83 636,-645.83"/>
<text text-anchor="middle" x="576" y="-631.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_pft_params.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_pft_params.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge23" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_pft_params.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M752.39,-487.96C735.21,-514.41 690.76,-577.71 638,-612.83 635.47,-614.51 632.79,-616.08 630.03,-617.53"/>
<polygon fill="#ff5900" stroke="#ff5900" points="628.53,-614.36 620.96,-621.77 631.5,-620.7 628.53,-614.36"/>
</g>
<!-- sourcefile~cable_soil_params.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node21" class="node">
<title>sourcefile~cable_soil_params.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node21"><a xlink:href=".././sourcefile/cable_soil_params.f90.html" xlink:title="cable_soil_params.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="638,-603.83 514,-603.83 514,-579.83 638,-579.83 638,-603.83"/>
<text text-anchor="middle" x="576" y="-589.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_soil_params.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_soil_params.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge24" class="edge">
<title>sourcefile~cable_parameters.f90&#45;&gt;sourcefile~cable_soil_params.f90</title>
<path fill="none" stroke="#ff5900" stroke-dasharray="5,2" d="M745.74,-488.09C723.71,-506.6 679.59,-542.06 638,-565.83 631.89,-569.32 625.22,-572.63 618.6,-575.64"/>
<polygon fill="#ff5900" stroke="#ff5900" points="616.78,-572.62 609.02,-579.83 619.59,-579.03 616.78,-572.62"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~casa_parm.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge33" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~casa_parm.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M741.11,-208.01C708.56,-229 641.8,-272.05 604.23,-296.27"/>
<polygon fill="#ffb300" stroke="#ffb300" points="602.3,-293.35 595.79,-301.71 606.09,-299.24 602.3,-293.35"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge32" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M415,-273.83C375.06,-276.94 330.99,-288.66 299.31,-298.61"/>
<polygon fill="#ffb300" stroke="#ffb300" points="297.93,-295.38 289.48,-301.77 300.07,-302.05 297.93,-295.38"/>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M722.43,-205.83C646.46,-225.82 476.74,-269.18 417,-273.83"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge30" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M733.37,-208C713.39,-218.65 687.29,-236.13 674,-259.83 630.9,-336.72 693.41,-586.29 638,-654.83 620.15,-676.91 602.66,-661.66 577,-673.83"/>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M575,-673.83C543.49,-688.78 504.64,-693.6 473.35,-694.65"/>
<polygon fill="#ffb300" stroke="#ffb300" points="472.97,-691.16 463.05,-694.88 473.12,-698.16 472.97,-691.16"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge31" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M741.12,-183.78C688.24,-151.64 534.8,-69.51 417,-117.83"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~casa_variable.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge34" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~casa_variable.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M738.23,-207.9C719.29,-219.29 692.11,-237.86 674,-259.83 650.49,-288.36 659.63,-304.84 638,-334.83 627.18,-349.83 612.31,-364.3 599.96,-375.16"/>
<polygon fill="#ffb300" stroke="#ffb300" points="597.59,-372.58 592.27,-381.74 602.15,-377.9 597.59,-372.58"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~casa_ncdf.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge36" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~casa_ncdf.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M722.44,-185.01C677.5,-172.52 604.82,-153.92 577,-155.83"/>
</g>
<!-- sourcefile~popluc.f90&#45;&gt;sourcefile~cable_luc_expt.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge35" class="edge">
<title>sourcefile~popluc.f90&#45;&gt;sourcefile~cable_luc_expt.f90</title>
<path fill="none" stroke="#ffb300" stroke-dasharray="5,2" d="M722.08,-195.83C699.9,-195.83 671.23,-195.83 645.25,-195.83"/>
<polygon fill="#ffb300" stroke="#ffb300" points="645.06,-192.33 635.06,-195.83 645.06,-199.33 645.06,-192.33"/>
</g>
<!-- sourcefile~casa_parm.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge37" class="edge">
<title>sourcefile~casa_parm.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#f0ff00" stroke-dasharray="5,2" d="M531.83,-313.83C516.54,-313.83 498.99,-313.83 482.28,-313.83"/>
<polygon fill="#f0ff00" stroke="#f0ff00" points="482.01,-310.33 472.01,-313.83 482.01,-317.33 482.01,-310.33"/>
</g>
<!-- sourcefile~cable_maths_constants_mod.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node22" class="node">
<title>sourcefile~cable_maths_constants_mod.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node22"><a xlink:href=".././sourcefile/cable_maths_constants_mod.f90.html" xlink:title="cable_maths_constants_mod.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="848,-843.83 674,-843.83 674,-819.83 848,-819.83 848,-843.83"/>
<text text-anchor="middle" x="761" y="-829.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_maths_constants_mod.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cbl_sinbet.f90&#45;&gt;sourcefile~cable_maths_constants_mod.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge38" class="edge">
<title>sourcefile~cbl_sinbet.f90&#45;&gt;sourcefile~cable_maths_constants_mod.f90</title>
<path fill="none" stroke="#3cff00" stroke-dasharray="5,2" d="M894.49,-815.7C883.5,-817.04 871.08,-818.55 858.36,-820.1"/>
<polygon fill="#3cff00" stroke="#3cff00" points="857.63,-816.66 848.12,-821.35 858.47,-823.61 857.63,-816.66"/>
</g>
<!-- sourcefile~cable_iovars.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge39" class="edge">
<title>sourcefile~cable_iovars.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#00ff1e" stroke-dasharray="5,2" d="M391.75,-680.68C378.91,-672.88 363.66,-661.63 354,-647.83 282.79,-546.17 262.45,-392.74 257.18,-335.97"/>
<polygon fill="#00ff1e" stroke="#00ff1e" points="260.66,-335.61 256.32,-325.95 253.69,-336.21 260.66,-335.61"/>
</g>
<!-- sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge42" class="edge">
<title>sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M415,-751.83C389.95,-732.01 372.75,-739.69 354,-713.83 265.86,-592.32 256.04,-401.16 255.36,-336.25"/>
<polygon fill="#00ff78" stroke="#00ff78" points="258.86,-335.96 255.32,-325.97 251.86,-335.98 258.86,-335.96"/>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M575,-711.83C556.9,-712.42 431.2,-763.07 417,-751.83"/>
</g>
<!-- sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge40" class="edge">
<title>sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M760,-711.83C683.68,-739.96 658.29,-709.17 577,-711.83"/>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M926.78,-605.05C913.3,-625.35 883.51,-665.95 848,-687.83 814.21,-708.65 799.23,-698.11 762,-711.83"/>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M575,-711.83C541.01,-712.95 503.18,-708.6 473.06,-703.78"/>
<polygon fill="#00ff78" stroke="#00ff78" points="473.6,-700.32 463.16,-702.13 472.45,-707.23 473.6,-700.32"/>
</g>
<!-- sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge41" class="edge">
<title>sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M929.14,-580.47C918.76,-556.02 895.88,-499.51 884,-449.83 855.32,-329.95 919.86,-274.98 848,-174.83 838.22,-161.2 593.44,-38.5 577,-41.83"/>
</g>
<!-- sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_abort.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge43" class="edge">
<title>sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_abort.f90</title>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M760,-711.83C718.16,-727.25 668.65,-737.63 631.68,-743.94"/>
<polygon fill="#00ff78" stroke="#00ff78" points="630.89,-740.52 621.6,-745.61 632.04,-747.43 630.89,-740.52"/>
</g>
<!-- sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_read.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge44" class="edge">
<title>sourcefile~cable_initialise.f90&#45;&gt;sourcefile~cable_read.f90</title>
<path fill="none" stroke="#00ff78" stroke-dasharray="5,2" d="M928.56,-604.84C916.03,-629.42 884.95,-686.47 848,-725.83 831.19,-743.74 808.85,-760.2 791.15,-771.94"/>
<polygon fill="#00ff78" stroke="#00ff78" points="788.86,-769.25 782.38,-777.63 792.67,-775.12 788.86,-769.25"/>
</g>
<!-- sourcefile~cable_runtime_opts_mod.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node23" class="node">
<title>sourcefile~cable_runtime_opts_mod.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node23"><a xlink:href=".././sourcefile/cable_runtime_opts_mod.f90.html" xlink:title="cable_runtime_opts_mod.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="155,-227.83 0,-227.83 0,-203.83 155,-203.83 155,-227.83"/>
<text text-anchor="middle" x="77.5" y="-213.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_runtime_opts_mod.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_common.f90&#45;&gt;sourcefile~cable_runtime_opts_mod.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge45" class="edge">
<title>sourcefile~cable_common.f90&#45;&gt;sourcefile~cable_runtime_opts_mod.f90</title>
<path fill="none" stroke="#00ffd1" stroke-dasharray="5,2" d="M200.99,-215.83C189.75,-215.83 177.58,-215.83 165.42,-215.83"/>
<polygon fill="#00ffd1" stroke="#00ffd1" points="165.23,-212.33 155.23,-215.83 165.23,-219.33 165.23,-212.33"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge46" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M575,-273.83C534.99,-276.32 490.88,-288.31 459.45,-298.51"/>
<polygon fill="#00d1ff" stroke="#00d1ff" points="458.1,-295.27 449.72,-301.75 460.31,-301.92 458.1,-295.27"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_parm.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge47" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_parm.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M760,-273.83C708.22,-264.92 648.91,-283.19 612.2,-297.88"/>
<polygon fill="#00d1ff" stroke="#00d1ff" points="610.83,-294.66 602.92,-301.71 613.5,-301.13 610.83,-294.66"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge48" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M919.03,-345.71C902.31,-333.08 874.48,-313.41 848,-300.83 811.81,-283.64 801.48,-280.63 762,-273.83"/>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M760,-273.83C679.85,-260.03 658.18,-268.78 577,-273.83"/>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M575,-273.83C504.91,-278.19 487.05,-268.88 417,-273.83"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge50" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M923.58,-369.98C912.72,-382.42 895.99,-402.62 884,-421.83 864.43,-453.2 871.44,-468.24 848,-496.83 773.95,-587.16 741.95,-601.57 638,-654.83 612.73,-667.78 602.66,-661.66 577,-673.83"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge49" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M934.29,-345.82C932.89,-305.09 922.56,-171.06 848,-103.83 756.24,-21.09 697.53,-14.66 577,-41.83"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_variable.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge52" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_variable.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M892.29,-369.35C857.56,-378.4 806.93,-390.65 762,-397.83"/>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M760,-397.83C719.16,-404.36 672.54,-403.22 636.58,-400.51"/>
<polygon fill="#00d1ff" stroke="#00d1ff" points="636.51,-397 626.26,-399.67 635.94,-403.97 636.51,-397"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_phenvar.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge53" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_phenvar.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M760,-397.83C718.56,-404.45 672.28,-414.09 636.63,-421.99"/>
<polygon fill="#00d1ff" stroke="#00d1ff" points="635.86,-418.58 626.87,-424.17 637.39,-425.41 635.86,-418.58"/>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_ncdf.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge54" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_ncdf.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M932.95,-345.78C927.92,-312.02 908.63,-216.28 848,-174.83 748.32,-106.69 697.46,-147.55 577,-155.83"/>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M575,-155.83C535.14,-158.57 491.17,-170.46 459.76,-180.57"/>
<polygon fill="#00d1ff" stroke="#00d1ff" points="458.43,-177.32 450.03,-183.78 460.62,-183.97 458.43,-177.32"/>
</g>
<!-- sourcefile~casa_cnp.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node20" class="node">
<title>sourcefile~casa_cnp.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node20"><a xlink:href=".././sourcefile/casa_cnp.f90.html" xlink:title="casa_cnp.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="801,-369.83 721,-369.83 721,-345.83 801,-345.83 801,-369.83"/>
<text text-anchor="middle" x="761" y="-355.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">casa_cnp.F90</text>
</a>
</g>
</g>
<!-- sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_cnp.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge51" class="edge">
<title>sourcefile~casa_inout.f90&#45;&gt;sourcefile~casa_cnp.f90</title>
<path fill="none" stroke="#00d1ff" stroke-dasharray="5,2" d="M892.3,-357.83C867.84,-357.83 836.92,-357.83 811.34,-357.83"/>
<polygon fill="#00d1ff" stroke="#00d1ff" points="811.11,-354.33 801.11,-357.83 811.1,-361.33 811.11,-354.33"/>
</g>
<!-- sourcefile~cable_abort.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge55" class="edge">
<title>sourcefile~cable_abort.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#0078ff" stroke-dasharray="5,2" d="M537.21,-763.9C502.22,-772.54 450.66,-778.47 417,-751.83"/>
</g>
<!-- sourcefile~cable_abort.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge56" class="edge">
<title>sourcefile~cable_abort.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#0078ff" stroke-dasharray="5,2" d="M542.65,-739.75C518.47,-730.72 485.21,-718.3 458.99,-708.51"/>
<polygon fill="#0078ff" stroke="#0078ff" points="459.9,-705.12 449.31,-704.9 457.46,-711.67 459.9,-705.12"/>
</g>
<!-- sourcefile~casa_variable.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge57" class="edge">
<title>sourcefile~casa_variable.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#001dff" stroke-dasharray="5,2" d="M544.93,-381.75C534.98,-377.56 523.93,-372.69 514,-367.83 490.65,-356.39 464.97,-342.01 445.9,-330.97"/>
<polygon fill="#001dff" stroke="#001dff" points="447.51,-327.86 437.11,-325.84 443.98,-333.9 447.51,-327.86"/>
</g>
<!-- sourcefile~casa_phenvar.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge58" class="edge">
<title>sourcefile~casa_phenvar.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#3c00ff" stroke-dasharray="5,2" d="M531.48,-423.72C525.39,-421.22 519.38,-418.27 514,-414.83 479.82,-392.99 448.99,-356.72 431.66,-334.1"/>
<polygon fill="#3c00ff" stroke="#3c00ff" points="434.3,-331.78 425.5,-325.88 428.7,-335.98 434.3,-331.78"/>
</g>
<!-- sourcefile~cable_read.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge61" class="edge">
<title>sourcefile~cable_read.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#9500ff" stroke-dasharray="5,2" d="M575,-791.83C504,-777.48 473.8,-796.78 417,-751.83"/>
</g>
<!-- sourcefile~cable_read.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge60" class="edge">
<title>sourcefile~cable_read.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#9500ff" stroke-dasharray="5,2" d="M716.63,-795.36C679.24,-798.93 624.03,-801.34 577,-791.83"/>
<path fill="none" stroke="#9500ff" stroke-dasharray="5,2" d="M575,-791.83C547.17,-786.2 538.4,-787.35 514,-772.83 494.82,-761.42 495.02,-752.27 478,-737.83 466.91,-728.43 454.04,-718.76 442.98,-710.81"/>
<polygon fill="#9500ff" stroke="#9500ff" points="444.75,-707.77 434.57,-704.84 440.7,-713.48 444.75,-707.77"/>
</g>
<!-- sourcefile~cable_read.f90&#45;&gt;sourcefile~cable_abort.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge59" class="edge">
<title>sourcefile~cable_read.f90&#45;&gt;sourcefile~cable_abort.f90</title>
<path fill="none" stroke="#9500ff" stroke-dasharray="5,2" d="M716.63,-780.83C691.23,-775.55 658.92,-768.84 631.77,-763.2"/>
<polygon fill="#9500ff" stroke="#9500ff" points="632.15,-759.71 621.65,-761.1 630.73,-766.56 632.15,-759.71"/>
</g>
<!-- sourcefile~casa_ncdf.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge63" class="edge">
<title>sourcefile~casa_ncdf.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#f000ff" stroke-dasharray="5,2" d="M381,-207.85C371.9,-211.72 362.3,-216.43 354,-221.83 322.29,-242.48 291.33,-273.75 272.84,-293.99"/>
<polygon fill="#f000ff" stroke="#f000ff" points="270.01,-291.89 265.93,-301.67 275.22,-296.57 270.01,-291.89"/>
</g>
<!-- sourcefile~casa_ncdf.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge62" class="edge">
<title>sourcefile~casa_ncdf.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#f000ff" stroke-dasharray="5,2" d="M374.34,-200.93C357.28,-203.07 337.06,-205.6 318.17,-207.97"/>
<polygon fill="#f000ff" stroke="#f000ff" points="317.64,-204.51 308.15,-209.23 318.51,-211.46 317.64,-204.51"/>
</g>
<!-- sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge67" class="edge">
<title>sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#ff005a" stroke-dasharray="5,2" d="M415,-235.83C364.74,-246.61 312.29,-276.44 281.82,-295.93"/>
<polygon fill="#ff005a" stroke="#ff005a" points="279.56,-293.22 273.09,-301.62 283.38,-299.09 279.56,-293.22"/>
</g>
<!-- sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~cable_iovars.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge65" class="edge">
<title>sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~cable_iovars.f90</title>
<path fill="none" stroke="#ff005a" stroke-dasharray="5,2" d="M558.37,-207.99C543.95,-219.56 523.88,-238.36 514,-259.83 447.88,-403.49 536.58,-466.93 478,-613.83 468.9,-636.65 451.18,-658.42 437.17,-673.3"/>
<polygon fill="#ff005a" stroke="#ff005a" points="434.31,-671.22 429.85,-680.83 439.33,-676.1 434.31,-671.22"/>
</g>
<!-- sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~cable_common.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge66" class="edge">
<title>sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~cable_common.f90</title>
<path fill="none" stroke="#ff005a" stroke-dasharray="5,2" d="M415,-235.83C378.19,-243.73 335.88,-237.75 304.1,-230.32"/>
<polygon fill="#ff005a" stroke="#ff005a" points="304.71,-226.87 294.17,-227.88 303.04,-233.67 304.71,-226.87"/>
<path fill="none" stroke="#ff005a" stroke-dasharray="5,2" d="M530.94,-207.91C499.36,-216.34 455.73,-227.52 417,-235.83"/>
</g>
<!-- sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~casa_ncdf.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge64" class="edge">
<title>sourcefile~cable_luc_expt.f90&#45;&gt;sourcefile~casa_ncdf.f90</title>
<path fill="none" stroke="#ff005a" stroke-dasharray="5,2" d="M516.62,-195.83C500.76,-195.83 483.71,-195.83 468.28,-195.83"/>
<polygon fill="#ff005a" stroke="#ff005a" points="467.89,-192.33 457.89,-195.83 467.89,-199.33 467.89,-192.33"/>
</g>
<!-- sourcefile~cable_pft_params.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge69" class="edge">
<title>sourcefile~cable_pft_params.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M515.97,-644.89C467.33,-650.49 399.23,-649.8 354,-613.83 265.91,-543.77 255.76,-393.13 255.2,-336.22"/>
<polygon fill="#ff0000" stroke="#ff0000" points="258.7,-336.13 255.19,-326.14 251.7,-336.14 258.7,-336.13"/>
</g>
<!-- sourcefile~grid_constants_cbl.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_node24" class="node">
<title>sourcefile~grid_constants_cbl.f90</title>
<g id="a_sourcefile~~cable_input.f90~~EfferentGraph_node24"><a xlink:href=".././sourcefile/grid_constants_cbl.f90.html" xlink:title="grid_constants_cbl.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="478,-604.83 354,-604.83 354,-580.83 478,-580.83 478,-604.83"/>
<text text-anchor="middle" x="416" y="-590.43" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">grid_constants_cbl.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_pft_params.f90&#45;&gt;sourcefile~grid_constants_cbl.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge68" class="edge">
<title>sourcefile~cable_pft_params.f90&#45;&gt;sourcefile~grid_constants_cbl.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M528.45,-621.75C511.17,-617.27 491.38,-612.13 473.32,-607.45"/>
<polygon fill="#ff0000" stroke="#ff0000" points="474.05,-604.02 463.49,-604.9 472.29,-610.79 474.05,-604.02"/>
</g>
<!-- sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_dimension.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge71" class="edge">
<title>sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_dimension.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M575,-353.83C539.3,-346.96 499.64,-336.91 468.98,-328.6"/>
<polygon fill="#cbff00" stroke="#cbff00" points="469.52,-325.12 458.95,-325.86 467.67,-331.87 469.52,-325.12"/>
</g>
<!-- sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_parm.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge72" class="edge">
<title>sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_parm.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M720.74,-348.39C694.25,-342.02 658.97,-333.54 629.99,-326.57"/>
<polygon fill="#cbff00" stroke="#cbff00" points="630.57,-323.11 620.03,-324.18 628.93,-329.92 630.57,-323.11"/>
</g>
<!-- sourcefile~casa_cnp.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge70" class="edge">
<title>sourcefile~casa_cnp.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M720.69,-360.75C683.35,-362.63 625.84,-363.23 577,-353.83"/>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M575,-353.83C547.12,-348.46 537.72,-350.44 514,-334.83 493.46,-321.32 498.54,-306.35 478,-292.83 454.28,-277.22 445.31,-271.63 417,-273.83"/>
</g>
<!-- sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_variable.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge74" class="edge">
<title>sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_variable.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M720.74,-365.55C696.14,-370.39 663.97,-376.72 636.29,-382.17"/>
<polygon fill="#cbff00" stroke="#cbff00" points="635.46,-378.76 626.33,-384.13 636.81,-385.63 635.46,-378.76"/>
</g>
<!-- sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_phenvar.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge73" class="edge">
<title>sourcefile~casa_cnp.f90&#45;&gt;sourcefile~casa_phenvar.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M720.95,-365.95C705.73,-370.05 688.49,-375.87 674,-383.83 655.49,-394 656.31,-404.32 638,-414.83 634.94,-416.59 631.72,-418.23 628.41,-419.75"/>
<polygon fill="#cbff00" stroke="#cbff00" points="626.79,-416.64 618.95,-423.76 629.52,-423.09 626.79,-416.64"/>
</g>
<!-- sourcefile~cable_soil_params.f90&#45;&gt;sourcefile~cable_define_types.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge76" class="edge">
<title>sourcefile~cable_soil_params.f90&#45;&gt;sourcefile~cable_define_types.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M520.82,-579.79C478.74,-570.15 426.05,-557.37 417,-551.83"/>
</g>
<!-- sourcefile~cable_soil_params.f90&#45;&gt;sourcefile~grid_constants_cbl.f90 -->
<g id="sourcefile~~cable_input.f90~~EfferentGraph_edge75" class="edge">
<title>sourcefile~cable_soil_params.f90&#45;&gt;sourcefile~grid_constants_cbl.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M513.91,-592.22C505.49,-592.27 496.77,-592.33 488.19,-592.38"/>
<polygon fill="#00ff66" stroke="#00ff66" points="488.16,-588.88 478.18,-592.44 488.21,-595.88 488.16,-588.88"/>
</g>
</g>
</svg>
</div><script>var pansourcefilecable_inputf90EfferentGraph = svgPanZoom('#sourcefilecable_inputf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 6.0.2 (20221011.1828)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 6.0.2 (20221011.1828)
 -->
<!-- Title: sourcefile~~cable_input.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilecable_inputf90AfferentGraph" width="381pt" height="116pt"
 viewBox="0.00 0.00 381.00 116.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~cable_input.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<title>sourcefile~~cable_input.f90~~AfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-112 377,-112 377,4 -4,4"/>
<!-- sourcefile~cable_input.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~cable_input.f90</title>
<polygon fill="none" stroke="black" points="89,-66 0,-66 0,-42 89,-42 89,-66"/>
<text text-anchor="middle" x="44.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50">cable_input.F90</text>
</g>
<!-- sourcefile~cable_mpimaster.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~cable_mpimaster.f90</title>
<g id="a_sourcefile~~cable_input.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/cable_mpimaster.f90.html" xlink:title="cable_mpimaster.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="240,-108 125,-108 125,-84 240,-84 240,-108"/>
<text text-anchor="middle" x="182.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_mpimaster.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_mpimaster.f90&#45;&gt;sourcefile~cable_input.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~cable_mpimaster.f90&#45;&gt;sourcefile~cable_input.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M142.53,-83.96C127.45,-79.31 110.02,-73.93 94.14,-69.02"/>
<polygon fill="#ff0000" stroke="#ff0000" points="95.07,-65.64 84.48,-66.04 93,-72.33 95.07,-65.64"/>
</g>
<!-- sourcefile~cable_driver.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~cable_driver.f90</title>
<g id="a_sourcefile~~cable_input.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/cable_driver.f90.html" xlink:title="cable_driver.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="228.5,-24 136.5,-24 136.5,0 228.5,0 228.5,-24"/>
<text text-anchor="middle" x="182.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_driver.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_driver.f90&#45;&gt;sourcefile~cable_input.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~cable_driver.f90&#45;&gt;sourcefile~cable_input.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M142.53,-24.04C127.45,-28.69 110.02,-34.07 94.14,-38.98"/>
<polygon fill="#ff0000" stroke="#ff0000" points="93,-35.67 84.48,-41.96 95.07,-42.36 93,-35.67"/>
</g>
<!-- sourcefile~cable_mpiworker.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~cable_mpiworker.f90</title>
<g id="a_sourcefile~~cable_input.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/cable_mpiworker.f90.html" xlink:title="cable_mpiworker.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="240,-66 125,-66 125,-42 240,-42 240,-66"/>
<text text-anchor="middle" x="182.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_mpiworker.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_mpiworker.f90&#45;&gt;sourcefile~cable_input.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~cable_mpiworker.f90&#45;&gt;sourcefile~cable_input.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M124.61,-54C116.32,-54 107.8,-54 99.57,-54"/>
<polygon fill="#ff0000" stroke="#ff0000" points="99.33,-50.5 89.33,-54 99.33,-57.5 99.33,-50.5"/>
</g>
<!-- sourcefile~cable_mpidrv.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_node5" class="node">
<title>sourcefile~cable_mpidrv.f90</title>
<g id="a_sourcefile~~cable_input.f90~~AfferentGraph_node5"><a xlink:href=".././sourcefile/cable_mpidrv.f90.html" xlink:title="cable_mpidrv.F90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="373,-87 276,-87 276,-63 373,-63 373,-87"/>
<text text-anchor="middle" x="324.5" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">cable_mpidrv.F90</text>
</a>
</g>
</g>
<!-- sourcefile~cable_mpidrv.f90&#45;&gt;sourcefile~cable_mpimaster.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~cable_mpidrv.f90&#45;&gt;sourcefile~cable_mpimaster.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M275.71,-82.17C267.51,-83.4 258.86,-84.7 250.27,-85.98"/>
<polygon fill="#ff0000" stroke="#ff0000" points="249.62,-82.54 240.25,-87.49 250.66,-89.46 249.62,-82.54"/>
</g>
<!-- sourcefile~cable_mpidrv.f90&#45;&gt;sourcefile~cable_mpiworker.f90 -->
<g id="sourcefile~~cable_input.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~cable_mpidrv.f90&#45;&gt;sourcefile~cable_mpiworker.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M275.71,-67.83C267.51,-66.6 258.86,-65.3 250.27,-64.02"/>
<polygon fill="#0000ff" stroke="#0000ff" points="250.66,-60.54 240.25,-62.51 249.62,-67.46 250.66,-60.54"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 6.0.2 (20221011.1828)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
<br>
    <section class="visible-xs visible-sm hidden-md">
      <h3>Contents</h3>
 
<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      <a class="list-group-item" href="../module/cable_input_module.html">cable_input_module</a>
    </div>
  </div>
</div>
<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/cable_input.f90.html#src">cable_input.F90</a>
  </div>
</div>

    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a id="ln-1" name="ln-1" href="#ln-1"></a><span class="c">!==============================================================================</span>
<a id="ln-2" name="ln-2" href="#ln-2"></a><span class="c">! This source code is part of the</span>
<a id="ln-3" name="ln-3" href="#ln-3"></a><span class="c">! Australian Community Atmosphere Biosphere Land Exchange (CABLE) model.</span>
<a id="ln-4" name="ln-4" href="#ln-4"></a><span class="c">! This work is licensed under the CSIRO Open Source Software License</span>
<a id="ln-5" name="ln-5" href="#ln-5"></a><span class="c">! Agreement (variation of the BSD / MIT License).</span>
<a id="ln-6" name="ln-6" href="#ln-6"></a><span class="c">!</span>
<a id="ln-7" name="ln-7" href="#ln-7"></a><span class="c">! You may not use this file except in compliance with this License.</span>
<a id="ln-8" name="ln-8" href="#ln-8"></a><span class="c">! A copy of the License (CSIRO_BSD_MIT_License_v2.0_CABLE.txt) is located</span>
<a id="ln-9" name="ln-9" href="#ln-9"></a><span class="c">! in each directory containing CABLE code.</span>
<a id="ln-10" name="ln-10" href="#ln-10"></a><span class="c">!</span>
<a id="ln-11" name="ln-11" href="#ln-11"></a><span class="c">! ==============================================================================</span>
<a id="ln-12" name="ln-12" href="#ln-12"></a><span class="c">! Purpose: Input module for CABLE offline version</span>
<a id="ln-13" name="ln-13" href="#ln-13"></a><span class="c">!</span>
<a id="ln-14" name="ln-14" href="#ln-14"></a><span class="c">! Contact: Bernard.Pak@csiro.au</span>
<a id="ln-15" name="ln-15" href="#ln-15"></a><span class="c">!</span>
<a id="ln-16" name="ln-16" href="#ln-16"></a><span class="c">! History: Developed by Gab Abramowitz</span>
<a id="ln-17" name="ln-17" href="#ln-17"></a><span class="c">!          Rewritten for v2.0 for new input files (1x1 deg instead of CCAM ~2x2 deg)</span>
<a id="ln-18" name="ln-18" href="#ln-18"></a><span class="c">!          LAI and casa-cnp nutrient inputs included in 1x1 deg file</span>
<a id="ln-19" name="ln-19" href="#ln-19"></a><span class="c">!</span>
<a id="ln-20" name="ln-20" href="#ln-20"></a><span class="c">! ==============================================================================</span>
<a id="ln-21" name="ln-21" href="#ln-21"></a><span class="c">!</span>
<a id="ln-22" name="ln-22" href="#ln-22"></a><span class="c">! MODULEs used: cable_abort_module</span>
<a id="ln-23" name="ln-23" href="#ln-23"></a><span class="c">!               cable_def_types_mod</span>
<a id="ln-24" name="ln-24" href="#ln-24"></a><span class="c">!               cable_IO_vars_module</span>
<a id="ln-25" name="ln-25" href="#ln-25"></a><span class="c">!               cable_read_module</span>
<a id="ln-26" name="ln-26" href="#ln-26"></a><span class="c">!               netcdf</span>
<a id="ln-27" name="ln-27" href="#ln-27"></a><span class="c">!               casadimension</span>
<a id="ln-28" name="ln-28" href="#ln-28"></a><span class="c">!               casavariable</span>
<a id="ln-29" name="ln-29" href="#ln-29"></a><span class="c">!               phenvariable</span>
<a id="ln-30" name="ln-30" href="#ln-30"></a><span class="c">!               cable_param_module</span>
<a id="ln-31" name="ln-31" href="#ln-31"></a><span class="c">!               cable_checks_module</span>
<a id="ln-32" name="ln-32" href="#ln-32"></a><span class="c">!               cable_radiation_module</span>
<a id="ln-33" name="ln-33" href="#ln-33"></a><span class="c">!               cable_init_module</span>
<a id="ln-34" name="ln-34" href="#ln-34"></a><span class="c">!</span>
<a id="ln-35" name="ln-35" href="#ln-35"></a><span class="c">!==============================================================================</span>
<a id="ln-36" name="ln-36" href="#ln-36"></a>
<a id="ln-37" name="ln-37" href="#ln-37"></a><span class="k">MODULE </span><span class="n">cable_input_module</span><span class="w"></span>
<a id="ln-38" name="ln-38" href="#ln-38"></a><span class="w">  </span><span class="c">! Note that any precision changes from r_1 to REAL(4) enable running with -r8</span>
<a id="ln-39" name="ln-39" href="#ln-39"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-40" name="ln-40" href="#ln-40"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_abort_module</span><span class="p">,</span><span class="w">      </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="nb">abort</span><span class="p">,</span><span class="w"> </span><span class="n">nc_abort</span><span class="w"></span>
<a id="ln-41" name="ln-41" href="#ln-41"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_def_types_mod</span><span class="w"></span>
<a id="ln-42" name="ln-42" href="#ln-42"></a><span class="w">  </span><span class="k">USE </span><span class="n">casadimension</span><span class="p">,</span><span class="w">     </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">icycle</span><span class="w"></span>
<a id="ln-43" name="ln-43" href="#ln-43"></a><span class="w">  </span><span class="k">USE </span><span class="n">casavariable</span><span class="w"></span>
<a id="ln-44" name="ln-44" href="#ln-44"></a><span class="w">  </span><span class="k">USE </span><span class="n">casaparm</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">forest</span><span class="p">,</span><span class="w"> </span><span class="n">shrub</span><span class="w"></span>
<a id="ln-45" name="ln-45" href="#ln-45"></a><span class="w">  </span><span class="k">USE </span><span class="n">phenvariable</span><span class="w"></span>
<a id="ln-46" name="ln-46" href="#ln-46"></a><span class="w">  </span><span class="c">!! vh_js !!</span>
<a id="ln-47" name="ln-47" href="#ln-47"></a><span class="w">  </span><span class="k">USE </span><span class="n">POP_Types</span><span class="p">,</span><span class="w">               </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">POP_TYPE</span><span class="w"></span>
<a id="ln-48" name="ln-48" href="#ln-48"></a><span class="w">  </span><span class="k">USE </span><span class="n">POPLUC_Types</span><span class="p">,</span><span class="w">               </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">POPLUC_TYPE</span><span class="w"></span>
<a id="ln-49" name="ln-49" href="#ln-49"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_param_module</span><span class="w"></span>
<a id="ln-50" name="ln-50" href="#ln-50"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_checks_module</span><span class="p">,</span><span class="w">     </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">ranges</span><span class="p">,</span><span class="w"> </span><span class="n">rh_sh</span><span class="w"></span>
<a id="ln-51" name="ln-51" href="#ln-51"></a><span class="w">  </span><span class="k">USE </span><span class="n">cbl_sinbet_mod</span><span class="p">,</span><span class="w">  </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">sinbet</span><span class="w"></span>
<a id="ln-52" name="ln-52" href="#ln-52"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_IO_vars_module</span><span class="w"></span>
<a id="ln-53" name="ln-53" href="#ln-53"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_read_module</span><span class="p">,</span><span class="w">       </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">readpar</span><span class="w"></span>
<a id="ln-54" name="ln-54" href="#ln-54"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_init_module</span><span class="w"></span>
<a id="ln-55" name="ln-55" href="#ln-55"></a><span class="w">  </span><span class="k">USE </span><span class="n">netcdf</span><span class="w"> </span><span class="c">! link must be made in cd to netcdf-x.x.x/src/f90/netcdf.mod</span>
<a id="ln-56" name="ln-56" href="#ln-56"></a><span class="w">  </span><span class="k">USE </span><span class="n">cable_common_module</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">cable_user</span><span class="p">,</span><span class="w"> </span><span class="n">CurYear</span><span class="p">,</span><span class="w"> </span><span class="n">is_leapyear</span><span class="w"></span>
<a id="ln-57" name="ln-57" href="#ln-57"></a><span class="w">  </span><span class="k">USE </span><span class="n">casa_ncdf_module</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">HANDLE_ERR</span><span class="w"></span>
<a id="ln-58" name="ln-58" href="#ln-58"></a><span class="w">  </span><span class="k">USE </span><span class="n">casa_inout_module</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">casa_readbiome</span><span class="p">,</span><span class="w"> </span><span class="n">casa_readphen</span><span class="p">,</span><span class="w"> </span><span class="n">casa_init</span><span class="w"></span>
<a id="ln-59" name="ln-59" href="#ln-59"></a>
<a id="ln-60" name="ln-60" href="#ln-60"></a><span class="w">  </span><span class="k">IMPLICIT NONE</span>
<a id="ln-61" name="ln-61" href="#ln-61"></a>
<a id="ln-62" name="ln-62" href="#ln-62"></a><span class="k">  PRIVATE</span>
<a id="ln-63" name="ln-63" href="#ln-63"></a><span class="k">  PUBLIC </span><span class="n">get_default_lai</span><span class="p">,</span><span class="w"> </span><span class="n">open_met_file</span><span class="p">,</span><span class="w"> </span><span class="n">close_met_file</span><span class="p">,</span><span class="n">load_parameters</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-64" name="ln-64" href="#ln-64"></a><span class="w">       </span><span class="n">allocate_cable_vars</span><span class="p">,</span><span class="w"> </span><span class="n">get_met_data</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-65" name="ln-65" href="#ln-65"></a><span class="w">       </span><span class="n">ncid_met</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-66" name="ln-66" href="#ln-66"></a><span class="w">       </span><span class="n">ncid_rain</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-67" name="ln-67" href="#ln-67"></a><span class="w">       </span><span class="n">ncid_snow</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-68" name="ln-68" href="#ln-68"></a><span class="w">       </span><span class="n">ncid_lw</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-69" name="ln-69" href="#ln-69"></a><span class="w">       </span><span class="n">ncid_sw</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-70" name="ln-70" href="#ln-70"></a><span class="w">       </span><span class="n">ncid_ps</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-71" name="ln-71" href="#ln-71"></a><span class="w">       </span><span class="n">ncid_qa</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-72" name="ln-72" href="#ln-72"></a><span class="w">       </span><span class="n">ncid_ta</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-73" name="ln-73" href="#ln-73"></a><span class="w">       </span><span class="n">ncid_wd</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-74" name="ln-74" href="#ln-74"></a><span class="w">       </span><span class="n">ncid_mask</span><span class="w"></span>
<a id="ln-75" name="ln-75" href="#ln-75"></a>
<a id="ln-76" name="ln-76" href="#ln-76"></a><span class="w">  </span><span class="kt">INTEGER</span><span class="w">                      </span><span class="kd">::</span><span class="w">                                        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-77" name="ln-77" href="#ln-77"></a><span class="w">       </span><span class="n">ncid_met</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! met data netcdf file ID</span>
<a id="ln-78" name="ln-78" href="#ln-78"></a><span class="w">       </span><span class="n">ncid_rain</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! following are netcdf file IDs for gswp run</span>
<a id="ln-79" name="ln-79" href="#ln-79"></a><span class="w">       </span><span class="n">ncid_snow</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-80" name="ln-80" href="#ln-80"></a><span class="w">       </span><span class="n">ncid_lw</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-81" name="ln-81" href="#ln-81"></a><span class="w">       </span><span class="n">ncid_sw</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-82" name="ln-82" href="#ln-82"></a><span class="w">       </span><span class="n">ncid_ps</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-83" name="ln-83" href="#ln-83"></a><span class="w">       </span><span class="n">ncid_qa</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-84" name="ln-84" href="#ln-84"></a><span class="w">       </span><span class="n">ncid_ta</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-85" name="ln-85" href="#ln-85"></a><span class="w">       </span><span class="n">ncid_wd</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-86" name="ln-86" href="#ln-86"></a><span class="w">       </span><span class="n">ncid_mask</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-87" name="ln-87" href="#ln-87"></a><span class="w">       </span><span class="n">ok</span><span class="w">                 </span><span class="c">! netcdf error status</span>
<a id="ln-88" name="ln-88" href="#ln-88"></a><span class="w">  </span><span class="c">! - see ALMA compress by gathering</span>
<a id="ln-89" name="ln-89" href="#ln-89"></a><span class="w">  </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">POINTER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">landGrid</span><span class="w"> </span><span class="c">! for ALMA compressed variables</span>
<a id="ln-90" name="ln-90" href="#ln-90"></a><span class="w">  </span><span class="kt">REAL</span><span class="p">,</span><span class="k">POINTER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:)</span><span class="w">    </span><span class="kd">::</span><span class="w">                                        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-91" name="ln-91" href="#ln-91"></a><span class="w">       </span><span class="n">elevation</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! site/grid cell elevation</span>
<a id="ln-92" name="ln-92" href="#ln-92"></a><span class="w">       </span><span class="n">avPrecip</span><span class="w">           </span><span class="c">! site/grid cell average precip</span>
<a id="ln-93" name="ln-93" href="#ln-93"></a><span class="w">  </span><span class="k">TYPE </span><span class="n">met_varID_type</span><span class="w"></span>
<a id="ln-94" name="ln-94" href="#ln-94"></a><span class="w">     </span><span class="kt">INTEGER</span><span class="w">                   </span><span class="kd">::</span><span class="w">                                        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-95" name="ln-95" href="#ln-95"></a><span class="w">          </span><span class="n">SWdown</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-96" name="ln-96" href="#ln-96"></a><span class="w">          </span><span class="n">LWdown</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-97" name="ln-97" href="#ln-97"></a><span class="w">          </span><span class="n">Wind</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-98" name="ln-98" href="#ln-98"></a><span class="w">          </span><span class="n">Wind_E</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-99" name="ln-99" href="#ln-99"></a><span class="w">          </span><span class="n">PSurf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-100" name="ln-100" href="#ln-100"></a><span class="w">          </span><span class="n">Tair</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-101" name="ln-101" href="#ln-101"></a><span class="w">          </span><span class="n">Qair</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-102" name="ln-102" href="#ln-102"></a><span class="w">          </span><span class="n">Rainf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-103" name="ln-103" href="#ln-103"></a><span class="w">          </span><span class="n">Snowf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-104" name="ln-104" href="#ln-104"></a><span class="w">          </span><span class="n">CO2air</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-105" name="ln-105" href="#ln-105"></a><span class="w">          </span><span class="n">Elev</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-106" name="ln-106" href="#ln-106"></a><span class="w">          </span><span class="n">LAI</span><span class="p">,</span><span class="w">          </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-107" name="ln-107" href="#ln-107"></a><span class="w">          </span><span class="n">avPrecip</span><span class="p">,</span><span class="w">     </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-108" name="ln-108" href="#ln-108"></a><span class="w">          </span><span class="n">iveg</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-109" name="ln-109" href="#ln-109"></a><span class="w">          </span><span class="n">isoil</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-110" name="ln-110" href="#ln-110"></a><span class="w">          </span><span class="n">patchfrac</span><span class="w"></span>
<a id="ln-111" name="ln-111" href="#ln-111"></a><span class="w">  </span><span class="k">END TYPE </span><span class="n">met_varID_type</span><span class="w"></span>
<a id="ln-112" name="ln-112" href="#ln-112"></a><span class="w">  </span><span class="k">TYPE</span><span class="p">(</span><span class="n">met_varID_type</span><span class="p">)</span><span class="w">              </span><span class="kd">::</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="c">! netcdf variable IDs for input met variables</span>
<a id="ln-113" name="ln-113" href="#ln-113"></a><span class="w">  </span><span class="k">TYPE </span><span class="n">met_units_type</span><span class="w"></span>
<a id="ln-114" name="ln-114" href="#ln-114"></a><span class="w">     </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span><span class="w">              </span><span class="kd">::</span><span class="w">                                        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-115" name="ln-115" href="#ln-115"></a><span class="w">          </span><span class="n">SWdown</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-116" name="ln-116" href="#ln-116"></a><span class="w">          </span><span class="n">LWdown</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-117" name="ln-117" href="#ln-117"></a><span class="w">          </span><span class="n">Wind</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-118" name="ln-118" href="#ln-118"></a><span class="w">          </span><span class="n">Wind_E</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-119" name="ln-119" href="#ln-119"></a><span class="w">          </span><span class="n">PSurf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-120" name="ln-120" href="#ln-120"></a><span class="w">          </span><span class="n">Tair</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-121" name="ln-121" href="#ln-121"></a><span class="w">          </span><span class="n">Qair</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-122" name="ln-122" href="#ln-122"></a><span class="w">          </span><span class="n">Rainf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-123" name="ln-123" href="#ln-123"></a><span class="w">          </span><span class="n">Snowf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-124" name="ln-124" href="#ln-124"></a><span class="w">          </span><span class="n">CO2air</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-125" name="ln-125" href="#ln-125"></a><span class="w">          </span><span class="n">Elev</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-126" name="ln-126" href="#ln-126"></a><span class="w">          </span><span class="n">avPrecip</span><span class="w"></span>
<a id="ln-127" name="ln-127" href="#ln-127"></a><span class="w">  </span><span class="k">END TYPE </span><span class="n">met_units_type</span><span class="w"></span>
<a id="ln-128" name="ln-128" href="#ln-128"></a><span class="w">  </span><span class="k">TYPE</span><span class="p">(</span><span class="n">met_units_type</span><span class="p">)</span><span class="w">              </span><span class="kd">::</span><span class="w"> </span><span class="n">metunits</span><span class="w"> </span><span class="c">! units for meteorological variables</span>
<a id="ln-129" name="ln-129" href="#ln-129"></a><span class="w">  </span><span class="k">TYPE </span><span class="n">convert_units_type</span><span class="w"></span>
<a id="ln-130" name="ln-130" href="#ln-130"></a><span class="w">     </span><span class="kt">REAL</span><span class="w">                      </span><span class="kd">::</span><span class="w">                                        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-131" name="ln-131" href="#ln-131"></a><span class="w">          </span><span class="n">PSurf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-132" name="ln-132" href="#ln-132"></a><span class="w">          </span><span class="n">Tair</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-133" name="ln-133" href="#ln-133"></a><span class="w">          </span><span class="n">Qair</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-134" name="ln-134" href="#ln-134"></a><span class="w">          </span><span class="n">Rainf</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-135" name="ln-135" href="#ln-135"></a><span class="w">          </span><span class="n">CO2air</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-136" name="ln-136" href="#ln-136"></a><span class="w">          </span><span class="n">Elev</span><span class="w"></span>
<a id="ln-137" name="ln-137" href="#ln-137"></a><span class="w">  </span><span class="k">END TYPE </span><span class="n">convert_units_type</span><span class="w"></span>
<a id="ln-138" name="ln-138" href="#ln-138"></a><span class="w">  </span><span class="k">TYPE</span><span class="p">(</span><span class="n">convert_units_type</span><span class="p">)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">convert</span><span class="w"> </span><span class="c">! units change factors for met variables</span>
<a id="ln-139" name="ln-139" href="#ln-139"></a>
<a id="ln-140" name="ln-140" href="#ln-140"></a><span class="w">  </span><span class="c">!$OMP THREADPRIVATE(ok,exists)</span>
<a id="ln-141" name="ln-141" href="#ln-141"></a>
<a id="ln-142" name="ln-142" href="#ln-142"></a><span class="k">CONTAINS</span><span class="w"></span>
<a id="ln-143" name="ln-143" href="#ln-143"></a>
<a id="ln-144" name="ln-144" href="#ln-144"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-145" name="ln-145" href="#ln-145"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-146" name="ln-146" href="#ln-146"></a><span class="w">  </span><span class="c">! Name: get_default_lai</span>
<a id="ln-147" name="ln-147" href="#ln-147"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-148" name="ln-148" href="#ln-148"></a><span class="w">  </span><span class="c">! Purpose: Reads all monthly LAI from default gridded netcdf file</span>
<a id="ln-149" name="ln-149" href="#ln-149"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-150" name="ln-150" href="#ln-150"></a><span class="w">  </span><span class="c">! CALLed from: load_parameters</span>
<a id="ln-151" name="ln-151" href="#ln-151"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-152" name="ln-152" href="#ln-152"></a><span class="w">  </span><span class="c">! CALLs: nc_abort</span>
<a id="ln-153" name="ln-153" href="#ln-153"></a><span class="w">  </span><span class="c">!        abort</span>
<a id="ln-154" name="ln-154" href="#ln-154"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-155" name="ln-155" href="#ln-155"></a><span class="w">  </span><span class="c">! Input file: [LAI].nc</span>
<a id="ln-156" name="ln-156" href="#ln-156"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-157" name="ln-157" href="#ln-157"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-158" name="ln-158" href="#ln-158"></a>
<a id="ln-159" name="ln-159" href="#ln-159"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">get_default_lai</span><span class="w"></span>
<a id="ln-160" name="ln-160" href="#ln-160"></a>
<a id="ln-161" name="ln-161" href="#ln-161"></a><span class="w">    </span><span class="c">! Input variables:</span>
<a id="ln-162" name="ln-162" href="#ln-162"></a><span class="w">    </span><span class="c">!   filename%LAI      - via cable_IO_vars_module</span>
<a id="ln-163" name="ln-163" href="#ln-163"></a><span class="w">    </span><span class="c">!   landpt            - via cable_IO_vars_module (%nap,cstart,cend,ilon,ilat)</span>
<a id="ln-164" name="ln-164" href="#ln-164"></a><span class="w">    </span><span class="c">!   exists%laiPatch   - via cable_IO_vars_module</span>
<a id="ln-165" name="ln-165" href="#ln-165"></a><span class="w">    </span><span class="c">! Output variables:</span>
<a id="ln-166" name="ln-166" href="#ln-166"></a><span class="w">    </span><span class="c">!   defaultLAI(mp,12) - via cable_IO_vars_module</span>
<a id="ln-167" name="ln-167" href="#ln-167"></a>
<a id="ln-168" name="ln-168" href="#ln-168"></a><span class="w">    </span><span class="c">! Local variables</span>
<a id="ln-169" name="ln-169" href="#ln-169"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">                              </span><span class="kd">::</span><span class="w">                                </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-170" name="ln-170" href="#ln-170"></a><span class="w">         </span><span class="n">ncid</span><span class="p">,</span><span class="w">                                   </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-171" name="ln-171" href="#ln-171"></a><span class="w">         </span><span class="n">xID</span><span class="p">,</span><span class="w">                                    </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-172" name="ln-172" href="#ln-172"></a><span class="w">         </span><span class="n">yID</span><span class="p">,</span><span class="w">                                    </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-173" name="ln-173" href="#ln-173"></a><span class="w">         </span><span class="n">pID</span><span class="p">,</span><span class="w">                                    </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-174" name="ln-174" href="#ln-174"></a><span class="w">         </span><span class="n">tID</span><span class="p">,</span><span class="w">                                    </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-175" name="ln-175" href="#ln-175"></a><span class="w">         </span><span class="n">laiID</span><span class="p">,</span><span class="w">                                  </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-176" name="ln-176" href="#ln-176"></a><span class="w">         </span><span class="n">nlon</span><span class="p">,</span><span class="w">                                   </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-177" name="ln-177" href="#ln-177"></a><span class="w">         </span><span class="n">nlat</span><span class="p">,</span><span class="w">                                   </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-178" name="ln-178" href="#ln-178"></a><span class="w">         </span><span class="n">nLaiPatches</span><span class="p">,</span><span class="w">                            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-179" name="ln-179" href="#ln-179"></a><span class="w">         </span><span class="n">ntime</span><span class="p">,</span><span class="w">                                  </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-180" name="ln-180" href="#ln-180"></a><span class="w">         </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">tt</span><span class="p">,</span><span class="n">i</span><span class="w">                                     </span><span class="c">! do loop counter</span>
<a id="ln-181" name="ln-181" href="#ln-181"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:,:,:),</span><span class="w">  </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">inLai3D</span><span class="w"></span>
<a id="ln-182" name="ln-182" href="#ln-182"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:,:,:,:),</span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">inLai4D</span><span class="w"></span>
<a id="ln-183" name="ln-183" href="#ln-183"></a>
<a id="ln-184" name="ln-184" href="#ln-184"></a><span class="w">    </span><span class="c">! Allocate default LAI variable: changed mland to mp (BP apr2010)</span>
<a id="ln-185" name="ln-185" href="#ln-185"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">defaultLAI</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span><span class="w">   </span><span class="c">! mp = mp_global</span>
<a id="ln-186" name="ln-186" href="#ln-186"></a>
<a id="ln-187" name="ln-187" href="#ln-187"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Loading LAI from default file &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">LAI</span><span class="p">)</span><span class="w"></span>
<a id="ln-188" name="ln-188" href="#ln-188"></a><span class="w">    </span><span class="c">! Open netcdf file</span>
<a id="ln-189" name="ln-189" href="#ln-189"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid</span><span class="p">)</span><span class="w"></span>
<a id="ln-190" name="ln-190" href="#ln-190"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error opening default LAI file.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-191" name="ln-191" href="#ln-191"></a>
<a id="ln-192" name="ln-192" href="#ln-192"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">xID</span><span class="p">)</span><span class="w"></span>
<a id="ln-193" name="ln-193" href="#ln-193"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">   </span><span class="c">! added to read some input files (BP mar2011)</span>
<a id="ln-194" name="ln-194" href="#ln-194"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">xID</span><span class="p">)</span><span class="w"></span>
<a id="ln-195" name="ln-195" href="#ln-195"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error inquiring x dimension.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-196" name="ln-196" href="#ln-196"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-197" name="ln-197" href="#ln-197"></a>
<a id="ln-198" name="ln-198" href="#ln-198"></a><span class="k">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="n">xID</span><span class="p">,</span><span class="nb">LEN</span><span class="o">=</span><span class="n">nlon</span><span class="p">)</span><span class="w"></span>
<a id="ln-199" name="ln-199" href="#ln-199"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error getting x dimension.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-200" name="ln-200" href="#ln-200"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">yID</span><span class="p">)</span><span class="w"></span>
<a id="ln-201" name="ln-201" href="#ln-201"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">   </span><span class="c">! added to read some input files (BP mar2011)</span>
<a id="ln-202" name="ln-202" href="#ln-202"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">yID</span><span class="p">)</span><span class="w"></span>
<a id="ln-203" name="ln-203" href="#ln-203"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error inquiring y dimension.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-204" name="ln-204" href="#ln-204"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-205" name="ln-205" href="#ln-205"></a><span class="k">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="n">yID</span><span class="p">,</span><span class="nb">LEN</span><span class="o">=</span><span class="n">nlat</span><span class="p">)</span><span class="w"></span>
<a id="ln-206" name="ln-206" href="#ln-206"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error getting y dimension.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-207" name="ln-207" href="#ln-207"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span><span class="n">pID</span><span class="p">)</span><span class="w"></span>
<a id="ln-208" name="ln-208" href="#ln-208"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if failed</span>
<a id="ln-209" name="ln-209" href="#ln-209"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">laiPatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"></span>
<a id="ln-210" name="ln-210" href="#ln-210"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; **ALL patches will be given the same LAI**&#39;</span><span class="w"></span>
<a id="ln-211" name="ln-211" href="#ln-211"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-212" name="ln-212" href="#ln-212"></a><span class="k">       </span><span class="n">exists</span><span class="p">%</span><span class="n">laiPatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-213" name="ln-213" href="#ln-213"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="n">pID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">nLaiPatches</span><span class="p">)</span><span class="w"></span>
<a id="ln-214" name="ln-214" href="#ln-214"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">landpt</span><span class="p">(:)%</span><span class="n">nap</span><span class="o">&gt;</span><span class="n">nLaiPatches</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-215" name="ln-215" href="#ln-215"></a><span class="k">          WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; **Some patches will be given the same LAI**&#39;</span><span class="w"></span>
<a id="ln-216" name="ln-216" href="#ln-216"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-217" name="ln-217" href="#ln-217"></a><span class="k">       IF</span><span class="p">(</span><span class="n">nLaiPatches</span><span class="o">&gt;</span><span class="n">max_vegpatches</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! input file can have more info</span>
<a id="ln-218" name="ln-218" href="#ln-218"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Note that LAI input file has &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nLaiPatches</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; patches.&#39;</span><span class="w"></span>
<a id="ln-219" name="ln-219" href="#ln-219"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; while the model has max at &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">max_vegpatches</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; patches.&#39;</span><span class="w"></span>
<a id="ln-220" name="ln-220" href="#ln-220"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-221" name="ln-221" href="#ln-221"></a><span class="k">    END IF</span>
<a id="ln-222" name="ln-222" href="#ln-222"></a><span class="k">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">tID</span><span class="p">)</span><span class="w"></span>
<a id="ln-223" name="ln-223" href="#ln-223"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">   </span><span class="c">! added to read some input files (BP mar2011)</span>
<a id="ln-224" name="ln-224" href="#ln-224"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;month&#39;</span><span class="p">,</span><span class="n">tID</span><span class="p">)</span><span class="w"></span>
<a id="ln-225" name="ln-225" href="#ln-225"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error inquiring t dimension.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-226" name="ln-226" href="#ln-226"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-227" name="ln-227" href="#ln-227"></a><span class="k">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="n">tID</span><span class="p">,</span><span class="nb">LEN</span><span class="o">=</span><span class="n">ntime</span><span class="p">)</span><span class="w"></span>
<a id="ln-228" name="ln-228" href="#ln-228"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error getting time dimension.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-229" name="ln-229" href="#ln-229"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ntime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Time dimension not 12 months.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-230" name="ln-230" href="#ln-230"></a>
<a id="ln-231" name="ln-231" href="#ln-231"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="s1">&#39;LAI&#39;</span><span class="p">,</span><span class="n">laiID</span><span class="p">)</span><span class="w"></span>
<a id="ln-232" name="ln-232" href="#ln-232"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding LAI variable.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-233" name="ln-233" href="#ln-233"></a>
<a id="ln-234" name="ln-234" href="#ln-234"></a><span class="w">    </span><span class="c">! Read LAI values:</span>
<a id="ln-235" name="ln-235" href="#ln-235"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">laiPatch</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-236" name="ln-236" href="#ln-236"></a><span class="k">       ALLOCATE</span><span class="p">(</span><span class="n">inLai4D</span><span class="p">(</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">nLaiPatches</span><span class="p">,</span><span class="n">ntime</span><span class="p">))</span><span class="w"></span>
<a id="ln-237" name="ln-237" href="#ln-237"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="n">laiID</span><span class="p">,</span><span class="n">inLai4D</span><span class="p">)</span><span class="w"></span>
<a id="ln-238" name="ln-238" href="#ln-238"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading 4D LAI variable.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-239" name="ln-239" href="#ln-239"></a><span class="w">       </span><span class="k">DO </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w">  </span><span class="c">! over all land grid points</span>
<a id="ln-240" name="ln-240" href="#ln-240"></a><span class="w">          </span><span class="k">DO </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntime</span><span class="w"></span>
<a id="ln-241" name="ln-241" href="#ln-241"></a><span class="w">             </span><span class="n">defaultLAI</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-242" name="ln-242" href="#ln-242"></a><span class="w">                  </span><span class="n">inLai4D</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">ilon</span><span class="p">,</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">ilat</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">nap</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="w"></span>
<a id="ln-243" name="ln-243" href="#ln-243"></a><span class="w">          </span><span class="k">END DO</span>
<a id="ln-244" name="ln-244" href="#ln-244"></a><span class="k">       END DO</span>
<a id="ln-245" name="ln-245" href="#ln-245"></a><span class="k">    ELSE</span>
<a id="ln-246" name="ln-246" href="#ln-246"></a><span class="k">       ALLOCATE</span><span class="p">(</span><span class="n">inLai3D</span><span class="p">(</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">,</span><span class="n">ntime</span><span class="p">))</span><span class="w"></span>
<a id="ln-247" name="ln-247" href="#ln-247"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid</span><span class="p">,</span><span class="n">laiID</span><span class="p">,</span><span class="n">inLai3D</span><span class="p">)</span><span class="w"></span>
<a id="ln-248" name="ln-248" href="#ln-248"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading 3D LAI variable.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-249" name="ln-249" href="#ln-249"></a><span class="w">       </span><span class="k">DO </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-250" name="ln-250" href="#ln-250"></a><span class="w">          </span><span class="k">DO </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ntime</span><span class="w"></span>
<a id="ln-251" name="ln-251" href="#ln-251"></a><span class="w">             </span><span class="n">defaultLAI</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-252" name="ln-252" href="#ln-252"></a><span class="w">                  </span><span class="n">inLai3D</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">ilon</span><span class="p">,</span><span class="n">landpt</span><span class="p">(</span><span class="n">e</span><span class="p">)%</span><span class="n">ilat</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="w"></span>
<a id="ln-253" name="ln-253" href="#ln-253"></a><span class="w">          </span><span class="k">END DO</span>
<a id="ln-254" name="ln-254" href="#ln-254"></a><span class="k">       END DO</span>
<a id="ln-255" name="ln-255" href="#ln-255"></a><span class="k">    END IF</span><span class="w"></span>
<a id="ln-256" name="ln-256" href="#ln-256"></a>
<a id="ln-257" name="ln-257" href="#ln-257"></a><span class="w">    </span><span class="c">! Close netcdf file</span>
<a id="ln-258" name="ln-258" href="#ln-258"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_CLOSE</span><span class="p">(</span><span class="n">ncid</span><span class="p">)</span><span class="w"></span>
<a id="ln-259" name="ln-259" href="#ln-259"></a>
<a id="ln-260" name="ln-260" href="#ln-260"></a>
<a id="ln-261" name="ln-261" href="#ln-261"></a><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">get_default_lai</span><span class="w"></span>
<a id="ln-262" name="ln-262" href="#ln-262"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-263" name="ln-263" href="#ln-263"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-264" name="ln-264" href="#ln-264"></a><span class="w">  </span><span class="c">! Name: open_met_file</span>
<a id="ln-265" name="ln-265" href="#ln-265"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-266" name="ln-266" href="#ln-266"></a><span class="w">  </span><span class="c">! Purpose: Opens netcdf file containing meteorological (LSM input) data</span>
<a id="ln-267" name="ln-267" href="#ln-267"></a><span class="w">  </span><span class="c">!          and determines:</span>
<a id="ln-268" name="ln-268" href="#ln-268"></a><span class="w">  </span><span class="c">!   1. Spatial details - number of sites/grid cells, latitudes, longitudes</span>
<a id="ln-269" name="ln-269" href="#ln-269"></a><span class="w">  </span><span class="c">!   2. Timing details - time step size, number of timesteps, starting date,</span>
<a id="ln-270" name="ln-270" href="#ln-270"></a><span class="w">  </span><span class="c">!      and whether time coordinate is local or GMT</span>
<a id="ln-271" name="ln-271" href="#ln-271"></a><span class="w">  </span><span class="c">!   3. Checks availability, including units issues, of all required</span>
<a id="ln-272" name="ln-272" href="#ln-272"></a><span class="w">  </span><span class="c">!      meteorological input variables. Also checks whether or not LAI is</span>
<a id="ln-273" name="ln-273" href="#ln-273"></a><span class="w">  </span><span class="c">!      present, and fetches prescribed veg and soil type if present.</span>
<a id="ln-274" name="ln-274" href="#ln-274"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-275" name="ln-275" href="#ln-275"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-276" name="ln-276" href="#ln-276"></a><span class="w">  </span><span class="c">! CALLed from: cable_offline_driver</span>
<a id="ln-277" name="ln-277" href="#ln-277"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-278" name="ln-278" href="#ln-278"></a><span class="w">  </span><span class="c">! CALLs: abort</span>
<a id="ln-279" name="ln-279" href="#ln-279"></a><span class="w">  </span><span class="c">!        nc_abort</span>
<a id="ln-280" name="ln-280" href="#ln-280"></a><span class="w">  </span><span class="c">!        date_and_time</span>
<a id="ln-281" name="ln-281" href="#ln-281"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-282" name="ln-282" href="#ln-282"></a><span class="w">  </span><span class="c">! Input file: [SiteName].nc</span>
<a id="ln-283" name="ln-283" href="#ln-283"></a><span class="w">  </span><span class="c">!             [GSWP_Snowf].nc</span>
<a id="ln-284" name="ln-284" href="#ln-284"></a><span class="w">  </span><span class="c">!             [GSWP_LWdown].nc</span>
<a id="ln-285" name="ln-285" href="#ln-285"></a><span class="w">  </span><span class="c">!             [GSWP_SWdown].nc</span>
<a id="ln-286" name="ln-286" href="#ln-286"></a><span class="w">  </span><span class="c">!             [GSWP_PSurf].nc</span>
<a id="ln-287" name="ln-287" href="#ln-287"></a><span class="w">  </span><span class="c">!             [GSWP_Qair].nc</span>
<a id="ln-288" name="ln-288" href="#ln-288"></a><span class="w">  </span><span class="c">!             [GSWP_Tair].nc</span>
<a id="ln-289" name="ln-289" href="#ln-289"></a><span class="w">  </span><span class="c">!             [GSWP_wind].nc</span>
<a id="ln-290" name="ln-290" href="#ln-290"></a><span class="w">  </span><span class="c">!             [GSWP_Rainf].nc</span>
<a id="ln-291" name="ln-291" href="#ln-291"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-292" name="ln-292" href="#ln-292"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-293" name="ln-293" href="#ln-293"></a>
<a id="ln-294" name="ln-294" href="#ln-294"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">open_met_file</span><span class="p">(</span><span class="n">dels</span><span class="p">,</span><span class="n">koffset</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">spinup</span><span class="p">,</span><span class="w"> </span><span class="n">TFRZ</span><span class="p">)</span><span class="w"></span>
<a id="ln-295" name="ln-295" href="#ln-295"></a>
<a id="ln-296" name="ln-296" href="#ln-296"></a><span class="w">    </span><span class="k">USE </span><span class="n">CABLE_COMMON_MODULE</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">IS_LEAPYEAR</span><span class="w"></span>
<a id="ln-297" name="ln-297" href="#ln-297"></a><span class="w">    </span><span class="k">USE </span><span class="n">casa_ncdf_module</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">HANDLE_ERR</span><span class="p">,</span><span class="w"> </span><span class="n">YMDHMS2DOYSOD</span><span class="p">,</span><span class="w"> </span><span class="n">DOYSOD2YMDHMS</span><span class="w"></span>
<a id="ln-298" name="ln-298" href="#ln-298"></a><span class="w">    </span><span class="k">USE </span><span class="n">CABLE_METUTILS_MODULE</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">,</span><span class="w"> </span><span class="n">find_metvarid</span><span class="w"></span>
<a id="ln-299" name="ln-299" href="#ln-299"></a>
<a id="ln-300" name="ln-300" href="#ln-300"></a><span class="w">    </span><span class="k">IMPLICIT NONE</span><span class="w"></span>
<a id="ln-301" name="ln-301" href="#ln-301"></a><span class="w">    </span><span class="c">! Input arguments</span>
<a id="ln-302" name="ln-302" href="#ln-302"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dels</span><span class="w">   </span><span class="c">! time step size</span>
<a id="ln-303" name="ln-303" href="#ln-303"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TFRZ</span><span class="w"></span>
<a id="ln-304" name="ln-304" href="#ln-304"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">koffset</span><span class="w"> </span><span class="c">! offset between met file and desired period</span>
<a id="ln-305" name="ln-305" href="#ln-305"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">kend</span><span class="w">   </span><span class="c">! number of time steps in simulation</span>
<a id="ln-306" name="ln-306" href="#ln-306"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">              </span><span class="kd">::</span><span class="w"> </span><span class="n">spinup</span><span class="w"> </span><span class="c">! will a model spinup be performed?</span>
<a id="ln-307" name="ln-307" href="#ln-307"></a>
<a id="ln-308" name="ln-308" href="#ln-308"></a><span class="w">    </span><span class="c">! Local variables</span>
<a id="ln-309" name="ln-309" href="#ln-309"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">                     </span><span class="kd">::</span><span class="w">                                         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-310" name="ln-310" href="#ln-310"></a><span class="w">         </span><span class="n">timevarID</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! time variable ID number</span>
<a id="ln-311" name="ln-311" href="#ln-311"></a><span class="w">         </span><span class="n">xdimID</span><span class="p">,</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! x dimension ID numbers</span>
<a id="ln-312" name="ln-312" href="#ln-312"></a><span class="w">         </span><span class="n">ydimID</span><span class="p">,</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! y dimension ID numbers</span>
<a id="ln-313" name="ln-313" href="#ln-313"></a><span class="w">         </span><span class="n">patchdimID</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! patch dimension ID</span>
<a id="ln-314" name="ln-314" href="#ln-314"></a><span class="w">         </span><span class="n">monthlydimID</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! month dimension ID for LAI info</span>
<a id="ln-315" name="ln-315" href="#ln-315"></a><span class="w">         </span><span class="n">maskID</span><span class="p">,</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! mask variable ID</span>
<a id="ln-316" name="ln-316" href="#ln-316"></a><span class="w">         </span><span class="n">landID</span><span class="p">,</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! land variable ID</span>
<a id="ln-317" name="ln-317" href="#ln-317"></a><span class="w">         </span><span class="n">landdimID</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! land dimension ID</span>
<a id="ln-318" name="ln-318" href="#ln-318"></a><span class="w">         </span><span class="n">latitudeID</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! lat variable IDs</span>
<a id="ln-319" name="ln-319" href="#ln-319"></a><span class="w">         </span><span class="n">longitudeID</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! lon variable IDs</span>
<a id="ln-320" name="ln-320" href="#ln-320"></a><span class="w">         </span><span class="n">edoy</span><span class="p">,</span><span class="w">                   </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! end time day-of-year</span>
<a id="ln-321" name="ln-321" href="#ln-321"></a><span class="w">         </span><span class="n">eyear</span><span class="p">,</span><span class="w">                  </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! end time year</span>
<a id="ln-322" name="ln-322" href="#ln-322"></a><span class="w">         </span><span class="n">jump_days</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! days made by first &quot;time&quot; entry</span>
<a id="ln-323" name="ln-323" href="#ln-323"></a><span class="w">         </span><span class="n">sdoytmp</span><span class="p">,</span><span class="w">                </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! used to determine start time hour-of-day</span>
<a id="ln-324" name="ln-324" href="#ln-324"></a><span class="w">         </span><span class="n">mland_ctr</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! counter for number of land points read from file</span>
<a id="ln-325" name="ln-325" href="#ln-325"></a><span class="w">         </span><span class="n">mland_fromfile</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! number of land points in file</span>
<a id="ln-326" name="ln-326" href="#ln-326"></a><span class="w">         </span><span class="n">lai_dims</span><span class="p">,</span><span class="w">               </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! number of dims of LAI var if in met file</span>
<a id="ln-327" name="ln-327" href="#ln-327"></a><span class="w">         </span><span class="n">iveg_dims</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! number of dims of iveg var if in met file</span>
<a id="ln-328" name="ln-328" href="#ln-328"></a><span class="w">         </span><span class="n">isoil_dims</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! number of dims of isoil var if in met file</span>
<a id="ln-329" name="ln-329" href="#ln-329"></a><span class="w">         </span><span class="n">tsmin</span><span class="p">,</span><span class="n">tsdoy</span><span class="p">,</span><span class="n">tsyear</span><span class="p">,</span><span class="w">     </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! temporary variables</span>
<a id="ln-330" name="ln-330" href="#ln-330"></a><span class="w">         </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="w">                </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! do loop counters</span>
<a id="ln-331" name="ln-331" href="#ln-331"></a><span class="w">         </span><span class="n">tempmonth</span><span class="p">,</span><span class="w">                              </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-332" name="ln-332" href="#ln-332"></a><span class="w">         </span><span class="n">ssod</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-333" name="ln-333" href="#ln-333"></a><span class="w">         </span><span class="n">nsod</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-334" name="ln-334" href="#ln-334"></a><span class="w">         </span><span class="n">LOY</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-335" name="ln-335" href="#ln-335"></a><span class="w">         </span><span class="n">iday</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-336" name="ln-336" href="#ln-336"></a><span class="w">         </span><span class="n">imin</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-337" name="ln-337" href="#ln-337"></a><span class="w">         </span><span class="n">isec</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-338" name="ln-338" href="#ln-338"></a><span class="w">         </span><span class="n">ishod</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-339" name="ln-339" href="#ln-339"></a><span class="w">         </span><span class="n">dnsec</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-340" name="ln-340" href="#ln-340"></a><span class="w">         </span><span class="n">ntstp</span><span class="w"></span>
<a id="ln-341" name="ln-341" href="#ln-341"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w">                                         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-342" name="ln-342" href="#ln-342"></a><span class="w">         </span><span class="n">timedimID</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! time dimension ID number</span>
<a id="ln-343" name="ln-343" href="#ln-343"></a><span class="w">         </span><span class="n">data1i</span><span class="w">                    </span><span class="c">! temp variable for netcdf reading</span>
<a id="ln-344" name="ln-344" href="#ln-344"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">laidimids</span><span class="w"> </span><span class="c">! for checking lai variable</span>
<a id="ln-345" name="ln-345" href="#ln-345"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">data2i</span><span class="w"> </span><span class="c">! temp variable for netcdf reading</span>
<a id="ln-346" name="ln-346" href="#ln-346"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">POINTER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:)</span><span class="w">     </span><span class="kd">::</span><span class="n">land_xtmp</span><span class="p">,</span><span class="n">land_ytmp</span><span class="w"> </span><span class="c">! temp indicies</span>
<a id="ln-347" name="ln-347" href="#ln-347"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="k">POINTER</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">lat_temp</span><span class="p">,</span><span class="w"> </span><span class="n">lon_temp</span><span class="w"> </span><span class="c">! lat and lon</span>
<a id="ln-348" name="ln-348" href="#ln-348"></a><span class="w">    </span><span class="kt">REAL</span><span class="w">                        </span><span class="kd">::</span><span class="w">                                         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-349" name="ln-349" href="#ln-349"></a><span class="w">         </span><span class="n">tshod</span><span class="p">,</span><span class="w">                  </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! temporary variable</span>
<a id="ln-350" name="ln-350" href="#ln-350"></a><span class="w">         </span><span class="n">ehod</span><span class="p">,</span><span class="w">                   </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! end time hour-of-day</span>
<a id="ln-351" name="ln-351" href="#ln-351"></a><span class="w">         </span><span class="n">precipTot</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! used for spinup adj</span>
<a id="ln-352" name="ln-352" href="#ln-352"></a><span class="w">         </span><span class="n">avPrecipInMet</span><span class="w">             </span><span class="c">! used for spinup adj</span>
<a id="ln-353" name="ln-353" href="#ln-353"></a><span class="w">    </span><span class="kt">CHARACTER</span><span class="p">(</span><span class="nb">LEN</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="w">                </span><span class="kd">::</span><span class="w"> </span><span class="n">todaydate</span><span class="p">,</span><span class="w"> </span><span class="n">nowtime</span><span class="w"> </span><span class="c">! used to timestamp log file</span>
<a id="ln-354" name="ln-354" href="#ln-354"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">             </span><span class="kd">::</span><span class="w"> </span><span class="n">data1</span><span class="w"> </span><span class="c">! temp variable for netcdf reading</span>
<a id="ln-355" name="ln-355" href="#ln-355"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">           </span><span class="kd">::</span><span class="w"> </span><span class="n">data2</span><span class="w"> </span><span class="c">! temp variable for netcdf reading</span>
<a id="ln-356" name="ln-356" href="#ln-356"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:),</span><span class="w">     </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temparray1</span><span class="w">  </span><span class="c">! temp read in variable</span>
<a id="ln-357" name="ln-357" href="#ln-357"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:,:),</span><span class="w">   </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-358" name="ln-358" href="#ln-358"></a><span class="w">         </span><span class="n">tempPrecip2</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! used for spinup adj</span>
<a id="ln-359" name="ln-359" href="#ln-359"></a><span class="w">         </span><span class="n">temparray2</span><span class="w">                </span><span class="c">! temp read in variable</span>
<a id="ln-360" name="ln-360" href="#ln-360"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:,:,:),</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tempPrecip3</span><span class="w"> </span><span class="c">! used for spinup adj</span>
<a id="ln-361" name="ln-361" href="#ln-361"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="w">                          </span><span class="kd">::</span><span class="w">                                         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-362" name="ln-362" href="#ln-362"></a><span class="w">         </span><span class="n">all_met</span><span class="p">,</span><span class="n">LAT1D</span><span class="p">,</span><span class="n">LON1D</span><span class="w">     </span><span class="c">! ALL required met in met file (no synthesis)?</span>
<a id="ln-363" name="ln-363" href="#ln-363"></a>
<a id="ln-364" name="ln-364" href="#ln-364"></a><span class="w">    </span><span class="c">! Initialise parameter loading switch - will be set to TRUE when</span>
<a id="ln-365" name="ln-365" href="#ln-365"></a><span class="w">    </span><span class="c">! parameters are loaded:</span>
<a id="ln-366" name="ln-366" href="#ln-366"></a><span class="w">    </span><span class="n">exists</span><span class="p">%</span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! initialise</span>
<a id="ln-367" name="ln-367" href="#ln-367"></a><span class="w">    </span><span class="c">! Initialise initialisation loading switch - will be set to TRUE when</span>
<a id="ln-368" name="ln-368" href="#ln-368"></a><span class="w">    </span><span class="c">! initialisation data are loaded:</span>
<a id="ln-369" name="ln-369" href="#ln-369"></a><span class="w">    </span><span class="n">exists</span><span class="p">%</span><span class="n">initial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! initialise</span>
<a id="ln-370" name="ln-370" href="#ln-370"></a>
<a id="ln-371" name="ln-371" href="#ln-371"></a><span class="w">    </span><span class="n">LAT1D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"></span>
<a id="ln-372" name="ln-372" href="#ln-372"></a><span class="w">    </span><span class="n">LON1D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"></span>
<a id="ln-373" name="ln-373" href="#ln-373"></a>
<a id="ln-374" name="ln-374" href="#ln-374"></a><span class="w">    </span><span class="c">! Write filename to log file:</span>
<a id="ln-375" name="ln-375" href="#ln-375"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;============================================================&#39;</span><span class="w"></span>
<a id="ln-376" name="ln-376" href="#ln-376"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Log file for offline CABLE run:&#39;</span><span class="w"></span>
<a id="ln-377" name="ln-377" href="#ln-377"></a><span class="w">    </span><span class="k">CALL </span><span class="nb">DATE_AND_TIME</span><span class="p">(</span><span class="n">todaydate</span><span class="p">,</span><span class="w"> </span><span class="n">nowtime</span><span class="p">)</span><span class="w"></span>
<a id="ln-378" name="ln-378" href="#ln-378"></a><span class="w">    </span><span class="n">todaydate</span><span class="o">=</span><span class="n">todaydate</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">todaydate</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="n">todaydate</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<a id="ln-379" name="ln-379" href="#ln-379"></a><span class="w">    </span><span class="n">nowtime</span><span class="o">=</span><span class="n">nowtime</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;:&#39;</span><span class="o">//</span><span class="n">nowtime</span><span class="p">(</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;:&#39;</span><span class="o">//</span><span class="n">nowtime</span><span class="p">(</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="w"></span>
<a id="ln-380" name="ln-380" href="#ln-380"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">nowtime</span><span class="p">),</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">todaydate</span><span class="p">)</span><span class="w"></span>
<a id="ln-381" name="ln-381" href="#ln-381"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;============================================================&#39;</span><span class="w"></span>
<a id="ln-382" name="ln-382" href="#ln-382"></a>
<a id="ln-383" name="ln-383" href="#ln-383"></a><span class="w">    </span><span class="c">! Open netcdf file:</span>
<a id="ln-384" name="ln-384" href="#ln-384"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-385" name="ln-385" href="#ln-385"></a>
<a id="ln-386" name="ln-386" href="#ln-386"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-387" name="ln-387" href="#ln-387"></a><span class="k">       WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Opening met data file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">rainf</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39; and 7 more&#39;</span><span class="w"></span>
<a id="ln-388" name="ln-388" href="#ln-388"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-389" name="ln-389" href="#ln-389"></a><span class="k">         WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Opening met data file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">rainf</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39; and 7 more&#39;</span><span class="w"></span>
<a id="ln-390" name="ln-390" href="#ln-390"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-391" name="ln-391" href="#ln-391"></a><span class="k"> </span>
<a id="ln-392" name="ln-392" href="#ln-392"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-393" name="ln-393" href="#ln-393"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">rainf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_rain</span><span class="p">)</span><span class="w"></span>
<a id="ln-394" name="ln-394" href="#ln-394"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-395" name="ln-395" href="#ln-395"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">rainf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_rain</span><span class="p">)</span><span class="w"></span>
<a id="ln-396" name="ln-396" href="#ln-396"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-397" name="ln-397" href="#ln-397"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-398" name="ln-398" href="#ln-398"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;rainf&#39;</span><span class="w"></span>
<a id="ln-399" name="ln-399" href="#ln-399"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-400" name="ln-400" href="#ln-400"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-401" name="ln-401" href="#ln-401"></a><span class="k">       IF</span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-402" name="ln-402" href="#ln-402"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">snowf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_snow</span><span class="p">)</span><span class="w"></span>
<a id="ln-403" name="ln-403" href="#ln-403"></a><span class="w">         </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-404" name="ln-404" href="#ln-404"></a><span class="k">            PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;snow&#39;</span><span class="w"></span>
<a id="ln-405" name="ln-405" href="#ln-405"></a><span class="w">            </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-406" name="ln-406" href="#ln-406"></a><span class="w">         </span><span class="k">ENDIF</span>
<a id="ln-407" name="ln-407" href="#ln-407"></a><span class="k">       ENDIF</span>
<a id="ln-408" name="ln-408" href="#ln-408"></a><span class="k">       </span>
<a id="ln-409" name="ln-409" href="#ln-409"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-410" name="ln-410" href="#ln-410"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">LWdown</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_lw</span><span class="p">)</span><span class="w"></span>
<a id="ln-411" name="ln-411" href="#ln-411"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-412" name="ln-412" href="#ln-412"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="w">     </span><span class="p">%</span><span class="n">LWdown</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_lw</span><span class="p">)</span><span class="w"></span>
<a id="ln-413" name="ln-413" href="#ln-413"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-414" name="ln-414" href="#ln-414"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-415" name="ln-415" href="#ln-415"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;lw&#39;</span><span class="w"></span>
<a id="ln-416" name="ln-416" href="#ln-416"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-417" name="ln-417" href="#ln-417"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-418" name="ln-418" href="#ln-418"></a><span class="k">       </span>
<a id="ln-419" name="ln-419" href="#ln-419"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-420" name="ln-420" href="#ln-420"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">SWdown</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_sw</span><span class="p">)</span><span class="w"></span>
<a id="ln-421" name="ln-421" href="#ln-421"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-422" name="ln-422" href="#ln-422"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">SWdown</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_sw</span><span class="p">)</span><span class="w"></span>
<a id="ln-423" name="ln-423" href="#ln-423"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-424" name="ln-424" href="#ln-424"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-425" name="ln-425" href="#ln-425"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;sw&#39;</span><span class="w"></span>
<a id="ln-426" name="ln-426" href="#ln-426"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-427" name="ln-427" href="#ln-427"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-428" name="ln-428" href="#ln-428"></a><span class="k">       </span>
<a id="ln-429" name="ln-429" href="#ln-429"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-430" name="ln-430" href="#ln-430"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_ps</span><span class="p">)</span><span class="w"></span>
<a id="ln-431" name="ln-431" href="#ln-431"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-432" name="ln-432" href="#ln-432"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_ps</span><span class="p">)</span><span class="w"></span>
<a id="ln-433" name="ln-433" href="#ln-433"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-434" name="ln-434" href="#ln-434"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-435" name="ln-435" href="#ln-435"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;ps&#39;</span><span class="w"></span>
<a id="ln-436" name="ln-436" href="#ln-436"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-437" name="ln-437" href="#ln-437"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-438" name="ln-438" href="#ln-438"></a><span class="k">       </span>
<a id="ln-439" name="ln-439" href="#ln-439"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-440" name="ln-440" href="#ln-440"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_qa</span><span class="p">)</span><span class="w"></span>
<a id="ln-441" name="ln-441" href="#ln-441"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-442" name="ln-442" href="#ln-442"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_qa</span><span class="p">)</span><span class="w"></span>
<a id="ln-443" name="ln-443" href="#ln-443"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-444" name="ln-444" href="#ln-444"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-445" name="ln-445" href="#ln-445"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;qa&#39;</span><span class="w"></span>
<a id="ln-446" name="ln-446" href="#ln-446"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-447" name="ln-447" href="#ln-447"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-448" name="ln-448" href="#ln-448"></a><span class="k">       </span>
<a id="ln-449" name="ln-449" href="#ln-449"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-450" name="ln-450" href="#ln-450"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_ta</span><span class="p">)</span><span class="w"></span>
<a id="ln-451" name="ln-451" href="#ln-451"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-452" name="ln-452" href="#ln-452"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_ta</span><span class="p">)</span><span class="w"></span>
<a id="ln-453" name="ln-453" href="#ln-453"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-454" name="ln-454" href="#ln-454"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-455" name="ln-455" href="#ln-455"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;ta&#39;</span><span class="w"></span>
<a id="ln-456" name="ln-456" href="#ln-456"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-457" name="ln-457" href="#ln-457"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-458" name="ln-458" href="#ln-458"></a><span class="k">       </span>
<a id="ln-459" name="ln-459" href="#ln-459"></a><span class="k">       IF</span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gpcc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-460" name="ln-460" href="#ln-460"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">wind</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_wd</span><span class="p">)</span><span class="w"></span>
<a id="ln-461" name="ln-461" href="#ln-461"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-462" name="ln-462" href="#ln-462"></a><span class="k">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">wind</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_wd</span><span class="p">)</span><span class="w"></span>
<a id="ln-463" name="ln-463" href="#ln-463"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-464" name="ln-464" href="#ln-464"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-465" name="ln-465" href="#ln-465"></a><span class="k">          PRINT</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;wind&#39;</span><span class="p">,</span><span class="n">ncid_wd</span><span class="w"></span>
<a id="ln-466" name="ln-466" href="#ln-466"></a><span class="w">          </span><span class="k">CALL </span><span class="n">handle_err</span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-467" name="ln-467" href="#ln-467"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-468" name="ln-468" href="#ln-468"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-469" name="ln-469" href="#ln-469"></a><span class="k">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">gswpfile</span><span class="p">%</span><span class="n">mask</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_mask</span><span class="p">)</span><span class="w"></span>
<a id="ln-470" name="ln-470" href="#ln-470"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-471" name="ln-471" href="#ln-471"></a><span class="k">             CALL </span><span class="n">nc_abort</span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Error opening GSWP3 mask file&quot;</span><span class="p">)</span><span class="w"></span>
<a id="ln-472" name="ln-472" href="#ln-472"></a><span class="w">          </span><span class="k">END IF</span>
<a id="ln-473" name="ln-473" href="#ln-473"></a><span class="k">          </span><span class="n">LAT1D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w">   </span><span class="c">!GSWP3 forcing has 1d lat/lon variables</span>
<a id="ln-474" name="ln-474" href="#ln-474"></a><span class="w">          </span><span class="n">LON1D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-475" name="ln-475" href="#ln-475"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-476" name="ln-476" href="#ln-476"></a><span class="k">          </span><span class="n">ncid_mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_rain</span><span class="w"></span>
<a id="ln-477" name="ln-477" href="#ln-477"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-478" name="ln-478" href="#ln-478"></a><span class="k">       </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_rain</span><span class="w"></span>
<a id="ln-479" name="ln-479" href="#ln-479"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-480" name="ln-480" href="#ln-480"></a><span class="k">       WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Opening met data file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="w"></span>
<a id="ln-481" name="ln-481" href="#ln-481"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ncid_met</span><span class="p">)</span><span class="w"> </span><span class="c">! open met data file</span>
<a id="ln-482" name="ln-482" href="#ln-482"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-483" name="ln-483" href="#ln-483"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error opening netcdf met forcing file &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-484" name="ln-484" href="#ln-484"></a><span class="w">            </span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-485" name="ln-485" href="#ln-485"></a><span class="w">    </span><span class="k">ENDIF</span><span class="w"></span>
<a id="ln-486" name="ln-486" href="#ln-486"></a>
<a id="ln-487" name="ln-487" href="#ln-487"></a><span class="w">    </span><span class="c">!!=====================VV Determine spatial details VV=================</span>
<a id="ln-488" name="ln-488" href="#ln-488"></a><span class="w">    </span><span class="c">! Determine number of sites/gridcells.</span>
<a id="ln-489" name="ln-489" href="#ln-489"></a><span class="w">    </span><span class="c">! Find size of &#39;x&#39; or &#39;lon&#39; dimension:</span>
<a id="ln-490" name="ln-490" href="#ln-490"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">xdimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-491" name="ln-491" href="#ln-491"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if failed</span>
<a id="ln-492" name="ln-492" href="#ln-492"></a><span class="w">       </span><span class="c">! Try &#39;lon&#39; instead of x</span>
<a id="ln-493" name="ln-493" href="#ln-493"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">xdimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-494" name="ln-494" href="#ln-494"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-495" name="ln-495" href="#ln-495"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding x dimension in &#39;</span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-496" name="ln-496" href="#ln-496"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-497" name="ln-497" href="#ln-497"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-498" name="ln-498" href="#ln-498"></a><span class="k">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">xdimID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">xdimsize</span><span class="p">)</span><span class="w"></span>
<a id="ln-499" name="ln-499" href="#ln-499"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-500" name="ln-500" href="#ln-500"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error determining size of x dimension in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-501" name="ln-501" href="#ln-501"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-502" name="ln-502" href="#ln-502"></a><span class="w">    </span><span class="c">! Find size of &#39;y&#39; dimension:</span>
<a id="ln-503" name="ln-503" href="#ln-503"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ydimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-504" name="ln-504" href="#ln-504"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if failed</span>
<a id="ln-505" name="ln-505" href="#ln-505"></a><span class="w">       </span><span class="c">! Try &#39;lat&#39; instead of y</span>
<a id="ln-506" name="ln-506" href="#ln-506"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ydimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-507" name="ln-507" href="#ln-507"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-508" name="ln-508" href="#ln-508"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding y dimension in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-509" name="ln-509" href="#ln-509"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-510" name="ln-510" href="#ln-510"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-511" name="ln-511" href="#ln-511"></a><span class="k">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">ydimID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">ydimsize</span><span class="p">)</span><span class="w"></span>
<a id="ln-512" name="ln-512" href="#ln-512"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-513" name="ln-513" href="#ln-513"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error determining size of y dimension in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-514" name="ln-514" href="#ln-514"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-515" name="ln-515" href="#ln-515"></a><span class="w">    </span><span class="c">! Determine number of gridcells in netcdf file:</span>
<a id="ln-516" name="ln-516" href="#ln-516"></a><span class="w">    </span><span class="n">ngridcells</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xdimsize</span><span class="o">*</span><span class="n">ydimsize</span><span class="w"></span>
<a id="ln-517" name="ln-517" href="#ln-517"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(A28,I7)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Total number of gridcells: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ngridcells</span><span class="w"></span>
<a id="ln-518" name="ln-518" href="#ln-518"></a>
<a id="ln-519" name="ln-519" href="#ln-519"></a><span class="w">    </span><span class="c">! Get all latitude and longitude values.</span>
<a id="ln-520" name="ln-520" href="#ln-520"></a><span class="w">    </span><span class="c">! Find latitude variable (try &#39;latitude&#39; and &#39;nav_lat&#39;(ALMA)):</span>
<a id="ln-521" name="ln-521" href="#ln-521"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">LatNames</span><span class="p">,</span><span class="w"> </span><span class="n">latitudeID</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-522" name="ln-522" href="#ln-522"></a>
<a id="ln-523" name="ln-523" href="#ln-523"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-524" name="ln-524" href="#ln-524"></a><span class="w">      </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding latitude variable in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-525" name="ln-525" href="#ln-525"></a><span class="w">      </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-526" name="ln-526" href="#ln-526"></a>
<a id="ln-527" name="ln-527" href="#ln-527"></a><span class="w">    </span><span class="c">! Allocate space for lat_all variable and its temp counterpart:</span>
<a id="ln-528" name="ln-528" href="#ln-528"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">lat_all</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-529" name="ln-529" href="#ln-529"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">temparray2</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-530" name="ln-530" href="#ln-530"></a><span class="w">    </span><span class="c">!MDeck allow for 1d lat called &#39;lat&#39;</span>
<a id="ln-531" name="ln-531" href="#ln-531"></a><span class="w">    </span><span class="c">! Get latitude values for entire region:</span>
<a id="ln-532" name="ln-532" href="#ln-532"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">LAT1D</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-533" name="ln-533" href="#ln-533"></a><span class="k">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">latitudeID</span><span class="p">,</span><span class="n">temparray2</span><span class="p">)</span><span class="w"></span>
<a id="ln-534" name="ln-534" href="#ln-534"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-535" name="ln-535" href="#ln-535"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="nb">ALLOCATED</span><span class="p">(</span><span class="n">temparray1</span><span class="p">))</span><span class="w"> </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-536" name="ln-536" href="#ln-536"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">(</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-537" name="ln-537" href="#ln-537"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">latitudeID</span><span class="p">,</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-538" name="ln-538" href="#ln-538"></a><span class="w">       </span><span class="n">temparray2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">SPREAD</span><span class="p">(</span><span class="n">temparray1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">xdimsize</span><span class="p">)</span><span class="w"></span>
<a id="ln-539" name="ln-539" href="#ln-539"></a><span class="w">       </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-540" name="ln-540" href="#ln-540"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-541" name="ln-541" href="#ln-541"></a><span class="k">    IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-542" name="ln-542" href="#ln-542"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading latitude variable in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-543" name="ln-543" href="#ln-543"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-544" name="ln-544" href="#ln-544"></a><span class="w">    </span><span class="c">! Needed since r_1 will be double precision with -r8:</span>
<a id="ln-545" name="ln-545" href="#ln-545"></a><span class="w">    </span><span class="n">lat_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">temparray2</span><span class="p">)</span><span class="w"></span>
<a id="ln-546" name="ln-546" href="#ln-546"></a>
<a id="ln-547" name="ln-547" href="#ln-547"></a><span class="w">    </span><span class="c">! Find longitude variable (try &#39;longitude&#39; and &#39;nav_lon&#39;(ALMA)):</span>
<a id="ln-548" name="ln-548" href="#ln-548"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">LonNames</span><span class="p">,</span><span class="w"> </span><span class="n">longitudeID</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-549" name="ln-549" href="#ln-549"></a>
<a id="ln-550" name="ln-550" href="#ln-550"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-551" name="ln-551" href="#ln-551"></a><span class="w">      </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding longitude variable in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-552" name="ln-552" href="#ln-552"></a><span class="w">      </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-553" name="ln-553" href="#ln-553"></a>
<a id="ln-554" name="ln-554" href="#ln-554"></a><span class="w">      </span><span class="c">! Allocate space for lon_all variable:</span>
<a id="ln-555" name="ln-555" href="#ln-555"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">lon_all</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-556" name="ln-556" href="#ln-556"></a><span class="w">    </span><span class="c">! Get longitude values for entire region:</span>
<a id="ln-557" name="ln-557" href="#ln-557"></a><span class="w">    </span><span class="c">!MDeck allow for 1d lon</span>
<a id="ln-558" name="ln-558" href="#ln-558"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">LON1D</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-559" name="ln-559" href="#ln-559"></a><span class="k">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">longitudeID</span><span class="p">,</span><span class="n">temparray2</span><span class="p">)</span><span class="w"></span>
<a id="ln-560" name="ln-560" href="#ln-560"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-561" name="ln-561" href="#ln-561"></a><span class="k">       ALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-562" name="ln-562" href="#ln-562"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">longitudeID</span><span class="p">,</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-563" name="ln-563" href="#ln-563"></a><span class="w">       </span><span class="n">temparray2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">SPREAD</span><span class="p">(</span><span class="n">temparray1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">)</span><span class="w"></span>
<a id="ln-564" name="ln-564" href="#ln-564"></a><span class="w">       </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-565" name="ln-565" href="#ln-565"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-566" name="ln-566" href="#ln-566"></a><span class="k">    IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-567" name="ln-567" href="#ln-567"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading longitude variable in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-568" name="ln-568" href="#ln-568"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-569" name="ln-569" href="#ln-569"></a><span class="w">    </span><span class="c">! Needed since r_1 will be double precision with -r8:</span>
<a id="ln-570" name="ln-570" href="#ln-570"></a><span class="w">    </span><span class="n">lon_all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">temparray2</span><span class="p">)</span><span class="w"></span>
<a id="ln-571" name="ln-571" href="#ln-571"></a><span class="w">    </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">temparray2</span><span class="p">)</span><span class="w"></span>
<a id="ln-572" name="ln-572" href="#ln-572"></a>
<a id="ln-573" name="ln-573" href="#ln-573"></a><span class="w">    </span><span class="c">! Check for &quot;mask&quot; variable or &quot;land&quot; variable to tell grid type</span>
<a id="ln-574" name="ln-574" href="#ln-574"></a><span class="w">    </span><span class="c">! (and allow neither if only one gridpoint). &quot;mask&quot; is a 2D variable</span>
<a id="ln-575" name="ln-575" href="#ln-575"></a><span class="w">    </span><span class="c">! with dims x,y and &quot;land&quot; is a 1D variable.</span>
<a id="ln-576" name="ln-576" href="#ln-576"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_mask</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">MaskNames</span><span class="p">,</span><span class="w"> </span><span class="n">maskID</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-577" name="ln-577" href="#ln-577"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if error, i.e. no &quot;mask&quot; variable:</span>
<a id="ln-578" name="ln-578" href="#ln-578"></a><span class="w">       </span><span class="c">! Check for &quot;land&quot; variable:</span>
<a id="ln-579" name="ln-579" href="#ln-579"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;land&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">landID</span><span class="p">)</span><span class="w"></span>
<a id="ln-580" name="ln-580" href="#ln-580"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! ie no &quot;land&quot; or &quot;mask&quot;</span>
<a id="ln-581" name="ln-581" href="#ln-581"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ngridcells</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-582" name="ln-582" href="#ln-582"></a><span class="w">             </span><span class="c">! Allow no explicit grid system if only one gridpoint</span>
<a id="ln-583" name="ln-583" href="#ln-583"></a><span class="w">             </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"> </span><span class="c">! Allocate &quot;mask&quot; variable</span>
<a id="ln-584" name="ln-584" href="#ln-584"></a><span class="w">             </span><span class="n">metGrid</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="w"> </span><span class="c">! Use mask system, one gridpoint.</span>
<a id="ln-585" name="ln-585" href="#ln-585"></a><span class="w">             </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-586" name="ln-586" href="#ln-586"></a><span class="w">             </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">latitude</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">longitude</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-587" name="ln-587" href="#ln-587"></a><span class="w">             </span><span class="n">latitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat_all</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="ln-588" name="ln-588" href="#ln-588"></a><span class="w">             </span><span class="n">longitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon_all</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="ln-589" name="ln-589" href="#ln-589"></a><span class="w">             </span><span class="n">mland_fromfile</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<a id="ln-590" name="ln-590" href="#ln-590"></a><span class="w">             </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-591" name="ln-591" href="#ln-591"></a><span class="w">             </span><span class="n">land_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-592" name="ln-592" href="#ln-592"></a><span class="w">             </span><span class="n">land_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-593" name="ln-593" href="#ln-593"></a><span class="w">          </span><span class="k">ELSE</span><span class="w"></span>
<a id="ln-594" name="ln-594" href="#ln-594"></a><span class="w">             </span><span class="c">! Call abort if more than one gridcell and no</span>
<a id="ln-595" name="ln-595" href="#ln-595"></a><span class="w">             </span><span class="c">! recognised grid system:</span>
<a id="ln-596" name="ln-596" href="#ln-596"></a><span class="w">             </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-597" name="ln-597" href="#ln-597"></a><span class="w">                  </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding grid system (&quot;mask&quot; or &quot;land&quot;) variable in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-598" name="ln-598" href="#ln-598"></a><span class="w">                  </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-599" name="ln-599" href="#ln-599"></a><span class="w">          </span><span class="k">END IF</span>
<a id="ln-600" name="ln-600" href="#ln-600"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! i.e. &quot;land&quot; variable exists</span>
<a id="ln-601" name="ln-601" href="#ln-601"></a><span class="w">          </span><span class="n">metGrid</span><span class="o">=</span><span class="s1">&#39;land&#39;</span><span class="w"></span>
<a id="ln-602" name="ln-602" href="#ln-602"></a><span class="w">          </span><span class="c">! Check size of &quot;land&quot; dimension:</span>
<a id="ln-603" name="ln-603" href="#ln-603"></a><span class="w">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;land&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">landdimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-604" name="ln-604" href="#ln-604"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-605" name="ln-605" href="#ln-605"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding land dimension in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-606" name="ln-606" href="#ln-606"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-607" name="ln-607" href="#ln-607"></a><span class="w">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">landdimID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">mland_fromfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-608" name="ln-608" href="#ln-608"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-609" name="ln-609" href="#ln-609"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error determining size of land dimension in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-610" name="ln-610" href="#ln-610"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-611" name="ln-611" href="#ln-611"></a><span class="w">          </span><span class="c">! Allocate landGrid variable and its temporary counterpart:</span>
<a id="ln-612" name="ln-612" href="#ln-612"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">landGrid</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-613" name="ln-613" href="#ln-613"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-614" name="ln-614" href="#ln-614"></a><span class="w">          </span><span class="c">! Get values of &quot;land&quot; variable from file:</span>
<a id="ln-615" name="ln-615" href="#ln-615"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">landID</span><span class="p">,</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-616" name="ln-616" href="#ln-616"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-617" name="ln-617" href="#ln-617"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading &quot;land&quot; variable in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-618" name="ln-618" href="#ln-618"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-619" name="ln-619" href="#ln-619"></a><span class="w">          </span><span class="c">! Needed since r_1 will be double precision with -r8:</span>
<a id="ln-620" name="ln-620" href="#ln-620"></a><span class="w">          </span><span class="n">landGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-621" name="ln-621" href="#ln-621"></a><span class="w">          </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-622" name="ln-622" href="#ln-622"></a><span class="w">          </span><span class="c">! Allocate latitude and longitude variables:</span>
<a id="ln-623" name="ln-623" href="#ln-623"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">latitude</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">),</span><span class="n">longitude</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-624" name="ln-624" href="#ln-624"></a><span class="w">          </span><span class="c">! Write to indicies of points in all-grid which are land</span>
<a id="ln-625" name="ln-625" href="#ln-625"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-626" name="ln-626" href="#ln-626"></a><span class="w">          </span><span class="c">! Allocate &quot;mask&quot; variable:</span>
<a id="ln-627" name="ln-627" href="#ln-627"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-628" name="ln-628" href="#ln-628"></a><span class="w">          </span><span class="c">! Initialise all gridpoints as sea:</span>
<a id="ln-629" name="ln-629" href="#ln-629"></a><span class="w">          </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<a id="ln-630" name="ln-630" href="#ln-630"></a><span class="w">          </span><span class="k">DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland_fromfile</span><span class="w"> </span><span class="c">! over all land points</span>
<a id="ln-631" name="ln-631" href="#ln-631"></a><span class="w">             </span><span class="c">! Find x and y coords of current land point</span>
<a id="ln-632" name="ln-632" href="#ln-632"></a><span class="w">             </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">INT</span><span class="p">((</span><span class="n">landGrid</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">)</span><span class="w"></span>
<a id="ln-633" name="ln-633" href="#ln-633"></a><span class="w">             </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">landGrid</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xdimsize</span><span class="w"></span>
<a id="ln-634" name="ln-634" href="#ln-634"></a><span class="w">             </span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<a id="ln-635" name="ln-635" href="#ln-635"></a><span class="w">             </span><span class="c">! Write lat and lon to land-only lat/lon vars:</span>
<a id="ln-636" name="ln-636" href="#ln-636"></a><span class="w">             </span><span class="n">latitude</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<a id="ln-637" name="ln-637" href="#ln-637"></a><span class="w">             </span><span class="n">longitude</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<a id="ln-638" name="ln-638" href="#ln-638"></a><span class="w">             </span><span class="c">! Write to mask variable:</span>
<a id="ln-639" name="ln-639" href="#ln-639"></a><span class="w">             </span><span class="n">mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<a id="ln-640" name="ln-640" href="#ln-640"></a><span class="w">             </span><span class="c">! Save indicies:</span>
<a id="ln-641" name="ln-641" href="#ln-641"></a><span class="w">             </span><span class="n">land_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<a id="ln-642" name="ln-642" href="#ln-642"></a><span class="w">             </span><span class="n">land_y</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<a id="ln-643" name="ln-643" href="#ln-643"></a><span class="w">          </span><span class="k">END DO</span>
<a id="ln-644" name="ln-644" href="#ln-644"></a><span class="k">       END IF</span><span class="w"> </span><span class="c">! does &quot;land&quot; variable exist</span>
<a id="ln-645" name="ln-645" href="#ln-645"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="c">! i.e. &quot;mask&quot; variable exists</span>
<a id="ln-646" name="ln-646" href="#ln-646"></a><span class="w">       </span><span class="c">! Allocate &quot;mask&quot; variable:</span>
<a id="ln-647" name="ln-647" href="#ln-647"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-648" name="ln-648" href="#ln-648"></a><span class="w">       </span><span class="n">metGrid</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="w"> </span><span class="c">! Use mask system</span>
<a id="ln-649" name="ln-649" href="#ln-649"></a><span class="w">       </span><span class="c">! Get mask values from file:</span>
<a id="ln-650" name="ln-650" href="#ln-650"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_mask</span><span class="p">,</span><span class="n">maskID</span><span class="p">,</span><span class="n">mask</span><span class="p">)</span><span class="w"></span>
<a id="ln-651" name="ln-651" href="#ln-651"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-652" name="ln-652" href="#ln-652"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading &quot;mask&quot; variable in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-653" name="ln-653" href="#ln-653"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-654" name="ln-654" href="#ln-654"></a><span class="w">       </span><span class="c">!gswp3 uses 1 for sea and 0 for land, make is opposite</span>
<a id="ln-655" name="ln-655" href="#ln-655"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">gswp3</span><span class="p">)</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">-</span><span class="n">mask</span><span class="w"></span>
<a id="ln-656" name="ln-656" href="#ln-656"></a>
<a id="ln-657" name="ln-657" href="#ln-657"></a><span class="w">       </span><span class="c">! Allocate space for extracting land lat/lon values:</span>
<a id="ln-658" name="ln-658" href="#ln-658"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">lat_temp</span><span class="p">(</span><span class="n">ngridcells</span><span class="p">),</span><span class="n">lon_temp</span><span class="p">(</span><span class="n">ngridcells</span><span class="p">))</span><span class="w"></span>
<a id="ln-659" name="ln-659" href="#ln-659"></a><span class="w">       </span><span class="c">! Allocate space for extracting index of mask which is land</span>
<a id="ln-660" name="ln-660" href="#ln-660"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">land_xtmp</span><span class="p">(</span><span class="n">ngridcells</span><span class="p">),</span><span class="n">land_ytmp</span><span class="p">(</span><span class="n">ngridcells</span><span class="p">))</span><span class="w"></span>
<a id="ln-661" name="ln-661" href="#ln-661"></a><span class="w">       </span><span class="c">! Cycle through all gridsquares:</span>
<a id="ln-662" name="ln-662" href="#ln-662"></a><span class="w">       </span><span class="n">mland_ctr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="c">! initialise</span>
<a id="ln-663" name="ln-663" href="#ln-663"></a><span class="w">       </span><span class="k">DO </span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ydimsize</span><span class="w"></span>
<a id="ln-664" name="ln-664" href="#ln-664"></a><span class="w">          </span><span class="k">DO </span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">xdimsize</span><span class="w"></span>
<a id="ln-665" name="ln-665" href="#ln-665"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">mask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If land</span>
<a id="ln-666" name="ln-666" href="#ln-666"></a><span class="w">                </span><span class="n">mland_ctr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mland_ctr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-667" name="ln-667" href="#ln-667"></a><span class="w">                </span><span class="c">! Store lat and lon for land points</span>
<a id="ln-668" name="ln-668" href="#ln-668"></a><span class="w">                </span><span class="n">lat_temp</span><span class="p">(</span><span class="n">mland_ctr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<a id="ln-669" name="ln-669" href="#ln-669"></a><span class="w">                </span><span class="n">lon_temp</span><span class="p">(</span><span class="n">mland_ctr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<a id="ln-670" name="ln-670" href="#ln-670"></a><span class="w">                </span><span class="c">! Store indicies of points in mask which are land</span>
<a id="ln-671" name="ln-671" href="#ln-671"></a><span class="w">                </span><span class="n">land_xtmp</span><span class="p">(</span><span class="n">mland_ctr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<a id="ln-672" name="ln-672" href="#ln-672"></a><span class="w">                </span><span class="n">land_ytmp</span><span class="p">(</span><span class="n">mland_ctr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
<a id="ln-673" name="ln-673" href="#ln-673"></a><span class="w">             </span><span class="k">END IF</span>
<a id="ln-674" name="ln-674" href="#ln-674"></a><span class="k">          END DO</span>
<a id="ln-675" name="ln-675" href="#ln-675"></a><span class="k">       END DO</span><span class="w"></span>
<a id="ln-676" name="ln-676" href="#ln-676"></a><span class="w">       </span><span class="c">! Record number of land points</span>
<a id="ln-677" name="ln-677" href="#ln-677"></a><span class="w">       </span><span class="n">mland_fromfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mland_ctr</span><span class="w"></span>
<a id="ln-678" name="ln-678" href="#ln-678"></a><span class="w">       </span><span class="c">! Allocate latitude and longitude variables:</span>
<a id="ln-679" name="ln-679" href="#ln-679"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">latitude</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">),</span><span class="n">longitude</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-680" name="ln-680" href="#ln-680"></a><span class="w">       </span><span class="c">! Write to latitude and longitude variables:</span>
<a id="ln-681" name="ln-681" href="#ln-681"></a><span class="w">       </span><span class="n">latitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lat_temp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mland_fromfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-682" name="ln-682" href="#ln-682"></a><span class="w">       </span><span class="n">longitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lon_temp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mland_fromfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-683" name="ln-683" href="#ln-683"></a><span class="w">       </span><span class="c">! Write to indicies of points in mask which are land</span>
<a id="ln-684" name="ln-684" href="#ln-684"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="p">))</span><span class="w"></span>
<a id="ln-685" name="ln-685" href="#ln-685"></a><span class="w">       </span><span class="n">land_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">land_xtmp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mland_fromfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-686" name="ln-686" href="#ln-686"></a><span class="w">       </span><span class="n">land_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">land_ytmp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">mland_fromfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-687" name="ln-687" href="#ln-687"></a><span class="w">       </span><span class="c">! Clear lon_temp, lat_temp,land_xtmp,land_ytmp</span>
<a id="ln-688" name="ln-688" href="#ln-688"></a><span class="w">       </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">lat_temp</span><span class="p">,</span><span class="n">lon_temp</span><span class="p">,</span><span class="n">land_xtmp</span><span class="p">,</span><span class="n">land_ytmp</span><span class="p">)</span><span class="w"></span>
<a id="ln-689" name="ln-689" href="#ln-689"></a><span class="w">    </span><span class="k">END IF</span><span class="w"> </span><span class="c">! &quot;mask&quot; variable or no &quot;mask&quot; variable</span>
<a id="ln-690" name="ln-690" href="#ln-690"></a>
<a id="ln-691" name="ln-691" href="#ln-691"></a><span class="w">    </span><span class="c">! Set global mland value (number of land points), used to allocate</span>
<a id="ln-692" name="ln-692" href="#ln-692"></a><span class="w">    </span><span class="c">! all of CABLE&#39;s arrays:</span>
<a id="ln-693" name="ln-693" href="#ln-693"></a><span class="w">    </span><span class="n">mland</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mland_fromfile</span><span class="w"></span>
<a id="ln-694" name="ln-694" href="#ln-694"></a>
<a id="ln-695" name="ln-695" href="#ln-695"></a><span class="w">    </span><span class="c">! Write number of land points to log file:</span>
<a id="ln-696" name="ln-696" href="#ln-696"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(24X,I7,A29)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">mland_fromfile</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; of which are land grid cells&#39;</span><span class="w"></span>
<a id="ln-697" name="ln-697" href="#ln-697"></a>
<a id="ln-698" name="ln-698" href="#ln-698"></a><span class="w">    </span><span class="c">! Check if veg/soil patch dimension exists (could have</span>
<a id="ln-699" name="ln-699" href="#ln-699"></a><span class="w">    </span><span class="c">! parameters with patch dimension)</span>
<a id="ln-700" name="ln-700" href="#ln-700"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;patch&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">patchdimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-701" name="ln-701" href="#ln-701"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if failed</span>
<a id="ln-702" name="ln-702" href="#ln-702"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">patch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"></span>
<a id="ln-703" name="ln-703" href="#ln-703"></a><span class="w">       </span><span class="n">nmetpatches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w">       </span><span class="c">! initialised so that old met files without patch</span>
<a id="ln-704" name="ln-704" href="#ln-704"></a><span class="w">       </span><span class="c">! data can still be run correctly (BP apr08)</span>
<a id="ln-705" name="ln-705" href="#ln-705"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="c">! met file does have patch dimension</span>
<a id="ln-706" name="ln-706" href="#ln-706"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">patch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-707" name="ln-707" href="#ln-707"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">patchdimID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">nmetpatches</span><span class="p">)</span><span class="w"></span>
<a id="ln-708" name="ln-708" href="#ln-708"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-709" name="ln-709" href="#ln-709"></a>
<a id="ln-710" name="ln-710" href="#ln-710"></a><span class="w">    </span><span class="c">! Check if monthly dimension exists for LAI info</span>
<a id="ln-711" name="ln-711" href="#ln-711"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;monthly&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">monthlydimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-712" name="ln-712" href="#ln-712"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">==</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if found</span>
<a id="ln-713" name="ln-713" href="#ln-713"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">monthlydimID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">tempmonth</span><span class="p">)</span><span class="w"></span>
<a id="ln-714" name="ln-714" href="#ln-714"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">tempmonth</span><span class="o">/=</span><span class="mi">12</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="nb">abort</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Number of months in met file /= 12.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-715" name="ln-715" href="#ln-715"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-716" name="ln-716" href="#ln-716"></a>
<a id="ln-717" name="ln-717" href="#ln-717"></a><span class="w">    </span><span class="c">! Set longitudes to be [-180,180]:</span>
<a id="ln-718" name="ln-718" href="#ln-718"></a><span class="w">    </span><span class="k">WHERE</span><span class="p">(</span><span class="n">longitude</span><span class="o">&gt;</span><span class="mi">18</span><span class="mf">0.0</span><span class="p">)</span><span class="w"></span>
<a id="ln-719" name="ln-719" href="#ln-719"></a><span class="w">       </span><span class="n">longitude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">36</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-720" name="ln-720" href="#ln-720"></a><span class="w">    </span><span class="k">END WHERE</span><span class="w"></span>
<a id="ln-721" name="ln-721" href="#ln-721"></a><span class="w">    </span><span class="c">! Check ranges for latitude and longitude:</span>
<a id="ln-722" name="ln-722" href="#ln-722"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">longitude</span><span class="o">&gt;</span><span class="mi">18</span><span class="mf">0.0</span><span class="p">).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">longitude</span><span class="o">&lt;-</span><span class="mi">18</span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-723" name="ln-723" href="#ln-723"></a><span class="w">         </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Longitudes read from &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-724" name="ln-724" href="#ln-724"></a><span class="w">         </span><span class="s1">&#39; are not [-180,180] or [0,360]! Please set.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-725" name="ln-725" href="#ln-725"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">latitude</span><span class="o">&gt;</span><span class="mi">9</span><span class="mf">0.0</span><span class="p">).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">latitude</span><span class="o">&lt;-</span><span class="mi">9</span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-726" name="ln-726" href="#ln-726"></a><span class="w">         </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Latitudes read from &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-727" name="ln-727" href="#ln-727"></a><span class="w">         </span><span class="s1">&#39; are not [-90,90]! Please set.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-728" name="ln-728" href="#ln-728"></a>
<a id="ln-729" name="ln-729" href="#ln-729"></a><span class="w">    </span><span class="c">!!=================^^ End spatial details ^^========================</span>
<a id="ln-730" name="ln-730" href="#ln-730"></a>
<a id="ln-731" name="ln-731" href="#ln-731"></a><span class="w">    </span><span class="c">!!=========VV Determine simulation timing details VV================</span>
<a id="ln-732" name="ln-732" href="#ln-732"></a><span class="w">    </span><span class="c">! Inquire &#39;time&#39; variable&#39;s ID:</span>
<a id="ln-733" name="ln-733" href="#ln-733"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">TimeNames</span><span class="p">,</span><span class="w"> </span><span class="n">timevarID</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-734" name="ln-734" href="#ln-734"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-735" name="ln-735" href="#ln-735"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding time variable in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-736" name="ln-736" href="#ln-736"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-737" name="ln-737" href="#ln-737"></a><span class="w">    </span><span class="c">! Get ID for dimension upon which time depends:</span>
<a id="ln-738" name="ln-738" href="#ln-738"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">timevarID</span><span class="p">,</span><span class="n">dimids</span><span class="o">=</span><span class="n">timedimID</span><span class="p">)</span><span class="w"></span>
<a id="ln-739" name="ln-739" href="#ln-739"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-740" name="ln-740" href="#ln-740"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error determining &quot;time&quot; dimension dimension in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-741" name="ln-741" href="#ln-741"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-742" name="ln-742" href="#ln-742"></a><span class="w">    </span><span class="c">! Determine number of time steps:</span>
<a id="ln-743" name="ln-743" href="#ln-743"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">timedimID</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nb">len</span><span class="o">=</span><span class="n">kend</span><span class="p">)</span><span class="w"></span>
<a id="ln-744" name="ln-744" href="#ln-744"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="o">/=</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-745" name="ln-745" href="#ln-745"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error determining number of timesteps in &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-746" name="ln-746" href="#ln-746"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-747" name="ln-747" href="#ln-747"></a><span class="w">    </span><span class="c">! Allocate time variable:</span>
<a id="ln-748" name="ln-748" href="#ln-748"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">))</span><span class="w"></span>
<a id="ln-749" name="ln-749" href="#ln-749"></a><span class="w">    </span><span class="c">! Fetch &#39;time&#39; variable:</span>
<a id="ln-750" name="ln-750" href="#ln-750"></a><span class="w">    </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">timevarID</span><span class="p">,</span><span class="n">timevar</span><span class="p">)</span><span class="w"></span>
<a id="ln-751" name="ln-751" href="#ln-751"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-752" name="ln-752" href="#ln-752"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading time variable in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-753" name="ln-753" href="#ln-753"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-754" name="ln-754" href="#ln-754"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">gswp3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w">         </span><span class="c">!Hack the GSWP3 time units to make from start of year</span>
<a id="ln-755" name="ln-755" href="#ln-755"></a><span class="w">       </span><span class="n">timevar</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">timevar</span><span class="p">(:)</span><span class="o">-</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.5</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.0</span><span class="w">  </span><span class="c">!convert hours to seconds</span>
<a id="ln-756" name="ln-756" href="#ln-756"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-757" name="ln-757" href="#ln-757"></a><span class="w">    </span><span class="c">! Set time step size:</span>
<a id="ln-758" name="ln-758" href="#ln-758"></a><span class="w">    </span><span class="n">dels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">timevar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-759" name="ln-759" href="#ln-759"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(1X,A29,I8,A3,F10.3,A5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Number of time steps in run: &#39;</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-760" name="ln-760" href="#ln-760"></a><span class="w">         </span><span class="n">kend</span><span class="p">,</span><span class="s1">&#39; = &#39;</span><span class="p">,</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">3600</span><span class="o">/</span><span class="n">dels</span><span class="o">*</span><span class="mi">24</span><span class="p">),</span><span class="s1">&#39; days&#39;</span><span class="w"></span>
<a id="ln-761" name="ln-761" href="#ln-761"></a>
<a id="ln-762" name="ln-762" href="#ln-762"></a>
<a id="ln-763" name="ln-763" href="#ln-763"></a><span class="w">    </span><span class="c">! CLN READJUST kend referring to Set START &amp; END</span>
<a id="ln-764" name="ln-764" href="#ln-764"></a><span class="w">    </span><span class="c">! if kend &gt; # days in selected episode</span>
<a id="ln-765" name="ln-765" href="#ln-765"></a>
<a id="ln-766" name="ln-766" href="#ln-766"></a>
<a id="ln-767" name="ln-767" href="#ln-767"></a><span class="w">    </span><span class="c">!********* gswp input file has bug in timevar **************</span>
<a id="ln-768" name="ln-768" href="#ln-768"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-769" name="ln-769" href="#ln-769"></a><span class="k">       PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;original timevar(kend) = &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="w"></span>
<a id="ln-770" name="ln-770" href="#ln-770"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-771" name="ln-771" href="#ln-771"></a><span class="w">          </span><span class="n">timevar</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timevar</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dels</span><span class="w"></span>
<a id="ln-772" name="ln-772" href="#ln-772"></a><span class="w">       </span><span class="k">ENDDO</span>
<a id="ln-773" name="ln-773" href="#ln-773"></a><span class="k">       PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;New      timevar(kend) = &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="w"></span>
<a id="ln-774" name="ln-774" href="#ln-774"></a><span class="w">       </span><span class="c">!! hacking (BP feb2011)</span>
<a id="ln-775" name="ln-775" href="#ln-775"></a><span class="w">       </span><span class="c">!      kend = 16   ! 2 days for 1986</span>
<a id="ln-776" name="ln-776" href="#ln-776"></a><span class="w">       </span><span class="c">!!      kend = 480  ! 2 months for 1986</span>
<a id="ln-777" name="ln-777" href="#ln-777"></a><span class="w">       </span><span class="c">!      PRINT *, &#39;Hacked   timevar(kend) = &#39;, timevar(kend)</span>
<a id="ln-778" name="ln-778" href="#ln-778"></a><span class="w">       </span><span class="c">!      PRINT *, &#39;Hacked kend = &#39;, kend</span>
<a id="ln-779" name="ln-779" href="#ln-779"></a><span class="w">       </span><span class="c">!! end hacking</span>
<a id="ln-780" name="ln-780" href="#ln-780"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-781" name="ln-781" href="#ln-781"></a><span class="w">    </span><span class="c">!********* done bug fixing for timevar in gswp input file **</span>
<a id="ln-782" name="ln-782" href="#ln-782"></a>
<a id="ln-783" name="ln-783" href="#ln-783"></a><span class="w">    </span><span class="c">! Write time step size to log file:</span>
<a id="ln-784" name="ln-784" href="#ln-784"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(1X,A17,F8.1,1X,A7)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Time step size:  &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dels</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;seconds&#39;</span><span class="w"></span>
<a id="ln-785" name="ln-785" href="#ln-785"></a><span class="w">    </span><span class="c">! Get units for &#39;time&#39; variable:</span>
<a id="ln-786" name="ln-786" href="#ln-786"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">timevarID</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">timeunits</span><span class="p">)</span><span class="w"></span>
<a id="ln-787" name="ln-787" href="#ln-787"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-788" name="ln-788" href="#ln-788"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">timevarID</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">timeunits</span><span class="p">)</span><span class="w"></span>
<a id="ln-789" name="ln-789" href="#ln-789"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-790" name="ln-790" href="#ln-790"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding time variable units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-791" name="ln-791" href="#ln-791"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-792" name="ln-792" href="#ln-792"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"></span>
<a id="ln-793" name="ln-793" href="#ln-793"></a><span class="w">       </span><span class="c">!Hack the GSWP3 time units to make from start of year</span>
<a id="ln-794" name="ln-794" href="#ln-794"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;writing timeunits&#39;</span><span class="w"></span>
<a id="ln-795" name="ln-795" href="#ln-795"></a><span class="w">       </span><span class="k">WRITE</span><span class="w"> </span><span class="p">(</span><span class="n">timeunits</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;(&#39;seconds since &#39;,I4.4,&#39;-01-01 00:00:00&#39;)&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">ncciy</span><span class="w"></span>
<a id="ln-796" name="ln-796" href="#ln-796"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;wrote time units&#39;</span><span class="w"></span>
<a id="ln-797" name="ln-797" href="#ln-797"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-798" name="ln-798" href="#ln-798"></a><span class="w">    </span><span class="c">!MDeck</span>
<a id="ln-799" name="ln-799" href="#ln-799"></a><span class="w">    </span><span class="c">!write(*,*) timeunits</span>
<a id="ln-800" name="ln-800" href="#ln-800"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-801" name="ln-801" href="#ln-801"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding time variable units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-802" name="ln-802" href="#ln-802"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-803" name="ln-803" href="#ln-803"></a>
<a id="ln-804" name="ln-804" href="#ln-804"></a><span class="w">    </span><span class="c">!****** PALS met file has timevar(1)=0 while timeunits from 00:30:00 ******</span>
<a id="ln-805" name="ln-805" href="#ln-805"></a><span class="w">    </span><span class="c">!!CLN CRITICAL! From my point of view, the information in the file is correct...</span>
<a id="ln-806" name="ln-806" href="#ln-806"></a><span class="w">    </span><span class="c">!!CLN WHY DO the input files all have bugs???</span>
<a id="ln-807" name="ln-807" href="#ln-807"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-808" name="ln-808" href="#ln-808"></a><span class="k">       READ</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">29</span><span class="p">:</span><span class="mi">30</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">tsmin</span><span class="w"></span>
<a id="ln-809" name="ln-809" href="#ln-809"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">tsmin</span><span class="o">*</span><span class="mi">6</span><span class="mf">0.0</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">dels</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-810" name="ln-810" href="#ln-810"></a><span class="k">          </span><span class="n">tsmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tsmin</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="n">dels</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="p">)</span><span class="w"></span>
<a id="ln-811" name="ln-811" href="#ln-811"></a><span class="w">          </span><span class="n">timevar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timevar</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dels</span><span class="w"></span>
<a id="ln-812" name="ln-812" href="#ln-812"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">29</span><span class="p">:</span><span class="mi">30</span><span class="p">),</span><span class="s1">&#39;(i2.2)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">tsmin</span><span class="w"></span>
<a id="ln-813" name="ln-813" href="#ln-813"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-814" name="ln-814" href="#ln-814"></a><span class="k">    ENDIF</span><span class="w"></span>
<a id="ln-815" name="ln-815" href="#ln-815"></a><span class="w">    </span><span class="c">!****** done bug fixing for timevar in PALS met file **********************</span>
<a id="ln-816" name="ln-816" href="#ln-816"></a>
<a id="ln-817" name="ln-817" href="#ln-817"></a><span class="w">    </span><span class="c">!********* gswp input file has bug in timeunits ************</span>
<a id="ln-818" name="ln-818" href="#ln-818"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">WRITE</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">26</span><span class="p">:</span><span class="mi">27</span><span class="p">),</span><span class="s1">&#39;(i2.2)&#39;</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<a id="ln-819" name="ln-819" href="#ln-819"></a><span class="w">    </span><span class="c">!********* done bug fixing for timeunits in gwsp file ******</span>
<a id="ln-820" name="ln-820" href="#ln-820"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Time variable units: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">timeunits</span><span class="w"></span>
<a id="ln-821" name="ln-821" href="#ln-821"></a><span class="w">    </span><span class="c">! Get coordinate field:</span>
<a id="ln-822" name="ln-822" href="#ln-822"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">timevarID</span><span class="p">,</span><span class="s1">&#39;coordinate&#39;</span><span class="p">,</span><span class="n">time_coord</span><span class="p">)</span><span class="w"></span>
<a id="ln-823" name="ln-823" href="#ln-823"></a><span class="w">    </span><span class="c">! If error getting coordinate field (i.e. it doesn&#39;t exist):</span>
<a id="ln-824" name="ln-824" href="#ln-824"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-825" name="ln-825" href="#ln-825"></a><span class="w">       </span><span class="c">! Assume default time coordinate:</span>
<a id="ln-826" name="ln-826" href="#ln-826"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">mland_fromfile</span><span class="o">==</span><span class="mf">1.</span><span class="nb">AND</span><span class="p">.(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">MetType</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;gswp&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If single site, this is local time</span>
<a id="ln-827" name="ln-827" href="#ln-827"></a><span class="w">          </span><span class="n">time_coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;LOC&#39;</span><span class="w"> </span><span class="c">! 12am is 12am local time, at site/gridcell</span>
<a id="ln-828" name="ln-828" href="#ln-828"></a><span class="w">       </span><span class="k">ELSE</span><span class="w"> </span><span class="c">! If multiple/global/regional, use GMT</span>
<a id="ln-829" name="ln-829" href="#ln-829"></a><span class="w">          </span><span class="n">time_coord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;GMT&#39;</span><span class="w"> </span><span class="c">! 12am is GMT time, local time set by longitude</span>
<a id="ln-830" name="ln-830" href="#ln-830"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-831" name="ln-831" href="#ln-831"></a><span class="k">    ELSE IF</span><span class="p">((</span><span class="n">ok</span><span class="o">==</span><span class="n">NF90_NOERR</span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="n">time_coord</span><span class="o">==</span><span class="s1">&#39;LOC&#39;</span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="n">mland_fromfile</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-832" name="ln-832" href="#ln-832"></a><span class="w">       </span><span class="c">! Else if local time is selected for regional simulation, abort:</span>
<a id="ln-833" name="ln-833" href="#ln-833"></a><span class="w">       </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;&quot;time&quot; variable must be GMT for multiple site simulation!&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-834" name="ln-834" href="#ln-834"></a><span class="w">            </span><span class="o">//</span><span class="s1">&#39; Check &quot;coordinate&quot; field in time variable.&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-835" name="ln-835" href="#ln-835"></a><span class="w">            </span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-836" name="ln-836" href="#ln-836"></a><span class="w">    </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">time_coord</span><span class="o">/=</span><span class="s1">&#39;LOC&#39;</span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="n">time_coord</span><span class="o">/=</span><span class="s1">&#39;GMT&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-837" name="ln-837" href="#ln-837"></a><span class="k">       CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Meaningless time coordinate in met data file!&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-838" name="ln-838" href="#ln-838"></a><span class="w">            </span><span class="o">//</span><span class="w"> </span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-839" name="ln-839" href="#ln-839"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-840" name="ln-840" href="#ln-840"></a>
<a id="ln-841" name="ln-841" href="#ln-841"></a><span class="w">    </span><span class="c">! Use internal files to convert &quot;time&quot; variable units (giving the run&#39;s</span>
<a id="ln-842" name="ln-842" href="#ln-842"></a><span class="w">    </span><span class="c">! start time) from character to integer; calculate starting hour-of-day,</span>
<a id="ln-843" name="ln-843" href="#ln-843"></a><span class="w">    </span><span class="c">! day-of-year, year:</span>
<a id="ln-844" name="ln-844" href="#ln-844"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-845" name="ln-845" href="#ln-845"></a><span class="k">       READ</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">syear</span><span class="w"></span>
<a id="ln-846" name="ln-846" href="#ln-846"></a><span class="w">       </span><span class="k">READ</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">20</span><span class="p">:</span><span class="mi">21</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">smoy</span><span class="w"> </span><span class="c">! integer month</span>
<a id="ln-847" name="ln-847" href="#ln-847"></a><span class="w">       </span><span class="k">READ</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">23</span><span class="p">:</span><span class="mi">24</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sdoytmp</span><span class="w"> </span><span class="c">! integer day of that month</span>
<a id="ln-848" name="ln-848" href="#ln-848"></a><span class="w">       </span><span class="k">READ</span><span class="p">(</span><span class="n">timeunits</span><span class="p">(</span><span class="mi">26</span><span class="p">:</span><span class="mi">27</span><span class="p">),</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">shod</span><span class="w">  </span><span class="c">! starting hour of day</span>
<a id="ln-849" name="ln-849" href="#ln-849"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-850" name="ln-850" href="#ln-850"></a><span class="k">       </span><span class="n">syear</span><span class="o">=</span><span class="n">ncciy</span><span class="w"></span>
<a id="ln-851" name="ln-851" href="#ln-851"></a><span class="w">       </span><span class="n">smoy</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<a id="ln-852" name="ln-852" href="#ln-852"></a><span class="w">       </span><span class="n">sdoytmp</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<a id="ln-853" name="ln-853" href="#ln-853"></a><span class="w">       </span><span class="n">shod</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>
<a id="ln-854" name="ln-854" href="#ln-854"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-855" name="ln-855" href="#ln-855"></a>
<a id="ln-856" name="ln-856" href="#ln-856"></a><span class="w">    </span><span class="c">! if site data, shift start time to middle of timestep</span>
<a id="ln-857" name="ln-857" href="#ln-857"></a><span class="w">    </span><span class="c">! only do this if not already at middle of timestep</span>
<a id="ln-858" name="ln-858" href="#ln-858"></a><span class="w">    </span><span class="c">!! vh_js !!</span>
<a id="ln-859" name="ln-859" href="#ln-859"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">((</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">MetType</span><span class="p">).</span><span class="n">EQ</span><span class="p">.</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-860" name="ln-860" href="#ln-860"></a><span class="w">         </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">MetType</span><span class="p">).</span><span class="n">EQ</span><span class="p">.</span><span class="s1">&#39;site&#39;</span><span class="p">).</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="n">shod</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span><span class="w"> </span><span class="n">dels</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-861" name="ln-861" href="#ln-861"></a><span class="w">         </span><span class="p">(</span><span class="n">shod</span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="n">dels</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-862" name="ln-862" href="#ln-862"></a><span class="k">       </span><span class="n">shod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shod</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dels</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="o">/</span><span class="mf">2.</span><span class="w"></span>
<a id="ln-863" name="ln-863" href="#ln-863"></a><span class="w">    </span><span class="n">ELSEIF</span><span class="w"> </span><span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">MetType</span><span class="p">).</span><span class="n">EQ</span><span class="p">.</span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-864" name="ln-864" href="#ln-864"></a><span class="w">         </span><span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">MetType</span><span class="p">).</span><span class="n">EQ</span><span class="p">.</span><span class="s1">&#39;site&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="n">shod</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span><span class="w"> </span><span class="n">dels</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-865" name="ln-865" href="#ln-865"></a><span class="w">         </span><span class="p">(</span><span class="n">shod</span><span class="p">.</span><span class="n">LT</span><span class="p">.</span><span class="n">dels</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-866" name="ln-866" href="#ln-866"></a><span class="k">       </span><span class="n">shod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dels</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="o">/</span><span class="mf">2.</span><span class="w"></span>
<a id="ln-867" name="ln-867" href="#ln-867"></a><span class="w">    </span><span class="k">ENDIF</span><span class="w"></span>
<a id="ln-868" name="ln-868" href="#ln-868"></a>
<a id="ln-869" name="ln-869" href="#ln-869"></a><span class="w">    </span><span class="c">! Decide day-of-year for non-leap year:</span>
<a id="ln-870" name="ln-870" href="#ln-870"></a><span class="w">    </span><span class="k">CALL </span><span class="n">YMDHMS2DOYSOD</span><span class="p">(</span><span class="w"> </span><span class="n">syear</span><span class="p">,</span><span class="w"> </span><span class="n">smoy</span><span class="p">,</span><span class="w"> </span><span class="n">sdoytmp</span><span class="p">,</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="n">shod</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">sdoy</span><span class="p">,</span><span class="w"> </span><span class="n">ssod</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-871" name="ln-871" href="#ln-871"></a><span class="w">    </span><span class="c">! Number of days between start position and 1st timestep:</span>
<a id="ln-872" name="ln-872" href="#ln-872"></a><span class="w">    </span><span class="n">sdoy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdoy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INT</span><span class="p">((</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shod</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.0</span><span class="p">)</span><span class="w"></span>
<a id="ln-873" name="ln-873" href="#ln-873"></a><span class="w">    </span><span class="n">nsod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="nb">INT</span><span class="p">((</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shod</span><span class="o">*</span><span class="mi">3600</span><span class="p">)),</span><span class="mi">86400</span><span class="p">)</span><span class="w"></span>
<a id="ln-874" name="ln-874" href="#ln-874"></a>
<a id="ln-875" name="ln-875" href="#ln-875"></a><span class="w">    </span><span class="k">DO</span>
<a id="ln-876" name="ln-876" href="#ln-876"></a><span class="k">       </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">365</span><span class="w"></span>
<a id="ln-877" name="ln-877" href="#ln-877"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IS_LEAPYEAR</span><span class="p">(</span><span class="w"> </span><span class="n">syear</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">366</span><span class="w"></span>
<a id="ln-878" name="ln-878" href="#ln-878"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">sdoy</span><span class="w"> </span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-879" name="ln-879" href="#ln-879"></a><span class="k">          </span><span class="n">sdoy</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">sdoy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">LOY</span><span class="w"></span>
<a id="ln-880" name="ln-880" href="#ln-880"></a><span class="w">          </span><span class="n">syear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syear</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-881" name="ln-881" href="#ln-881"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-882" name="ln-882" href="#ln-882"></a><span class="k">          EXIT</span>
<a id="ln-883" name="ln-883" href="#ln-883"></a><span class="k">       END IF</span>
<a id="ln-884" name="ln-884" href="#ln-884"></a><span class="k">    END DO</span>
<a id="ln-885" name="ln-885" href="#ln-885"></a>
<a id="ln-886" name="ln-886" href="#ln-886"></a>
<a id="ln-887" name="ln-887" href="#ln-887"></a><span class="k">    CALL </span><span class="n">DOYSOD2YMDHMS</span><span class="p">(</span><span class="w"> </span><span class="n">syear</span><span class="p">,</span><span class="w"> </span><span class="n">sdoy</span><span class="p">,</span><span class="w"> </span><span class="n">nsod</span><span class="p">,</span><span class="w"> </span><span class="n">smoy</span><span class="p">,</span><span class="w"> </span><span class="n">iday</span><span class="p">,</span><span class="w"> </span><span class="n">ishod</span><span class="p">,</span><span class="w"> </span><span class="n">imin</span><span class="p">,</span><span class="w"> </span><span class="n">isec</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-888" name="ln-888" href="#ln-888"></a><span class="w">    </span><span class="n">shod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">ishod</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">imin</span><span class="p">)</span><span class="o">/</span><span class="mi">6</span><span class="mf">0.</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">isec</span><span class="p">)</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="w"></span>
<a id="ln-889" name="ln-889" href="#ln-889"></a><span class="w">    </span><span class="c">! Cycle through days to find leap year inclusive starting date:</span>
<a id="ln-890" name="ln-890" href="#ln-890"></a><span class="w">    </span><span class="c">! Now all start time variables established, report to log file:</span>
<a id="ln-891" name="ln-891" href="#ln-891"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(1X,A12,F5.2,A14,I3,A14,I4,2X,A3,1X,A4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-892" name="ln-892" href="#ln-892"></a><span class="w">         </span><span class="s1">&#39;Run begins: &#39;</span><span class="p">,</span><span class="n">shod</span><span class="p">,</span><span class="s1">&#39; hour-of-day, &#39;</span><span class="p">,</span><span class="n">sdoy</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; day-of-year, &#39;</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-893" name="ln-893" href="#ln-893"></a><span class="w">         </span><span class="n">syear</span><span class="p">,</span><span class="w"> </span><span class="n">time_coord</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;time&#39;</span><span class="w"></span>
<a id="ln-894" name="ln-894" href="#ln-894"></a><span class="w">    </span><span class="c">! Determine ending time of run...</span>
<a id="ln-895" name="ln-895" href="#ln-895"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">leaps</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If we&#39;re using leap year timing...</span>
<a id="ln-896" name="ln-896" href="#ln-896"></a><span class="w">       </span><span class="n">eyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syear</span><span class="w"></span>
<a id="ln-897" name="ln-897" href="#ln-897"></a><span class="w">       </span><span class="n">edoy</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">sdoy</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INT</span><span class="p">(((</span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="o">-</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shod</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.0</span><span class="p">)</span><span class="w"></span>
<a id="ln-898" name="ln-898" href="#ln-898"></a><span class="w">       </span><span class="n">ehod</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(((</span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="o">-</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shod</span><span class="p">),</span><span class="mi">2</span><span class="mf">4._r_2</span><span class="p">)</span><span class="w"></span>
<a id="ln-899" name="ln-899" href="#ln-899"></a>
<a id="ln-900" name="ln-900" href="#ln-900"></a><span class="w">       </span><span class="k">DO</span>
<a id="ln-901" name="ln-901" href="#ln-901"></a><span class="k">          </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">365</span><span class="w"></span>
<a id="ln-902" name="ln-902" href="#ln-902"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IS_LEAPYEAR</span><span class="p">(</span><span class="w"> </span><span class="n">eyear</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">366</span><span class="w"></span>
<a id="ln-903" name="ln-903" href="#ln-903"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">edoy</span><span class="w"> </span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-904" name="ln-904" href="#ln-904"></a><span class="k">             </span><span class="n">edoy</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">edoy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">LOY</span><span class="w"></span>
<a id="ln-905" name="ln-905" href="#ln-905"></a><span class="w">             </span><span class="n">eyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eyear</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-906" name="ln-906" href="#ln-906"></a><span class="w">          </span><span class="k">ELSE</span>
<a id="ln-907" name="ln-907" href="#ln-907"></a><span class="k">             EXIT</span>
<a id="ln-908" name="ln-908" href="#ln-908"></a><span class="k">          END IF</span>
<a id="ln-909" name="ln-909" href="#ln-909"></a><span class="k">       END DO</span>
<a id="ln-910" name="ln-910" href="#ln-910"></a>
<a id="ln-911" name="ln-911" href="#ln-911"></a>
<a id="ln-912" name="ln-912" href="#ln-912"></a><span class="k">    ELSE</span><span class="w"> </span><span class="c">! if not using leap year timing</span>
<a id="ln-913" name="ln-913" href="#ln-913"></a><span class="w">       </span><span class="c">! Update shod, sdoy, syear for first &quot;time&quot; value:</span>
<a id="ln-914" name="ln-914" href="#ln-914"></a><span class="w">       </span><span class="n">ehod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="kt">REAL</span><span class="p">((</span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="o">-</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shod</span><span class="p">),</span><span class="mi">2</span><span class="mf">4.0</span><span class="p">)</span><span class="w"></span>
<a id="ln-915" name="ln-915" href="#ln-915"></a><span class="w">       </span><span class="n">edoy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">MOD</span><span class="p">(</span><span class="nb">INT</span><span class="p">(((</span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="o">-</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">shod</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-916" name="ln-916" href="#ln-916"></a><span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">sdoy</span><span class="p">,</span><span class="w"> </span><span class="mi">365</span><span class="p">)</span><span class="w"></span>
<a id="ln-917" name="ln-917" href="#ln-917"></a><span class="w">       </span><span class="n">eyear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="nb">INT</span><span class="p">(((</span><span class="n">timevar</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="o">-</span><span class="n">timevar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-918" name="ln-918" href="#ln-918"></a><span class="w">            </span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="o">+</span><span class="n">shod</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.0</span><span class="p">)</span><span class="o">+</span><span class="n">sdoy</span><span class="p">)</span><span class="o">/</span><span class="mi">36</span><span class="mf">5.0</span><span class="p">)</span><span class="o">+</span><span class="n">syear</span><span class="w"></span>
<a id="ln-919" name="ln-919" href="#ln-919"></a><span class="w">       </span><span class="c">!       ehod = MOD(REAL((timevar(kend)-timevar(1)+dels)/3600.0 + shod),24.0)</span>
<a id="ln-920" name="ln-920" href="#ln-920"></a><span class="w">       </span><span class="c">!       edoy = MOD(INT(((timevar(kend)-timevar(1)+dels)/3600.0 + shod)/24.0) &amp;</span>
<a id="ln-921" name="ln-921" href="#ln-921"></a><span class="w">       </span><span class="c">!            + sdoy, 365)</span>
<a id="ln-922" name="ln-922" href="#ln-922"></a><span class="w">       </span><span class="c">!       eyear = INT(REAL(INT(((timevar(kend)-timevar(1)+dels) &amp;</span>
<a id="ln-923" name="ln-923" href="#ln-923"></a><span class="w">       </span><span class="c">!            /3600.0+shod)/24.0)+sdoy)/365.0)+syear</span>
<a id="ln-924" name="ln-924" href="#ln-924"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-925" name="ln-925" href="#ln-925"></a><span class="w">    </span><span class="c">! IF A CERTAIN PERIOD IS DESIRED AND WE ARE NOT RUNNING ON GSWP DATA or special site</span>
<a id="ln-926" name="ln-926" href="#ln-926"></a><span class="w">    </span><span class="c">! RECALCULATE STARTING AND ENDING INDICES</span>
<a id="ln-927" name="ln-927" href="#ln-927"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="w"> </span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">ncciy</span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-928" name="ln-928" href="#ln-928"></a><span class="w">         </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">MetType</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="s2">&quot;site&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-929" name="ln-929" href="#ln-929"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">syear</span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">eyear</span><span class="p">.</span><span class="n">LE</span><span class="p">.</span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEAREND</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-930" name="ln-930" href="#ln-930"></a><span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="n">syear</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="n">sdoy</span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-931" name="ln-931" href="#ln-931"></a><span class="k">          WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Chosen period doesn&#39;t match dataset period!&quot;</span><span class="w"></span>
<a id="ln-932" name="ln-932" href="#ln-932"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Chosen period: &quot;</span><span class="p">,</span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEAREND</span><span class="p">,</span><span class="mi">365</span><span class="w"></span>
<a id="ln-933" name="ln-933" href="#ln-933"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Data   period: &quot;</span><span class="p">,</span><span class="n">syear</span><span class="p">,</span><span class="n">sdoy</span><span class="p">,</span><span class="w"> </span><span class="n">eyear</span><span class="p">,</span><span class="n">edoy</span><span class="w"></span>
<a id="ln-934" name="ln-934" href="#ln-934"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;For using the metfile&#39;s time set CABLE_USER%YEARSTART = 0 !&quot;</span><span class="w"></span>
<a id="ln-935" name="ln-935" href="#ln-935"></a><span class="w">          </span><span class="k">STOP</span>
<a id="ln-936" name="ln-936" href="#ln-936"></a><span class="k">       ENDIF</span><span class="w"></span>
<a id="ln-937" name="ln-937" href="#ln-937"></a>
<a id="ln-938" name="ln-938" href="#ln-938"></a><span class="w">       </span><span class="c">! Find real kstart!</span>
<a id="ln-939" name="ln-939" href="#ln-939"></a><span class="w">       </span><span class="n">dnsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<a id="ln-940" name="ln-940" href="#ln-940"></a><span class="w">       </span><span class="k">DO </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syear</span><span class="p">,</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<a id="ln-941" name="ln-941" href="#ln-941"></a><span class="w">          </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">365</span><span class="w"></span>
<a id="ln-942" name="ln-942" href="#ln-942"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IS_LEAPYEAR</span><span class="p">(</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">366</span><span class="w"></span>
<a id="ln-943" name="ln-943" href="#ln-943"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="n">syear</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-944" name="ln-944" href="#ln-944"></a><span class="k">             </span><span class="n">dnsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sdoy</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">86400</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">shod</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3600</span><span class="w"></span>
<a id="ln-945" name="ln-945" href="#ln-945"></a><span class="w">          </span><span class="k">ELSE</span>
<a id="ln-946" name="ln-946" href="#ln-946"></a><span class="k">             </span><span class="n">dnsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dnsec</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">86400</span><span class="w"></span>
<a id="ln-947" name="ln-947" href="#ln-947"></a><span class="w">          </span><span class="k">ENDIF</span>
<a id="ln-948" name="ln-948" href="#ln-948"></a><span class="k">       END DO</span>
<a id="ln-949" name="ln-949" href="#ln-949"></a><span class="k">       </span><span class="n">koffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="n">dnsec</span><span class="p">)</span><span class="o">/</span><span class="kt">REAL</span><span class="p">(</span><span class="n">dels</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-950" name="ln-950" href="#ln-950"></a><span class="w">       </span><span class="c">! Find real kend</span>
<a id="ln-951" name="ln-951" href="#ln-951"></a><span class="w">       </span><span class="n">kend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<a id="ln-952" name="ln-952" href="#ln-952"></a><span class="w">       </span><span class="k">DO </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="p">,</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEAREND</span><span class="w"></span>
<a id="ln-953" name="ln-953" href="#ln-953"></a><span class="w">          </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">365</span><span class="w"></span>
<a id="ln-954" name="ln-954" href="#ln-954"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">IS_LEAPYEAR</span><span class="p">(</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">LOY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">366</span><span class="w"></span>
<a id="ln-955" name="ln-955" href="#ln-955"></a><span class="w">          </span><span class="n">kend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">LOY</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8640</span><span class="mf">0.</span><span class="o">/</span><span class="kt">REAL</span><span class="p">(</span><span class="n">dels</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-956" name="ln-956" href="#ln-956"></a><span class="w">       </span><span class="k">END DO</span>
<a id="ln-957" name="ln-957" href="#ln-957"></a><span class="k">    ENDIF</span><span class="w"></span>
<a id="ln-958" name="ln-958" href="#ln-958"></a>
<a id="ln-959" name="ln-959" href="#ln-959"></a><span class="w">    </span><span class="c">! Report finishing time to log file:</span>
<a id="ln-960" name="ln-960" href="#ln-960"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(1X,A12,F5.2,A14,I3,A14,I4,2X,A3,1X,A4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Run ends:   &#39;</span><span class="p">,&amp;</span><span class="w"></span>
<a id="ln-961" name="ln-961" href="#ln-961"></a><span class="w">         </span><span class="n">ehod</span><span class="p">,</span><span class="s1">&#39; hour-of-day, &#39;</span><span class="p">,</span><span class="n">edoy</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-962" name="ln-962" href="#ln-962"></a><span class="w">         </span><span class="s1">&#39; day-of-year, &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">eyear</span><span class="p">,</span><span class="w"> </span><span class="n">time_coord</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;time&#39;</span><span class="w"></span>
<a id="ln-963" name="ln-963" href="#ln-963"></a><span class="w">    </span><span class="c">!!===================^^ End timing details ^^==========================</span>
<a id="ln-964" name="ln-964" href="#ln-964"></a>
<a id="ln-965" name="ln-965" href="#ln-965"></a><span class="w">    </span><span class="c">!!===================VV Look for met variables VV======================</span>
<a id="ln-966" name="ln-966" href="#ln-966"></a><span class="w">    </span><span class="n">all_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! initialise</span>
<a id="ln-967" name="ln-967" href="#ln-967"></a><span class="w">    </span><span class="c">! Look for SWdown (essential):- - - - - - - - - - - - - - - - - -</span>
<a id="ln-968" name="ln-968" href="#ln-968"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_sw</span><span class="w"></span>
<a id="ln-969" name="ln-969" href="#ln-969"></a>
<a id="ln-970" name="ln-970" href="#ln-970"></a><span class="w">   </span><span class="c">! option was added by Chris Lu to allow for different variable names between GPCC and GSWP forcings</span>
<a id="ln-971" name="ln-971" href="#ln-971"></a><span class="w">   </span><span class="c">! added by ypwang 30/oct/2012 </span>
<a id="ln-972" name="ln-972" href="#ln-972"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">SWdownNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">SWdown</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-973" name="ln-973" href="#ln-973"></a>
<a id="ln-974" name="ln-974" href="#ln-974"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-975" name="ln-975" href="#ln-975"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding SWdown in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-976" name="ln-976" href="#ln-976"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-977" name="ln-977" href="#ln-977"></a><span class="w">    </span><span class="c">! Get SWdown units and check okay:</span>
<a id="ln-978" name="ln-978" href="#ln-978"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">SWdown</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">)</span><span class="w"></span>
<a id="ln-979" name="ln-979" href="#ln-979"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-980" name="ln-980" href="#ln-980"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding SWdown units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-981" name="ln-981" href="#ln-981"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-982" name="ln-982" href="#ln-982"></a><span class="w">    </span><span class="c">!! vh_js !! fixed bug in logic</span>
<a id="ln-983" name="ln-983" href="#ln-983"></a><span class="w">    </span><span class="k">IF</span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.(</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;W/m2&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-984" name="ln-984" href="#ln-984"></a><span class="w">         </span><span class="o">/=</span><span class="s1">&#39;W/m^2&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;Wm^-2&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-985" name="ln-985" href="#ln-985"></a><span class="w">         </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;Wm-2&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;W m-2&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-986" name="ln-986" href="#ln-986"></a><span class="k">       WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="w"></span>
<a id="ln-987" name="ln-987" href="#ln-987"></a><span class="w">       </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for SWdown&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-988" name="ln-988" href="#ln-988"></a><span class="w">            </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-989" name="ln-989" href="#ln-989"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-990" name="ln-990" href="#ln-990"></a><span class="w">    </span><span class="c">! Look for Tair (essential):- - - - - - - - - - - - - - - - - - -</span>
<a id="ln-991" name="ln-991" href="#ln-991"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_ta</span><span class="w"></span>
<a id="ln-992" name="ln-992" href="#ln-992"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">TairNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-993" name="ln-993" href="#ln-993"></a>
<a id="ln-994" name="ln-994" href="#ln-994"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-995" name="ln-995" href="#ln-995"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Tair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-996" name="ln-996" href="#ln-996"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-997" name="ln-997" href="#ln-997"></a><span class="w">    </span><span class="c">! Get Tair units and check okay:</span>
<a id="ln-998" name="ln-998" href="#ln-998"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">Tair</span><span class="p">)</span><span class="w"></span>
<a id="ln-999" name="ln-999" href="#ln-999"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1000" name="ln-1000" href="#ln-1000"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Tair units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1001" name="ln-1001" href="#ln-1001"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1002" name="ln-1002" href="#ln-1002"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Tair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Tair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;c&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1003" name="ln-1003" href="#ln-1003"></a><span class="w">       </span><span class="c">! Change from celsius to kelvin:</span>
<a id="ln-1004" name="ln-1004" href="#ln-1004"></a><span class="w">       </span><span class="n">convert</span><span class="p">%</span><span class="n">Tair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tfrz</span><span class="w"></span>
<a id="ln-1005" name="ln-1005" href="#ln-1005"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Temperature will be converted from C to K&#39;</span><span class="w"></span>
<a id="ln-1006" name="ln-1006" href="#ln-1006"></a><span class="w">    </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Tair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;K&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Tair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;k&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1007" name="ln-1007" href="#ln-1007"></a><span class="w">       </span><span class="c">! Units are correct</span>
<a id="ln-1008" name="ln-1008" href="#ln-1008"></a><span class="w">       </span><span class="n">convert</span><span class="p">%</span><span class="n">Tair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-1009" name="ln-1009" href="#ln-1009"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-1010" name="ln-1010" href="#ln-1010"></a><span class="k">       WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">Tair</span><span class="w"></span>
<a id="ln-1011" name="ln-1011" href="#ln-1011"></a><span class="w">       </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for Tair&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1012" name="ln-1012" href="#ln-1012"></a><span class="w">            </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1013" name="ln-1013" href="#ln-1013"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1014" name="ln-1014" href="#ln-1014"></a><span class="w">    </span><span class="c">! Look for Qair (essential):- - - - - - - - - - - - - - - - - - -</span>
<a id="ln-1015" name="ln-1015" href="#ln-1015"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_qa</span><span class="w"></span>
<a id="ln-1016" name="ln-1016" href="#ln-1016"></a><span class="w">    </span><span class="k">Call </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">QairNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1017" name="ln-1017" href="#ln-1017"></a>
<a id="ln-1018" name="ln-1018" href="#ln-1018"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1019" name="ln-1019" href="#ln-1019"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Qair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1020" name="ln-1020" href="#ln-1020"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1021" name="ln-1021" href="#ln-1021"></a><span class="w">    </span><span class="c">! Get Qair units:</span>
<a id="ln-1022" name="ln-1022" href="#ln-1022"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">)</span><span class="w"></span>
<a id="ln-1023" name="ln-1023" href="#ln-1023"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1024" name="ln-1024" href="#ln-1024"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Qair units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1025" name="ln-1025" href="#ln-1025"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1026" name="ln-1026" href="#ln-1026"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;%&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1027" name="ln-1027" href="#ln-1027"></a><span class="w">       </span><span class="c">! Change from relative humidity to specific humidity:</span>
<a id="ln-1028" name="ln-1028" href="#ln-1028"></a><span class="w">       </span><span class="n">convert</span><span class="p">%</span><span class="n">Qair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">99</span><span class="mf">9.0</span><span class="w"></span>
<a id="ln-1029" name="ln-1029" href="#ln-1029"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Humidity will be converted from relative to specific&#39;</span><span class="w"></span>
<a id="ln-1030" name="ln-1030" href="#ln-1030"></a><span class="w">    </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;g/g&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kg/kg&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1031" name="ln-1031" href="#ln-1031"></a><span class="w">         </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;G/G&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;KG/KG&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kg kg-1&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1032" name="ln-1032" href="#ln-1032"></a><span class="w">       </span><span class="c">! Units are correct</span>
<a id="ln-1033" name="ln-1033" href="#ln-1033"></a><span class="w">       </span><span class="n">convert</span><span class="p">%</span><span class="n">Qair</span><span class="o">=</span><span class="mf">1.0</span><span class="w"></span>
<a id="ln-1034" name="ln-1034" href="#ln-1034"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-1035" name="ln-1035" href="#ln-1035"></a><span class="k">       WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">Qair</span><span class="w"></span>
<a id="ln-1036" name="ln-1036" href="#ln-1036"></a><span class="w">       </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for Qair&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1037" name="ln-1037" href="#ln-1037"></a><span class="w">            </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1038" name="ln-1038" href="#ln-1038"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1039" name="ln-1039" href="#ln-1039"></a>
<a id="ln-1040" name="ln-1040" href="#ln-1040"></a><span class="w">    </span><span class="c">! Look for Rainf (essential):- - - - - - - - - - - - - - - - - -</span>
<a id="ln-1041" name="ln-1041" href="#ln-1041"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_rain</span><span class="w"></span>
<a id="ln-1042" name="ln-1042" href="#ln-1042"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">RainNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">Rainf</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1043" name="ln-1043" href="#ln-1043"></a>
<a id="ln-1044" name="ln-1044" href="#ln-1044"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1045" name="ln-1045" href="#ln-1045"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Rainf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1046" name="ln-1046" href="#ln-1046"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1047" name="ln-1047" href="#ln-1047"></a><span class="w">    </span><span class="c">! Get Rainf units:</span>
<a id="ln-1048" name="ln-1048" href="#ln-1048"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Rainf</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">)</span><span class="w"></span>
<a id="ln-1049" name="ln-1049" href="#ln-1049"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1050" name="ln-1050" href="#ln-1050"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Rainf units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1051" name="ln-1051" href="#ln-1051"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1052" name="ln-1052" href="#ln-1052"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kg/m^2/s&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kg/m2s&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span><span class="o">==</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1053" name="ln-1053" href="#ln-1053"></a><span class="w">         </span><span class="s1">&#39;kgm^-2s^-1&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;mm/s&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1054" name="ln-1054" href="#ln-1054"></a><span class="w">         </span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;mms^-1&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1055" name="ln-1055" href="#ln-1055"></a><span class="w">         </span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kg/m^2s&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kg m-2 s-1&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Wind</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;m s-1&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1056" name="ln-1056" href="#ln-1056"></a><span class="w">       </span><span class="c">! Change from mm/s to mm/time step:</span>
<a id="ln-1057" name="ln-1057" href="#ln-1057"></a><span class="w">       </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dels</span><span class="w"></span>
<a id="ln-1058" name="ln-1058" href="#ln-1058"></a><span class="w">    </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;mm/h&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1059" name="ln-1059" href="#ln-1059"></a><span class="w">         </span><span class="s1">&#39;mmh^-1&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1060" name="ln-1060" href="#ln-1060"></a><span class="w">       </span><span class="c">! Change from mm/h to mm/time step:</span>
<a id="ln-1061" name="ln-1061" href="#ln-1061"></a><span class="w">       </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dels</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-1062" name="ln-1062" href="#ln-1062"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-1063" name="ln-1063" href="#ln-1063"></a><span class="k">       WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-1064" name="ln-1064" href="#ln-1064"></a><span class="w">       </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for Rainf&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1065" name="ln-1065" href="#ln-1065"></a><span class="w">            </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1066" name="ln-1066" href="#ln-1066"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1067" name="ln-1067" href="#ln-1067"></a><span class="w">    </span><span class="c">! Multiply acceptable Rainf ranges by time step size:</span>
<a id="ln-1068" name="ln-1068" href="#ln-1068"></a><span class="w">    </span><span class="c">!ranges%Rainf = ranges%Rainf*dels ! range therefore depends on dels ! vh ! why has this been commented out?</span>
<a id="ln-1069" name="ln-1069" href="#ln-1069"></a><span class="w">    </span><span class="n">ranges</span><span class="p">%</span><span class="n">Rainf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ranges</span><span class="p">%</span><span class="n">Rainf</span><span class="o">*</span><span class="n">dels</span><span class="w"> </span><span class="c">! range therefore depends on dels</span>
<a id="ln-1070" name="ln-1070" href="#ln-1070"></a><span class="w">    </span><span class="c">! Look for Wind (essential):- - - - - - - - - - - - - - - - - - -</span>
<a id="ln-1071" name="ln-1071" href="#ln-1071"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_wd</span><span class="w"></span>
<a id="ln-1072" name="ln-1072" href="#ln-1072"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">WindNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1073" name="ln-1073" href="#ln-1073"></a>
<a id="ln-1074" name="ln-1074" href="#ln-1074"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1075" name="ln-1075" href="#ln-1075"></a><span class="w">       </span><span class="c">! Look for vector wind:</span>
<a id="ln-1076" name="ln-1076" href="#ln-1076"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;Wind_N&#39;</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">)</span><span class="w"></span>
<a id="ln-1077" name="ln-1077" href="#ln-1077"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1078" name="ln-1078" href="#ln-1078"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Wind_N in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1079" name="ln-1079" href="#ln-1079"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1080" name="ln-1080" href="#ln-1080"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;Wind_E&#39;</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind_E</span><span class="p">)</span><span class="w"></span>
<a id="ln-1081" name="ln-1081" href="#ln-1081"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1082" name="ln-1082" href="#ln-1082"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Wind_E in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1083" name="ln-1083" href="#ln-1083"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1084" name="ln-1084" href="#ln-1084"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">Wind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! Use vector wind when reading met</span>
<a id="ln-1085" name="ln-1085" href="#ln-1085"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-1086" name="ln-1086" href="#ln-1086"></a><span class="k">       </span><span class="n">exists</span><span class="p">%</span><span class="n">Wind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! &#39;Wind&#39; variable exists</span>
<a id="ln-1087" name="ln-1087" href="#ln-1087"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1088" name="ln-1088" href="#ln-1088"></a>
<a id="ln-1089" name="ln-1089" href="#ln-1089"></a><span class="w">    </span><span class="c">! The following does not work with vector winds. Do we want to keep</span>
<a id="ln-1090" name="ln-1090" href="#ln-1090"></a><span class="w">    </span><span class="c">! vector winds?</span>
<a id="ln-1091" name="ln-1091" href="#ln-1091"></a><span class="w">    </span><span class="c">! Get Wind units:</span>
<a id="ln-1092" name="ln-1092" href="#ln-1092"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">Wind</span><span class="p">)</span><span class="w"></span>
<a id="ln-1093" name="ln-1093" href="#ln-1093"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1094" name="ln-1094" href="#ln-1094"></a><span class="w">         </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Wind units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1095" name="ln-1095" href="#ln-1095"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1096" name="ln-1096" href="#ln-1096"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Wind</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;m/s&#39;</span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Wind</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;ms&#39;</span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Wind</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;m s-1&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1097" name="ln-1097" href="#ln-1097"></a><span class="k">       WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">Wind</span><span class="w"></span>
<a id="ln-1098" name="ln-1098" href="#ln-1098"></a><span class="w">       </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for Wind&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1099" name="ln-1099" href="#ln-1099"></a><span class="w">            </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1100" name="ln-1100" href="#ln-1100"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1101" name="ln-1101" href="#ln-1101"></a><span class="w">    </span><span class="c">! Now &quot;optional&quot; variables:</span>
<a id="ln-1102" name="ln-1102" href="#ln-1102"></a><span class="w">    </span><span class="c">! Look for LWdown (can be synthesised):- - - - - - - - - - - - - - -</span>
<a id="ln-1103" name="ln-1103" href="#ln-1103"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_lw</span><span class="w"></span>
<a id="ln-1104" name="ln-1104" href="#ln-1104"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">LWdownNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">LWdown</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1105" name="ln-1105" href="#ln-1105"></a>
<a id="ln-1106" name="ln-1106" href="#ln-1106"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay</span>
<a id="ln-1107" name="ln-1107" href="#ln-1107"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">LWdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! LWdown is present in met file</span>
<a id="ln-1108" name="ln-1108" href="#ln-1108"></a><span class="w">       </span><span class="c">! Get LWdown units and check okay:</span>
<a id="ln-1109" name="ln-1109" href="#ln-1109"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LWdown</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">LWdown</span><span class="p">)</span><span class="w"></span>
<a id="ln-1110" name="ln-1110" href="#ln-1110"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1111" name="ln-1111" href="#ln-1111"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding LWdown units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1112" name="ln-1112" href="#ln-1112"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1113" name="ln-1113" href="#ln-1113"></a><span class="w">       </span><span class="c">!! vh_js !! fixed bug in logic</span>
<a id="ln-1114" name="ln-1114" href="#ln-1114"></a><span class="c">!!$       IF(metunits%LWdown(1:4)/=&#39;W/m2&#39;.AND.metunits%LWdown(1:5) &amp;</span>
<a id="ln-1115" name="ln-1115" href="#ln-1115"></a><span class="c">!!$            /=&#39;W/m^2&#39;.AND.metunits%LWdown(1:5)/=&#39;Wm^-2&#39; &amp;</span>
<a id="ln-1116" name="ln-1116" href="#ln-1116"></a><span class="c">!!$            .AND.metunits%LWdown(1:4)/=&#39;Wm-2&#39;) THEN</span>
<a id="ln-1117" name="ln-1117" href="#ln-1117"></a><span class="w">       </span><span class="k">IF</span><span class="p">(.</span><span class="nb">NOT</span><span class="p">.(</span><span class="n">metunits</span><span class="p">%</span><span class="n">LWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;W/m2&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">LWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1118" name="ln-1118" href="#ln-1118"></a><span class="w">            </span><span class="o">/=</span><span class="s1">&#39;W/m^2&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">LWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;Wm^-2&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1119" name="ln-1119" href="#ln-1119"></a><span class="w">            </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">LWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;Wm-2&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s1">&#39;W m-2&#39;</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1120" name="ln-1120" href="#ln-1120"></a>
<a id="ln-1121" name="ln-1121" href="#ln-1121"></a><span class="k">          WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">LWdown</span><span class="w"></span>
<a id="ln-1122" name="ln-1122" href="#ln-1122"></a><span class="w">          </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for LWdown&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1123" name="ln-1123" href="#ln-1123"></a><span class="w">               </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1124" name="ln-1124" href="#ln-1124"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1125" name="ln-1125" href="#ln-1125"></a><span class="k">    ELSE</span>
<a id="ln-1126" name="ln-1126" href="#ln-1126"></a><span class="k">       </span><span class="n">exists</span><span class="p">%</span><span class="n">LWdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! LWdown is not present in met file</span>
<a id="ln-1127" name="ln-1127" href="#ln-1127"></a><span class="w">       </span><span class="n">all_met</span><span class="o">=</span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! not all met variables are present in file</span>
<a id="ln-1128" name="ln-1128" href="#ln-1128"></a><span class="w">       </span><span class="c">! Note this in log file:</span>
<a id="ln-1129" name="ln-1129" href="#ln-1129"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;LWdown not present in met file; &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1130" name="ln-1130" href="#ln-1130"></a><span class="w">            </span><span class="s1">&#39;values will be synthesised based on air temperature.&#39;</span><span class="w"></span>
<a id="ln-1131" name="ln-1131" href="#ln-1131"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1132" name="ln-1132" href="#ln-1132"></a><span class="w">    </span><span class="c">! Look for PSurf (can be synthesised):- - - - - - - - - - - - - - - -</span>
<a id="ln-1133" name="ln-1133" href="#ln-1133"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_ps</span><span class="w"></span>
<a id="ln-1134" name="ln-1134" href="#ln-1134"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">PSurfNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1135" name="ln-1135" href="#ln-1135"></a>
<a id="ln-1136" name="ln-1136" href="#ln-1136"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay</span>
<a id="ln-1137" name="ln-1137" href="#ln-1137"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">PSurf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! PSurf is present in met file</span>
<a id="ln-1138" name="ln-1138" href="#ln-1138"></a><span class="w">       </span><span class="c">! Get PSurf units and check:</span>
<a id="ln-1139" name="ln-1139" href="#ln-1139"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">)</span><span class="w"></span>
<a id="ln-1140" name="ln-1140" href="#ln-1140"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1141" name="ln-1141" href="#ln-1141"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding PSurf units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1142" name="ln-1142" href="#ln-1142"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1143" name="ln-1143" href="#ln-1143"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Pa&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;pa&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1144" name="ln-1144" href="#ln-1144"></a><span class="w">            </span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;PA&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1145" name="ln-1145" href="#ln-1145"></a><span class="w">          </span><span class="c">! Change from pa to mbar (cable uses mbar):</span>
<a id="ln-1146" name="ln-1146" href="#ln-1146"></a><span class="w">          </span><span class="n">convert</span><span class="p">%</span><span class="n">PSurf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="w"></span>
<a id="ln-1147" name="ln-1147" href="#ln-1147"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Pressure will be converted from Pa to mb&#39;</span><span class="w"></span>
<a id="ln-1148" name="ln-1148" href="#ln-1148"></a><span class="w">       </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;KP&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kP&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1149" name="ln-1149" href="#ln-1149"></a><span class="w">            </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Kp&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;kp&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1150" name="ln-1150" href="#ln-1150"></a><span class="w">          </span><span class="c">! convert from kPa to mb</span>
<a id="ln-1151" name="ln-1151" href="#ln-1151"></a><span class="w">          </span><span class="n">convert</span><span class="p">%</span><span class="n">PSurf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-1152" name="ln-1152" href="#ln-1152"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Pressure will be converted from kPa to mb&#39;</span><span class="w"></span>
<a id="ln-1153" name="ln-1153" href="#ln-1153"></a><span class="w">       </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;MB&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;mB&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1154" name="ln-1154" href="#ln-1154"></a><span class="w">            </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;Mb&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;mb&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1155" name="ln-1155" href="#ln-1155"></a><span class="w">          </span><span class="c">! Units are correct</span>
<a id="ln-1156" name="ln-1156" href="#ln-1156"></a><span class="w">          </span><span class="n">convert</span><span class="p">%</span><span class="n">PSurf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>
<a id="ln-1157" name="ln-1157" href="#ln-1157"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-1158" name="ln-1158" href="#ln-1158"></a><span class="k">          WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">PSurf</span><span class="w"></span>
<a id="ln-1159" name="ln-1159" href="#ln-1159"></a><span class="w">          </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for PSurf&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1160" name="ln-1160" href="#ln-1160"></a><span class="w">               </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1161" name="ln-1161" href="#ln-1161"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1162" name="ln-1162" href="#ln-1162"></a><span class="k">    ELSE</span><span class="w"> </span><span class="c">! If PSurf not present</span>
<a id="ln-1163" name="ln-1163" href="#ln-1163"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">PSurf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! PSurf is not present in met file</span>
<a id="ln-1164" name="ln-1164" href="#ln-1164"></a><span class="w">       </span><span class="n">all_met</span><span class="o">=</span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! not all met variables are present in file</span>
<a id="ln-1165" name="ln-1165" href="#ln-1165"></a><span class="w">       </span><span class="c">! Look for &quot;elevation&quot; variable to approximate pressure based</span>
<a id="ln-1166" name="ln-1166" href="#ln-1166"></a><span class="w">       </span><span class="c">! on elevation and temperature:</span>
<a id="ln-1167" name="ln-1167" href="#ln-1167"></a><span class="w">       </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">ElevNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">Elev</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1168" name="ln-1168" href="#ln-1168"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! elevation present</span>
<a id="ln-1169" name="ln-1169" href="#ln-1169"></a><span class="w">          </span><span class="c">! Get elevation units:</span>
<a id="ln-1170" name="ln-1170" href="#ln-1170"></a><span class="w">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Elev</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">Elev</span><span class="p">)</span><span class="w"></span>
<a id="ln-1171" name="ln-1171" href="#ln-1171"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1172" name="ln-1172" href="#ln-1172"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding elevation units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1173" name="ln-1173" href="#ln-1173"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1174" name="ln-1174" href="#ln-1174"></a><span class="w">          </span><span class="c">! Units should be metres or feet:</span>
<a id="ln-1175" name="ln-1175" href="#ln-1175"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Elev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;m&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Elev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;M&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1176" name="ln-1176" href="#ln-1176"></a><span class="w">             </span><span class="c">! This is the expected unit - metres</span>
<a id="ln-1177" name="ln-1177" href="#ln-1177"></a><span class="w">             </span><span class="n">convert</span><span class="p">%</span><span class="n">Elev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"></span>
<a id="ln-1178" name="ln-1178" href="#ln-1178"></a><span class="w">          </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Elev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;f&#39;</span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="n">metunits</span><span class="p">%</span><span class="n">Elev</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;F&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1179" name="ln-1179" href="#ln-1179"></a><span class="w">             </span><span class="c">! Convert from feet to metres:</span>
<a id="ln-1180" name="ln-1180" href="#ln-1180"></a><span class="w">             </span><span class="n">convert</span><span class="p">%</span><span class="n">Elev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.3048</span><span class="w"></span>
<a id="ln-1181" name="ln-1181" href="#ln-1181"></a><span class="w">          </span><span class="k">ELSE</span>
<a id="ln-1182" name="ln-1182" href="#ln-1182"></a><span class="k">             CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for Elevation&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1183" name="ln-1183" href="#ln-1183"></a><span class="w">                  </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1184" name="ln-1184" href="#ln-1184"></a><span class="w">          </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1185" name="ln-1185" href="#ln-1185"></a><span class="w">          </span><span class="c">! Allocate space for elevation variable:</span>
<a id="ln-1186" name="ln-1186" href="#ln-1186"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">elevation</span><span class="p">(</span><span class="n">mland</span><span class="p">))</span><span class="w"></span>
<a id="ln-1187" name="ln-1187" href="#ln-1187"></a><span class="w">          </span><span class="c">! Get site elevations:</span>
<a id="ln-1188" name="ln-1188" href="#ln-1188"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1189" name="ln-1189" href="#ln-1189"></a><span class="k">             DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1190" name="ln-1190" href="#ln-1190"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Elev</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1191" name="ln-1191" href="#ln-1191"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1192" name="ln-1192" href="#ln-1192"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1193" name="ln-1193" href="#ln-1193"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading elevation in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1194" name="ln-1194" href="#ln-1194"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1195" name="ln-1195" href="#ln-1195"></a><span class="w">                </span><span class="n">elevation</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">REAL</span><span class="p">(</span><span class="n">data2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">convert</span><span class="p">%</span><span class="n">Elev</span><span class="w"></span>
<a id="ln-1196" name="ln-1196" href="#ln-1196"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1197" name="ln-1197" href="#ln-1197"></a><span class="k">          ELSE IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;land&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1198" name="ln-1198" href="#ln-1198"></a><span class="w">             </span><span class="c">! Collect data from land only grid in netcdf file:</span>
<a id="ln-1199" name="ln-1199" href="#ln-1199"></a><span class="w">             </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Elev</span><span class="p">,</span><span class="n">data1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1200" name="ln-1200" href="#ln-1200"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1201" name="ln-1201" href="#ln-1201"></a><span class="w">                  </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading elevation in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1202" name="ln-1202" href="#ln-1202"></a><span class="w">                  </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1203" name="ln-1203" href="#ln-1203"></a><span class="w">             </span><span class="n">elevation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Elev</span><span class="w"></span>
<a id="ln-1204" name="ln-1204" href="#ln-1204"></a><span class="w">          </span><span class="k">END IF</span>
<a id="ln-1205" name="ln-1205" href="#ln-1205"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! If both PSurf and elevation aren&#39;t present, abort:</span>
<a id="ln-1206" name="ln-1206" href="#ln-1206"></a><span class="w">          </span><span class="k">CALL </span><span class="nb">abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1207" name="ln-1207" href="#ln-1207"></a><span class="w">               </span><span class="p">(</span><span class="s1">&#39;Error finding PSurf or Elevation in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1208" name="ln-1208" href="#ln-1208"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1209" name="ln-1209" href="#ln-1209"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1210" name="ln-1210" href="#ln-1210"></a><span class="w">       </span><span class="c">! Note static pressure based on elevation in log file:</span>
<a id="ln-1211" name="ln-1211" href="#ln-1211"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;PSurf not present in met file; values will be &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1212" name="ln-1212" href="#ln-1212"></a><span class="w">            </span><span class="s1">&#39;synthesised based on elevation and temperature.&#39;</span><span class="w"></span>
<a id="ln-1213" name="ln-1213" href="#ln-1213"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1214" name="ln-1214" href="#ln-1214"></a><span class="w">    </span><span class="c">! Look for CO2air (can be assumed to be static):- - - - - - - - - - -</span>
<a id="ln-1215" name="ln-1215" href="#ln-1215"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">CO2Names</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">CO2air</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1216" name="ln-1216" href="#ln-1216"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay</span>
<a id="ln-1217" name="ln-1217" href="#ln-1217"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">CO2air</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! CO2air is present in met file</span>
<a id="ln-1218" name="ln-1218" href="#ln-1218"></a><span class="w">       </span><span class="c">! Get CO2air units:</span>
<a id="ln-1219" name="ln-1219" href="#ln-1219"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">CO2air</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">CO2air</span><span class="p">)</span><span class="w"></span>
<a id="ln-1220" name="ln-1220" href="#ln-1220"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1221" name="ln-1221" href="#ln-1221"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding CO2air units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1222" name="ln-1222" href="#ln-1222"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1223" name="ln-1223" href="#ln-1223"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">CO2air</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;ppm&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1224" name="ln-1224" href="#ln-1224"></a><span class="k">          WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">metunits</span><span class="p">%</span><span class="n">CO2air</span><span class="w"></span>
<a id="ln-1225" name="ln-1225" href="#ln-1225"></a><span class="w">          </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown units for CO2air&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1226" name="ln-1226" href="#ln-1226"></a><span class="w">               </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1227" name="ln-1227" href="#ln-1227"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1228" name="ln-1228" href="#ln-1228"></a><span class="k">    ELSE</span><span class="w"> </span><span class="c">! CO2 not present</span>
<a id="ln-1229" name="ln-1229" href="#ln-1229"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">CO2air</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! CO2air is not present in met file</span>
<a id="ln-1230" name="ln-1230" href="#ln-1230"></a><span class="w">       </span><span class="n">all_met</span><span class="o">=</span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! not all met variables are present in file</span>
<a id="ln-1231" name="ln-1231" href="#ln-1231"></a><span class="w">       </span><span class="c">! Note this in log file:</span>
<a id="ln-1232" name="ln-1232" href="#ln-1232"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="s1">&#39;(A33,A24,I4,A5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; CO2air not present in met file; &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1233" name="ln-1233" href="#ln-1233"></a><span class="w">            </span><span class="s1">&#39;values will be fixed at &#39;</span><span class="p">,</span><span class="nb">INT</span><span class="p">(</span><span class="n">fixedCO2</span><span class="p">),</span><span class="s1">&#39; ppmv&#39;</span><span class="w"></span>
<a id="ln-1234" name="ln-1234" href="#ln-1234"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1235" name="ln-1235" href="#ln-1235"></a><span class="w">    </span><span class="c">! Look for Snowf (could be part of Rainf variable):- - - - - - - - - -</span>
<a id="ln-1236" name="ln-1236" href="#ln-1236"></a><span class="w">    </span><span class="c">!IF (ncciy &gt; 0 .AND. (globalMetfile%l_gpcc .OR. globalMetfile%l_gswp .OR. globalMetfile%l_ncar))Then</span>
<a id="ln-1237" name="ln-1237" href="#ln-1237"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_gswp</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">globalMetfile</span><span class="p">%</span><span class="n">l_ncar</span><span class="p">))</span><span class="k">Then</span>
<a id="ln-1238" name="ln-1238" href="#ln-1238"></a><span class="k">       </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_snow</span><span class="w"></span>
<a id="ln-1239" name="ln-1239" href="#ln-1239"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-1240" name="ln-1240" href="#ln-1240"></a>
<a id="ln-1241" name="ln-1241" href="#ln-1241"></a><span class="k">    CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">SnowNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">Snowf</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1242" name="ln-1242" href="#ln-1242"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay</span>
<a id="ln-1243" name="ln-1243" href="#ln-1243"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! Snowf is present in met file</span>
<a id="ln-1244" name="ln-1244" href="#ln-1244"></a><span class="w">       </span><span class="c">! Get Snowf units:</span>
<a id="ln-1245" name="ln-1245" href="#ln-1245"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Snowf</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"></span>
<a id="ln-1246" name="ln-1246" href="#ln-1246"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1247" name="ln-1247" href="#ln-1247"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding Snowf units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1248" name="ln-1248" href="#ln-1248"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1249" name="ln-1249" href="#ln-1249"></a><span class="w">       </span><span class="c">! Make sure Snowf units are the same as Rainf units:</span>
<a id="ln-1250" name="ln-1250" href="#ln-1250"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">Rainf</span><span class="o">/=</span><span class="n">metunits</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="nb">abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1251" name="ln-1251" href="#ln-1251"></a><span class="w">            </span><span class="p">(</span><span class="s1">&#39;Please ensure Rainf and Snowf units are the same&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1252" name="ln-1252" href="#ln-1252"></a><span class="w">            </span><span class="s1">&#39; in &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1253" name="ln-1253" href="#ln-1253"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-1254" name="ln-1254" href="#ln-1254"></a><span class="k">       </span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! Snowf is not present in met file</span>
<a id="ln-1255" name="ln-1255" href="#ln-1255"></a><span class="w">       </span><span class="c">!  all_met=.FALSE. not required; Snowf assumed to be in Rainf</span>
<a id="ln-1256" name="ln-1256" href="#ln-1256"></a><span class="w">       </span><span class="c">! Note this in log file:</span>
<a id="ln-1257" name="ln-1257" href="#ln-1257"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Snowf not present in met file; &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1258" name="ln-1258" href="#ln-1258"></a><span class="w">            </span><span class="s1">&#39;Assumed to be contained in Rainf variable&#39;</span><span class="w"></span>
<a id="ln-1259" name="ln-1259" href="#ln-1259"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1260" name="ln-1260" href="#ln-1260"></a><span class="w">    </span><span class="c">! Look for LAI - - - - - - - - - - - - - - - - - - - - - - - - -</span>
<a id="ln-1261" name="ln-1261" href="#ln-1261"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">LAINames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1262" name="ln-1262" href="#ln-1262"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay</span>
<a id="ln-1263" name="ln-1263" href="#ln-1263"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! LAI is present in met file</span>
<a id="ln-1264" name="ln-1264" href="#ln-1264"></a><span class="w">       </span><span class="c">! LAI will be read in which ever land grid is used</span>
<a id="ln-1265" name="ln-1265" href="#ln-1265"></a><span class="w">       </span><span class="c">! Check dimension of LAI variable:</span>
<a id="ln-1266" name="ln-1266" href="#ln-1266"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1267" name="ln-1267" href="#ln-1267"></a><span class="w">            </span><span class="n">ndims</span><span class="o">=</span><span class="n">lai_dims</span><span class="p">,</span><span class="n">dimids</span><span class="o">=</span><span class="n">laidimids</span><span class="p">)</span><span class="w"></span>
<a id="ln-1268" name="ln-1268" href="#ln-1268"></a><span class="w">       </span><span class="c">! If any of LAI&#39;s dimensions are the time dimension</span>
<a id="ln-1269" name="ln-1269" href="#ln-1269"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">laidimids</span><span class="o">==</span><span class="n">timedimID</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1270" name="ln-1270" href="#ln-1270"></a><span class="k">          </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! i.e. time varying LAI</span>
<a id="ln-1271" name="ln-1271" href="#ln-1271"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;LAI found in met file - time dependent;&#39;</span><span class="w"></span>
<a id="ln-1272" name="ln-1272" href="#ln-1272"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-1273" name="ln-1273" href="#ln-1273"></a><span class="k">          </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! i.e. not time varying LAI</span>
<a id="ln-1274" name="ln-1274" href="#ln-1274"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1275" name="ln-1275" href="#ln-1275"></a><span class="k">       IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">laidimids</span><span class="o">==</span><span class="n">monthlydimID</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1276" name="ln-1276" href="#ln-1276"></a><span class="k">          </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! i.e. time varying LAI, but monthly only</span>
<a id="ln-1277" name="ln-1277" href="#ln-1277"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;LAI found in met file - monthly values;&#39;</span><span class="w"></span>
<a id="ln-1278" name="ln-1278" href="#ln-1278"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-1279" name="ln-1279" href="#ln-1279"></a><span class="k">          </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"></span>
<a id="ln-1280" name="ln-1280" href="#ln-1280"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1281" name="ln-1281" href="#ln-1281"></a><span class="k">       IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">laidimids</span><span class="o">==</span><span class="n">patchdimID</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1282" name="ln-1282" href="#ln-1282"></a><span class="k">          </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! i.e. patch varying LAI</span>
<a id="ln-1283" name="ln-1283" href="#ln-1283"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;LAI found in met file - patch-specific values&#39;</span><span class="w"></span>
<a id="ln-1284" name="ln-1284" href="#ln-1284"></a><span class="w">       </span><span class="k">ELSE</span>
<a id="ln-1285" name="ln-1285" href="#ln-1285"></a><span class="k">          </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! i.e. not patch varying LAI</span>
<a id="ln-1286" name="ln-1286" href="#ln-1286"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1287" name="ln-1287" href="#ln-1287"></a><span class="k">    ELSE</span>
<a id="ln-1288" name="ln-1288" href="#ln-1288"></a><span class="k">       </span><span class="n">exists</span><span class="p">%</span><span class="n">LAI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! LAI is not present in met file</span>
<a id="ln-1289" name="ln-1289" href="#ln-1289"></a><span class="w">       </span><span class="c">! Report to log file</span>
<a id="ln-1290" name="ln-1290" href="#ln-1290"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;LAI not present in met file; &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1291" name="ln-1291" href="#ln-1291"></a><span class="w">            </span><span class="s1">&#39;Will use MODIS coarse grid monthly LAI&#39;</span><span class="w"></span>
<a id="ln-1292" name="ln-1292" href="#ln-1292"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1293" name="ln-1293" href="#ln-1293"></a><span class="w">    </span><span class="c">! If a spinup is to be performed:</span>
<a id="ln-1294" name="ln-1294" href="#ln-1294"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">spinup</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1295" name="ln-1295" href="#ln-1295"></a><span class="w">       </span><span class="c">! Look for avPrecip variable (time invariant - used for spinup):</span>
<a id="ln-1296" name="ln-1296" href="#ln-1296"></a><span class="w">       </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">APrecipNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1297" name="ln-1297" href="#ln-1297"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay and avPrecip exists</span>
<a id="ln-1298" name="ln-1298" href="#ln-1298"></a><span class="w">          </span><span class="c">! Report to log file than modified spinup will be used:</span>
<a id="ln-1299" name="ln-1299" href="#ln-1299"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Spinup will use modified precip - avPrecip variable found&#39;</span><span class="w"></span>
<a id="ln-1300" name="ln-1300" href="#ln-1300"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  precip will be rescaled to match these values during spinup:&#39;</span><span class="w"></span>
<a id="ln-1301" name="ln-1301" href="#ln-1301"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Spinup will use modified precip - avPrecip variable found&#39;</span><span class="w"></span>
<a id="ln-1302" name="ln-1302" href="#ln-1302"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  precip will be rescaled to match these values during spinup&#39;</span><span class="w"></span>
<a id="ln-1303" name="ln-1303" href="#ln-1303"></a><span class="w">          </span><span class="c">! Spinup will modify precip values:</span>
<a id="ln-1304" name="ln-1304" href="#ln-1304"></a><span class="w">          </span><span class="n">exists</span><span class="p">%</span><span class="n">avPrecip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-1305" name="ln-1305" href="#ln-1305"></a><span class="w">          </span><span class="c">! Get avPrecip units:</span>
<a id="ln-1306" name="ln-1306" href="#ln-1306"></a><span class="w">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_ATT</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">,</span><span class="n">metunits</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">)</span><span class="w"></span>
<a id="ln-1307" name="ln-1307" href="#ln-1307"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1308" name="ln-1308" href="#ln-1308"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding avPrecip units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1309" name="ln-1309" href="#ln-1309"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1310" name="ln-1310" href="#ln-1310"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">metunits</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span><span class="o">/=</span><span class="s1">&#39;mm&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1311" name="ln-1311" href="#ln-1311"></a><span class="w">               </span><span class="s1">&#39;Unknown avPrecip units in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1312" name="ln-1312" href="#ln-1312"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1313" name="ln-1313" href="#ln-1313"></a><span class="w">          </span><span class="c">! Allocate space for avPrecip variable:</span>
<a id="ln-1314" name="ln-1314" href="#ln-1314"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">avPrecip</span><span class="p">(</span><span class="n">mland</span><span class="p">))</span><span class="w"></span>
<a id="ln-1315" name="ln-1315" href="#ln-1315"></a><span class="w">          </span><span class="c">! Get avPrecip from met file:</span>
<a id="ln-1316" name="ln-1316" href="#ln-1316"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1317" name="ln-1317" href="#ln-1317"></a><span class="k">             DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1318" name="ln-1318" href="#ln-1318"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1319" name="ln-1319" href="#ln-1319"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1320" name="ln-1320" href="#ln-1320"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1321" name="ln-1321" href="#ln-1321"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading avPrecip in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1322" name="ln-1322" href="#ln-1322"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1323" name="ln-1323" href="#ln-1323"></a><span class="w">                </span><span class="n">avPrecip</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">REAL</span><span class="p">(</span><span class="n">data2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1324" name="ln-1324" href="#ln-1324"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1325" name="ln-1325" href="#ln-1325"></a><span class="k">          ELSE IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;land&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1326" name="ln-1326" href="#ln-1326"></a><span class="w">             </span><span class="c">! Allocate single preciaion temporary variable:</span>
<a id="ln-1327" name="ln-1327" href="#ln-1327"></a><span class="w">             </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">(</span><span class="n">mland</span><span class="p">))</span><span class="w"></span>
<a id="ln-1328" name="ln-1328" href="#ln-1328"></a><span class="w">             </span><span class="c">! Collect data from land only grid in netcdf file:</span>
<a id="ln-1329" name="ln-1329" href="#ln-1329"></a><span class="w">             </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">,</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1330" name="ln-1330" href="#ln-1330"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1331" name="ln-1331" href="#ln-1331"></a><span class="w">                  </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading avPrecip in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1332" name="ln-1332" href="#ln-1332"></a><span class="w">                  </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1333" name="ln-1333" href="#ln-1333"></a><span class="w">             </span><span class="c">! Needed since r_1 will be double precision with -r8:</span>
<a id="ln-1334" name="ln-1334" href="#ln-1334"></a><span class="w">             </span><span class="n">avPrecip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1335" name="ln-1335" href="#ln-1335"></a><span class="w">             </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">temparray1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1336" name="ln-1336" href="#ln-1336"></a><span class="w">          </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1337" name="ln-1337" href="#ln-1337"></a><span class="w">          </span><span class="c">! Now find average precip from met data, and create rescaling</span>
<a id="ln-1338" name="ln-1338" href="#ln-1338"></a><span class="w">          </span><span class="c">! factor for spinup:</span>
<a id="ln-1339" name="ln-1339" href="#ln-1339"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">PrecipScale</span><span class="p">(</span><span class="n">mland</span><span class="p">))</span><span class="w"></span>
<a id="ln-1340" name="ln-1340" href="#ln-1340"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1341" name="ln-1341" href="#ln-1341"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1342" name="ln-1342" href="#ln-1342"></a><span class="w">                </span><span class="c">! Allocate space for temporary precip variable:</span>
<a id="ln-1343" name="ln-1343" href="#ln-1343"></a><span class="w">                </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tempPrecip3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">kend</span><span class="p">))</span><span class="w"></span>
<a id="ln-1344" name="ln-1344" href="#ln-1344"></a><span class="w">                </span><span class="c">! Get all data for this grid cell:</span>
<a id="ln-1345" name="ln-1345" href="#ln-1345"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Rainf</span><span class="p">,</span><span class="n">tempPrecip3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1346" name="ln-1346" href="#ln-1346"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="o">+</span><span class="n">koffset</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">kend</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1347" name="ln-1347" href="#ln-1347"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1348" name="ln-1348" href="#ln-1348"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Rainf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1349" name="ln-1349" href="#ln-1349"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1350" name="ln-1350" href="#ln-1350"></a><span class="w">                </span><span class="c">! Store total Rainf for this grid cell:</span>
<a id="ln-1351" name="ln-1351" href="#ln-1351"></a><span class="w">                </span><span class="n">PrecipTot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="n">tempPrecip3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1352" name="ln-1352" href="#ln-1352"></a><span class="w">                     </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-1353" name="ln-1353" href="#ln-1353"></a><span class="w">                </span><span class="c">! Get snowfall data for this grid cell:</span>
<a id="ln-1354" name="ln-1354" href="#ln-1354"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1355" name="ln-1355" href="#ln-1355"></a><span class="k">                   </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Snowf</span><span class="p">,</span><span class="n">tempPrecip3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1356" name="ln-1356" href="#ln-1356"></a><span class="w">                        </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="o">+</span><span class="n">koffset</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">kend</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1357" name="ln-1357" href="#ln-1357"></a><span class="w">                   </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1358" name="ln-1358" href="#ln-1358"></a><span class="w">                        </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Snowf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1359" name="ln-1359" href="#ln-1359"></a><span class="w">                        </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1360" name="ln-1360" href="#ln-1360"></a><span class="w">                   </span><span class="c">! Add total Snowf to this grid cell total:</span>
<a id="ln-1361" name="ln-1361" href="#ln-1361"></a><span class="w">                   </span><span class="n">PrecipTot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PrecipTot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1362" name="ln-1362" href="#ln-1362"></a><span class="w">                        </span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="n">tempPrecip3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1363" name="ln-1363" href="#ln-1363"></a><span class="w">                        </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="p">)</span><span class="w"></span>
<a id="ln-1364" name="ln-1364" href="#ln-1364"></a><span class="w">                </span><span class="k">END IF</span>
<a id="ln-1365" name="ln-1365" href="#ln-1365"></a><span class="k">                DEALLOCATE</span><span class="p">(</span><span class="n">tempPrecip3</span><span class="p">)</span><span class="w"></span>
<a id="ln-1366" name="ln-1366" href="#ln-1366"></a><span class="w">             </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;land&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1367" name="ln-1367" href="#ln-1367"></a><span class="w">                </span><span class="c">! Allocate space for temporary precip variable:</span>
<a id="ln-1368" name="ln-1368" href="#ln-1368"></a><span class="w">                </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tempPrecip2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">kend</span><span class="p">))</span><span class="w"></span>
<a id="ln-1369" name="ln-1369" href="#ln-1369"></a><span class="w">                </span><span class="c">! Get rainfall data for this land grid cell:</span>
<a id="ln-1370" name="ln-1370" href="#ln-1370"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Rainf</span><span class="p">,</span><span class="n">tempPrecip2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1371" name="ln-1371" href="#ln-1371"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">koffset</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">kend</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1372" name="ln-1372" href="#ln-1372"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1373" name="ln-1373" href="#ln-1373"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Rainf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1374" name="ln-1374" href="#ln-1374"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1375" name="ln-1375" href="#ln-1375"></a><span class="w">                </span><span class="c">! Store total Rainf for this land grid cell:</span>
<a id="ln-1376" name="ln-1376" href="#ln-1376"></a><span class="w">                </span><span class="n">PrecipTot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="n">tempPrecip2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">*</span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-1377" name="ln-1377" href="#ln-1377"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1378" name="ln-1378" href="#ln-1378"></a><span class="k">                   </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Snowf</span><span class="p">,</span><span class="n">tempPrecip2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1379" name="ln-1379" href="#ln-1379"></a><span class="w">                        </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="n">koffset</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">kend</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1380" name="ln-1380" href="#ln-1380"></a><span class="w">                   </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1381" name="ln-1381" href="#ln-1381"></a><span class="w">                        </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Snowf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1382" name="ln-1382" href="#ln-1382"></a><span class="w">                        </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1383" name="ln-1383" href="#ln-1383"></a><span class="w">                   </span><span class="c">! Add total Snowf to this land grid cell total:</span>
<a id="ln-1384" name="ln-1384" href="#ln-1384"></a><span class="w">                   </span><span class="n">PrecipTot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PrecipTot</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="nb">SUM</span><span class="p">(</span><span class="n">tempPrecip2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1385" name="ln-1385" href="#ln-1385"></a><span class="w">                        </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="p">)</span><span class="w"></span>
<a id="ln-1386" name="ln-1386" href="#ln-1386"></a><span class="w">                </span><span class="k">END IF</span>
<a id="ln-1387" name="ln-1387" href="#ln-1387"></a><span class="k">                DEALLOCATE</span><span class="p">(</span><span class="n">tempPrecip2</span><span class="p">)</span><span class="w"></span>
<a id="ln-1388" name="ln-1388" href="#ln-1388"></a><span class="w">             </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1389" name="ln-1389" href="#ln-1389"></a><span class="w">             </span><span class="c">! Create rescaling factor for this grid cell to ensure spinup</span>
<a id="ln-1390" name="ln-1390" href="#ln-1390"></a><span class="w">             </span><span class="c">! rainfall/snowfall is closer to average rainfall:</span>
<a id="ln-1391" name="ln-1391" href="#ln-1391"></a><span class="w">             </span><span class="c">! First calculate annual average precip in met data:</span>
<a id="ln-1392" name="ln-1392" href="#ln-1392"></a><span class="w">             </span><span class="n">avPrecipInMet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PrecipTot</span><span class="o">/</span><span class="kt">REAL</span><span class="p">(</span><span class="n">kend</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">360</span><span class="mf">0.0</span><span class="o">/</span><span class="n">dels</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">365</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">24</span><span class="w"></span>
<a id="ln-1393" name="ln-1393" href="#ln-1393"></a><span class="w">             </span><span class="n">PrecipScale</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avPrecipInMet</span><span class="o">/</span><span class="n">avPrecip</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<a id="ln-1394" name="ln-1394" href="#ln-1394"></a><span class="w">             </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  Site number:&#39;</span><span class="p">,</span><span class="n">i</span><span class="w"></span>
<a id="ln-1395" name="ln-1395" href="#ln-1395"></a><span class="w">             </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  average precip quoted in avPrecip variable:&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1396" name="ln-1396" href="#ln-1396"></a><span class="w">                  </span><span class="n">avPrecip</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<a id="ln-1397" name="ln-1397" href="#ln-1397"></a><span class="w">             </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  average precip in met data:&#39;</span><span class="p">,</span><span class="n">avPrecipInMet</span><span class="w"></span>
<a id="ln-1398" name="ln-1398" href="#ln-1398"></a><span class="w">          </span><span class="k">END DO</span><span class="w"> </span><span class="c">! over each land grid cell</span>
<a id="ln-1399" name="ln-1399" href="#ln-1399"></a><span class="w">          </span><span class="k">DEALLOCATE</span><span class="p">(</span><span class="n">avPrecip</span><span class="p">)</span><span class="w"></span>
<a id="ln-1400" name="ln-1400" href="#ln-1400"></a><span class="w">       </span><span class="k">ELSE</span><span class="w"> </span><span class="c">! avPrecip doesn&#39;t exist in met file</span>
<a id="ln-1401" name="ln-1401" href="#ln-1401"></a><span class="w">          </span><span class="c">! Spinup will not modify precip values:</span>
<a id="ln-1402" name="ln-1402" href="#ln-1402"></a><span class="w">          </span><span class="n">exists</span><span class="p">%</span><span class="n">avPrecip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"></span>
<a id="ln-1403" name="ln-1403" href="#ln-1403"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Spinup will repeat entire data set until states converge&#39;</span><span class="w"></span>
<a id="ln-1404" name="ln-1404" href="#ln-1404"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  (see below for convergence criteria);&#39;</span><span class="w"></span>
<a id="ln-1405" name="ln-1405" href="#ln-1405"></a><span class="w">          </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Spinup will repeat entire data set until states converge:&#39;</span><span class="w"></span>
<a id="ln-1406" name="ln-1406" href="#ln-1406"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-1407" name="ln-1407" href="#ln-1407"></a><span class="k">    END IF</span><span class="w">  </span><span class="c">! if a spinup is to be performed</span>
<a id="ln-1408" name="ln-1408" href="#ln-1408"></a>
<a id="ln-1409" name="ln-1409" href="#ln-1409"></a><span class="w">    </span><span class="c">! Look for veg type - - - - - - - - - - - - - - - - -:</span>
<a id="ln-1410" name="ln-1410" href="#ln-1410"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">IVegNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">iveg</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1411" name="ln-1411" href="#ln-1411"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If &#39;iveg&#39; exists in the met file</span>
<a id="ln-1412" name="ln-1412" href="#ln-1412"></a><span class="w">       </span><span class="c">! Note existence of at least one model parameter in the met file:</span>
<a id="ln-1413" name="ln-1413" href="#ln-1413"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-1414" name="ln-1414" href="#ln-1414"></a><span class="w">       </span><span class="c">! Allocate space for user-defined veg type variable:</span>
<a id="ln-1415" name="ln-1415" href="#ln-1415"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">vegtype_metfile</span><span class="p">(</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">))</span><span class="w"></span>
<a id="ln-1416" name="ln-1416" href="#ln-1416"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">patch</span><span class="p">)</span><span class="w">  </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">vegpatch_metfile</span><span class="p">(</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">))</span><span class="w"></span>
<a id="ln-1417" name="ln-1417" href="#ln-1417"></a>
<a id="ln-1418" name="ln-1418" href="#ln-1418"></a><span class="w">       </span><span class="c">! Check dimension of veg type:</span>
<a id="ln-1419" name="ln-1419" href="#ln-1419"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">iveg</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">iveg_dims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1420" name="ln-1420" href="#ln-1420"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. at least two spatial dimensions</span>
<a id="ln-1421" name="ln-1421" href="#ln-1421"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">iveg_dims</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! no patch specific iveg information, just x,y</span>
<a id="ln-1422" name="ln-1422" href="#ln-1422"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1423" name="ln-1423" href="#ln-1423"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">iveg</span><span class="p">,</span><span class="n">data2i</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! get iveg data</span>
<a id="ln-1424" name="ln-1424" href="#ln-1424"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1425" name="ln-1425" href="#ln-1425"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1426" name="ln-1426" href="#ln-1426"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading iveg in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1427" name="ln-1427" href="#ln-1427"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1428" name="ln-1428" href="#ln-1428"></a><span class="w">                </span><span class="c">! Set all veg patches in grid cell to be this single type</span>
<a id="ln-1429" name="ln-1429" href="#ln-1429"></a><span class="w">                </span><span class="n">vegtype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:)</span><span class="o">=</span><span class="n">data2i</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1430" name="ln-1430" href="#ln-1430"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1431" name="ln-1431" href="#ln-1431"></a><span class="k">          ELSE IF</span><span class="p">(</span><span class="n">iveg_dims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch specific iveg information</span>
<a id="ln-1432" name="ln-1432" href="#ln-1432"></a><span class="w">             </span><span class="c">! Patch-specific iveg variable MUST be accompanied by</span>
<a id="ln-1433" name="ln-1433" href="#ln-1433"></a><span class="w">             </span><span class="c">! patchfrac variable with the same dimensions. So,</span>
<a id="ln-1434" name="ln-1434" href="#ln-1434"></a><span class="w">             </span><span class="c">! Make sure that the patchfrac variable exists:</span>
<a id="ln-1435" name="ln-1435" href="#ln-1435"></a><span class="w">             </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">PFracNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">patchfrac</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1436" name="ln-1436" href="#ln-1436"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check read ok</span>
<a id="ln-1437" name="ln-1437" href="#ln-1437"></a><span class="w">                  </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Patch-specific vegetation type (iveg) must be accompanied &#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1438" name="ln-1438" href="#ln-1438"></a><span class="w">                  </span><span class="s1">&#39;by a patchfrac variable - this was not found in met data file &#39;</span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1439" name="ln-1439" href="#ln-1439"></a><span class="w">                  </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1440" name="ln-1440" href="#ln-1440"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1441" name="ln-1441" href="#ln-1441"></a><span class="w">                </span><span class="c">! Then, get the patch specific iveg data:</span>
<a id="ln-1442" name="ln-1442" href="#ln-1442"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">iveg</span><span class="p">,</span><span class="n">vegtype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1443" name="ln-1443" href="#ln-1443"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1444" name="ln-1444" href="#ln-1444"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check read ok</span>
<a id="ln-1445" name="ln-1445" href="#ln-1445"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading iveg in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1446" name="ln-1446" href="#ln-1446"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1447" name="ln-1447" href="#ln-1447"></a>
<a id="ln-1448" name="ln-1448" href="#ln-1448"></a><span class="w">              </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">patch</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<a id="ln-1449" name="ln-1449" href="#ln-1449"></a><span class="w">       </span>
<a id="ln-1450" name="ln-1450" href="#ln-1450"></a><span class="w">                </span><span class="c">!Anna: also read patch fractions</span>
<a id="ln-1451" name="ln-1451" href="#ln-1451"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">patchfrac</span><span class="p">,</span><span class="n">vegpatch_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1452" name="ln-1452" href="#ln-1452"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1453" name="ln-1453" href="#ln-1453"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check read ok</span>
<a id="ln-1454" name="ln-1454" href="#ln-1454"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading patchfrac in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1455" name="ln-1455" href="#ln-1455"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1456" name="ln-1456" href="#ln-1456"></a><span class="w">              </span><span class="k">END IF</span>
<a id="ln-1457" name="ln-1457" href="#ln-1457"></a><span class="k">             END DO</span>
<a id="ln-1458" name="ln-1458" href="#ln-1458"></a><span class="k">          END IF</span>
<a id="ln-1459" name="ln-1459" href="#ln-1459"></a><span class="k">       ELSE IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;land&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1460" name="ln-1460" href="#ln-1460"></a><span class="w">          </span><span class="c">! Collect data from land only grid in netcdf file:</span>
<a id="ln-1461" name="ln-1461" href="#ln-1461"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">iveg_dims</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. no patch specific iveg information</span>
<a id="ln-1462" name="ln-1462" href="#ln-1462"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1463" name="ln-1463" href="#ln-1463"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">iveg</span><span class="p">,</span><span class="n">data1i</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1464" name="ln-1464" href="#ln-1464"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">i</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1465" name="ln-1465" href="#ln-1465"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1466" name="ln-1466" href="#ln-1466"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading iveg in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1467" name="ln-1467" href="#ln-1467"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1468" name="ln-1468" href="#ln-1468"></a><span class="w">                </span><span class="c">! Set all veg patches in grid cell to be this single type</span>
<a id="ln-1469" name="ln-1469" href="#ln-1469"></a><span class="w">                </span><span class="n">vegtype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data1i</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1470" name="ln-1470" href="#ln-1470"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1471" name="ln-1471" href="#ln-1471"></a><span class="k">          ELSE IF</span><span class="p">(</span><span class="n">iveg_dims</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch specific iveg information</span>
<a id="ln-1472" name="ln-1472" href="#ln-1472"></a><span class="w">             </span><span class="c">! Patch-specific iveg variable MUST be accompanied by</span>
<a id="ln-1473" name="ln-1473" href="#ln-1473"></a><span class="w">             </span><span class="c">! patchfrac variable with same dimensions. So,</span>
<a id="ln-1474" name="ln-1474" href="#ln-1474"></a><span class="w">             </span><span class="c">! Make sure that the patchfrac variable exists:</span>
<a id="ln-1475" name="ln-1475" href="#ln-1475"></a><span class="w">            </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">PFracNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">patchfrac</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1476" name="ln-1476" href="#ln-1476"></a><span class="w">            </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check read ok</span>
<a id="ln-1477" name="ln-1477" href="#ln-1477"></a><span class="w">                  </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Patch-specific vegetation type (iveg) must be accompanied&#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1478" name="ln-1478" href="#ln-1478"></a><span class="w">                  </span><span class="s1">&#39;by a patchfrac variable - this was not found in met data file &#39;</span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1479" name="ln-1479" href="#ln-1479"></a><span class="w">                  </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1480" name="ln-1480" href="#ln-1480"></a>
<a id="ln-1481" name="ln-1481" href="#ln-1481"></a><span class="w">              </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">patch</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"></span>
<a id="ln-1482" name="ln-1482" href="#ln-1482"></a><span class="w">                </span><span class="c">!Anna: also read patch fractions</span>
<a id="ln-1483" name="ln-1483" href="#ln-1483"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">patchfrac</span><span class="p">,</span><span class="n">vegpatch_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1484" name="ln-1484" href="#ln-1484"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1485" name="ln-1485" href="#ln-1485"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check read ok</span>
<a id="ln-1486" name="ln-1486" href="#ln-1486"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading patchfrac in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1487" name="ln-1487" href="#ln-1487"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1488" name="ln-1488" href="#ln-1488"></a><span class="w">              </span><span class="k">END IF</span>
<a id="ln-1489" name="ln-1489" href="#ln-1489"></a>
<a id="ln-1490" name="ln-1490" href="#ln-1490"></a><span class="k">             DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1491" name="ln-1491" href="#ln-1491"></a><span class="w">                </span><span class="c">! Then, get the patch specific iveg data:</span>
<a id="ln-1492" name="ln-1492" href="#ln-1492"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">iveg</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1493" name="ln-1493" href="#ln-1493"></a><span class="w">                     </span><span class="n">vegtype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:),&amp;</span><span class="w"></span>
<a id="ln-1494" name="ln-1494" href="#ln-1494"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="w"> </span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1495" name="ln-1495" href="#ln-1495"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1496" name="ln-1496" href="#ln-1496"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading iveg in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1497" name="ln-1497" href="#ln-1497"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1498" name="ln-1498" href="#ln-1498"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1499" name="ln-1499" href="#ln-1499"></a><span class="k">          END IF</span>
<a id="ln-1500" name="ln-1500" href="#ln-1500"></a><span class="k">       END IF</span>
<a id="ln-1501" name="ln-1501" href="#ln-1501"></a><span class="k">    ELSE</span>
<a id="ln-1502" name="ln-1502" href="#ln-1502"></a><span class="k">       NULLIFY</span><span class="p">(</span><span class="n">vegtype_metfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-1503" name="ln-1503" href="#ln-1503"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">patch</span><span class="p">)</span><span class="w"> </span><span class="k">NULLIFY</span><span class="p">(</span><span class="n">vegpatch_metfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-1504" name="ln-1504" href="#ln-1504"></a><span class="w">       </span>
<a id="ln-1505" name="ln-1505" href="#ln-1505"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1506" name="ln-1506" href="#ln-1506"></a>
<a id="ln-1507" name="ln-1507" href="#ln-1507"></a><span class="w">    </span><span class="c">! Look for soil type:</span>
<a id="ln-1508" name="ln-1508" href="#ln-1508"></a><span class="w">    </span><span class="k">CALL </span><span class="n">find_metvarid</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">possible_varnames</span><span class="p">%</span><span class="n">ISoilNames</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">isoil</span><span class="p">,</span><span class="w"> </span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-1509" name="ln-1509" href="#ln-1509"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If inquiry is okay</span>
<a id="ln-1510" name="ln-1510" href="#ln-1510"></a><span class="w">       </span><span class="c">! Note existence of at least one model parameter in the met file:</span>
<a id="ln-1511" name="ln-1511" href="#ln-1511"></a><span class="w">       </span><span class="n">exists</span><span class="p">%</span><span class="n">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-1512" name="ln-1512" href="#ln-1512"></a><span class="w">       </span><span class="c">! Check dimension of soil type:</span>
<a id="ln-1513" name="ln-1513" href="#ln-1513"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">isoil</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">isoil_dims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1514" name="ln-1514" href="#ln-1514"></a><span class="w">       </span><span class="c">! Allocate space for user-defined soil type variable:</span>
<a id="ln-1515" name="ln-1515" href="#ln-1515"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">soiltype_metfile</span><span class="p">(</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">))</span><span class="w"></span>
<a id="ln-1516" name="ln-1516" href="#ln-1516"></a><span class="w">       </span><span class="c">! Get soil type from met file:</span>
<a id="ln-1517" name="ln-1517" href="#ln-1517"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1518" name="ln-1518" href="#ln-1518"></a><span class="k">          IF</span><span class="p">(</span><span class="n">isoil_dims</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. no patch specific isoil information</span>
<a id="ln-1519" name="ln-1519" href="#ln-1519"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1520" name="ln-1520" href="#ln-1520"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">isoil</span><span class="p">,</span><span class="n">data2i</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1521" name="ln-1521" href="#ln-1521"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1522" name="ln-1522" href="#ln-1522"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1523" name="ln-1523" href="#ln-1523"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading isoil in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1524" name="ln-1524" href="#ln-1524"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1525" name="ln-1525" href="#ln-1525"></a><span class="w">                </span><span class="c">! Set all soil patches in grid cell to be this single type</span>
<a id="ln-1526" name="ln-1526" href="#ln-1526"></a><span class="w">                </span><span class="n">soiltype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:)</span><span class="o">=</span><span class="n">data2i</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1527" name="ln-1527" href="#ln-1527"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1528" name="ln-1528" href="#ln-1528"></a><span class="k">          ELSE IF</span><span class="p">(</span><span class="n">isoil_dims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch specific isoil information</span>
<a id="ln-1529" name="ln-1529" href="#ln-1529"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1530" name="ln-1530" href="#ln-1530"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">isoil</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1531" name="ln-1531" href="#ln-1531"></a><span class="w">                     </span><span class="n">soiltype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1532" name="ln-1532" href="#ln-1532"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1533" name="ln-1533" href="#ln-1533"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1534" name="ln-1534" href="#ln-1534"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading isoil in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1535" name="ln-1535" href="#ln-1535"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1536" name="ln-1536" href="#ln-1536"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1537" name="ln-1537" href="#ln-1537"></a><span class="k">          END IF</span>
<a id="ln-1538" name="ln-1538" href="#ln-1538"></a><span class="k">       ELSE IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;land&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1539" name="ln-1539" href="#ln-1539"></a><span class="k">          IF</span><span class="p">(</span><span class="n">isoil_dims</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. no patch specific isoil information</span>
<a id="ln-1540" name="ln-1540" href="#ln-1540"></a><span class="w">             </span><span class="c">! Collect data from land only grid in netcdf file:</span>
<a id="ln-1541" name="ln-1541" href="#ln-1541"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1542" name="ln-1542" href="#ln-1542"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">isoil</span><span class="p">,</span><span class="n">data1i</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1543" name="ln-1543" href="#ln-1543"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">i</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1544" name="ln-1544" href="#ln-1544"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1545" name="ln-1545" href="#ln-1545"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading isoil in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1546" name="ln-1546" href="#ln-1546"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1547" name="ln-1547" href="#ln-1547"></a><span class="w">                </span><span class="c">! Set all veg patches in grid cell to be this single type</span>
<a id="ln-1548" name="ln-1548" href="#ln-1548"></a><span class="w">                </span><span class="n">soiltype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data1i</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<a id="ln-1549" name="ln-1549" href="#ln-1549"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1550" name="ln-1550" href="#ln-1550"></a><span class="k">          ELSE IF</span><span class="p">(</span><span class="n">isoil_dims</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch specific isoil information</span>
<a id="ln-1551" name="ln-1551" href="#ln-1551"></a><span class="w">             </span><span class="k">DO </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="w"></span>
<a id="ln-1552" name="ln-1552" href="#ln-1552"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">%</span><span class="n">isoil</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1553" name="ln-1553" href="#ln-1553"></a><span class="w">                     </span><span class="n">soiltype_metfile</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1554" name="ln-1554" href="#ln-1554"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="w"> </span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1555" name="ln-1555" href="#ln-1555"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1556" name="ln-1556" href="#ln-1556"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading isoil in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1557" name="ln-1557" href="#ln-1557"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE open_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1558" name="ln-1558" href="#ln-1558"></a><span class="w">             </span><span class="k">END DO</span>
<a id="ln-1559" name="ln-1559" href="#ln-1559"></a><span class="k">          END IF</span>
<a id="ln-1560" name="ln-1560" href="#ln-1560"></a><span class="k">       END IF</span>
<a id="ln-1561" name="ln-1561" href="#ln-1561"></a><span class="k">    ELSE</span>
<a id="ln-1562" name="ln-1562" href="#ln-1562"></a><span class="k">       NULLIFY</span><span class="p">(</span><span class="n">soiltype_metfile</span><span class="p">)</span><span class="w"></span>
<a id="ln-1563" name="ln-1563" href="#ln-1563"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1564" name="ln-1564" href="#ln-1564"></a>
<a id="ln-1565" name="ln-1565" href="#ln-1565"></a><span class="w">    </span><span class="c">! Report finding met variables to log file:</span>
<a id="ln-1566" name="ln-1566" href="#ln-1566"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">all_met</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1567" name="ln-1567" href="#ln-1567"></a><span class="k">       WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Found all met variables in met file.&#39;</span><span class="w"></span>
<a id="ln-1568" name="ln-1568" href="#ln-1568"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-1569" name="ln-1569" href="#ln-1569"></a><span class="k">       WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Found all ESSENTIAL met variables in met file,&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1570" name="ln-1570" href="#ln-1570"></a><span class="w">            </span><span class="s1">&#39; some synthesised (as above).&#39;</span><span class="w"></span>
<a id="ln-1571" name="ln-1571" href="#ln-1571"></a><span class="w">    </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1572" name="ln-1572" href="#ln-1572"></a>
<a id="ln-1573" name="ln-1573" href="#ln-1573"></a><span class="w">    </span><span class="c">!!=================^^ End met variables search^^=======================</span>
<a id="ln-1574" name="ln-1574" href="#ln-1574"></a><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">open_met_file</span><span class="w"></span>
<a id="ln-1575" name="ln-1575" href="#ln-1575"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-1576" name="ln-1576" href="#ln-1576"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1577" name="ln-1577" href="#ln-1577"></a><span class="w">  </span><span class="c">! Name: get_met_data</span>
<a id="ln-1578" name="ln-1578" href="#ln-1578"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1579" name="ln-1579" href="#ln-1579"></a><span class="w">  </span><span class="c">! Purpose: Fetches meteorological forcing data from the netcdf met forcing file</span>
<a id="ln-1580" name="ln-1580" href="#ln-1580"></a><span class="w">  </span><span class="c">!          for a single time step, including LAI if it exists.</span>
<a id="ln-1581" name="ln-1581" href="#ln-1581"></a><span class="w">  </span><span class="c">!          Note that currently met forcing is duplicated for every vegetated</span>
<a id="ln-1582" name="ln-1582" href="#ln-1582"></a><span class="w">  </span><span class="c">!          patch in a single gridcell.</span>
<a id="ln-1583" name="ln-1583" href="#ln-1583"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1584" name="ln-1584" href="#ln-1584"></a><span class="w">  </span><span class="c">! CALLed from: cable_offline_driver</span>
<a id="ln-1585" name="ln-1585" href="#ln-1585"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1586" name="ln-1586" href="#ln-1586"></a><span class="w">  </span><span class="c">! MODULEs used: cable_common_module</span>
<a id="ln-1587" name="ln-1587" href="#ln-1587"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1588" name="ln-1588" href="#ln-1588"></a><span class="w">  </span><span class="c">! CALLs: abort</span>
<a id="ln-1589" name="ln-1589" href="#ln-1589"></a><span class="w">  </span><span class="c">!        nc_abort</span>
<a id="ln-1590" name="ln-1590" href="#ln-1590"></a><span class="w">  </span><span class="c">!        rh_sh</span>
<a id="ln-1591" name="ln-1591" href="#ln-1591"></a><span class="w">  </span><span class="c">!        sinbet</span>
<a id="ln-1592" name="ln-1592" href="#ln-1592"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1593" name="ln-1593" href="#ln-1593"></a><span class="w">  </span><span class="c">! Input file: [SiteName].nc</span>
<a id="ln-1594" name="ln-1594" href="#ln-1594"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-1595" name="ln-1595" href="#ln-1595"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-1596" name="ln-1596" href="#ln-1596"></a>
<a id="ln-1597" name="ln-1597" href="#ln-1597"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">get_met_data</span><span class="p">(</span><span class="n">spinup</span><span class="p">,</span><span class="n">spinConv</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="w">                          </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1598" name="ln-1598" href="#ln-1598"></a><span class="w">       </span><span class="n">veg</span><span class="p">,</span><span class="n">kend</span><span class="p">,</span><span class="n">dels</span><span class="p">,</span><span class="w"> </span><span class="n">TFRZ</span><span class="p">,</span><span class="w"> </span><span class="n">ktau</span><span class="p">,</span><span class="w"> </span><span class="n">kstart</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-1599" name="ln-1599" href="#ln-1599"></a><span class="w">    </span><span class="c">! Precision changes from REAL(4) to r_1 enable running with -r8</span>
<a id="ln-1600" name="ln-1600" href="#ln-1600"></a>
<a id="ln-1601" name="ln-1601" href="#ln-1601"></a>
<a id="ln-1602" name="ln-1602" href="#ln-1602"></a><span class="w">    </span><span class="c">! Input arguments</span>
<a id="ln-1603" name="ln-1603" href="#ln-1603"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">                    </span><span class="kd">::</span><span class="w">                                   </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1604" name="ln-1604" href="#ln-1604"></a><span class="w">         </span><span class="n">spinup</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! are we performing a spinup?</span>
<a id="ln-1605" name="ln-1605" href="#ln-1605"></a><span class="w">         </span><span class="n">spinConv</span><span class="w">          </span><span class="c">! has model spinup converged?</span>
<a id="ln-1606" name="ln-1606" href="#ln-1606"></a><span class="w">    </span><span class="k">TYPE</span><span class="p">(</span><span class="n">met_type</span><span class="p">),</span><span class="w">             </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">met</span><span class="w">     </span><span class="c">! meteorological data</span>
<a id="ln-1607" name="ln-1607" href="#ln-1607"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">soil_parameter_type</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">soil</span><span class="w"></span>
<a id="ln-1608" name="ln-1608" href="#ln-1608"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">radiation_type</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">rad</span><span class="w"></span>
<a id="ln-1609" name="ln-1609" href="#ln-1609"></a><span class="w">    </span><span class="k">TYPE</span><span class="p">(</span><span class="n">veg_parameter_type</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">veg</span><span class="w"> </span><span class="c">! LAI retrieved from file</span>
<a id="ln-1610" name="ln-1610" href="#ln-1610"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">               </span><span class="kd">::</span><span class="w"> </span><span class="n">ktau</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">  </span><span class="c">! timestep in loop including spinup</span>
<a id="ln-1611" name="ln-1611" href="#ln-1611"></a><span class="w">         </span><span class="n">kend</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! total number of timesteps in run</span>
<a id="ln-1612" name="ln-1612" href="#ln-1612"></a><span class="w">         </span><span class="n">kstart</span><span class="w">  </span><span class="c">! starting timestep</span>
<a id="ln-1613" name="ln-1613" href="#ln-1613"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">                   </span><span class="kd">::</span><span class="w"> </span><span class="n">dels</span><span class="w"> </span><span class="c">! time step size</span>
<a id="ln-1614" name="ln-1614" href="#ln-1614"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TFRZ</span><span class="w"></span>
<a id="ln-1615" name="ln-1615" href="#ln-1615"></a>
<a id="ln-1616" name="ln-1616" href="#ln-1616"></a><span class="w">    </span><span class="c">! Local variables</span>
<a id="ln-1617" name="ln-1617" href="#ln-1617"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">data3</span><span class="w"> </span><span class="c">! temp variable for netcdf reading</span>
<a id="ln-1618" name="ln-1618" href="#ln-1618"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">data4</span><span class="w"> </span><span class="c">!  &quot; &quot; &quot;</span>
<a id="ln-1619" name="ln-1619" href="#ln-1619"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w">            </span><span class="kd">::</span><span class="w"> </span><span class="n">data2</span><span class="w"> </span><span class="c">! &quot; &quot;</span>
<a id="ln-1620" name="ln-1620" href="#ln-1620"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">DIMENSION</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">              </span><span class="kd">::</span><span class="w"> </span><span class="n">data1</span><span class="w"> </span><span class="c">! &quot; &quot;</span>
<a id="ln-1621" name="ln-1621" href="#ln-1621"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">                           </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="w"> </span><span class="c">! do loop counter</span>
<a id="ln-1622" name="ln-1622" href="#ln-1622"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">                           </span><span class="kd">::</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="c">! tempvar for number of dims in variable</span>
<a id="ln-1623" name="ln-1623" href="#ln-1623"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">tmpDat1</span><span class="w"></span>
<a id="ln-1624" name="ln-1624" href="#ln-1624"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:,:)</span><span class="w">     </span><span class="kd">::</span><span class="w"> </span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="n">tmpDat2x</span><span class="w"></span>
<a id="ln-1625" name="ln-1625" href="#ln-1625"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:,:,:)</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="n">tmpDat3x</span><span class="w"></span>
<a id="ln-1626" name="ln-1626" href="#ln-1626"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">ALLOCATABLE</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:,:,:,:)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="n">tmpDat4x</span><span class="w"></span>
<a id="ln-1627" name="ln-1627" href="#ln-1627"></a>
<a id="ln-1628" name="ln-1628" href="#ln-1628"></a><span class="w">    </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1629" name="ln-1629" href="#ln-1629"></a><span class="w">       </span><span class="c">! First set timing variables:</span>
<a id="ln-1630" name="ln-1630" href="#ln-1630"></a><span class="w">       </span><span class="c">! All timing details below are initially written to the first patch</span>
<a id="ln-1631" name="ln-1631" href="#ln-1631"></a><span class="w">       </span><span class="c">! of each gridcell, then dumped to all patches for the gridcell.</span>
<a id="ln-1632" name="ln-1632" href="#ln-1632"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ktau</span><span class="o">==</span><span class="n">kstart</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! initialise...</span>
<a id="ln-1633" name="ln-1633" href="#ln-1633"></a><span class="w">          </span><span class="k">SELECT CASE</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)</span><span class="w"></span>
<a id="ln-1634" name="ln-1634" href="#ln-1634"></a><span class="w">          </span><span class="k">CASE</span><span class="p">(</span><span class="s1">&#39;LOC&#39;</span><span class="p">)</span><span class="c">! i.e. use local time by default</span>
<a id="ln-1635" name="ln-1635" href="#ln-1635"></a><span class="w">             </span><span class="c">! hour-of-day = starting hod</span>
<a id="ln-1636" name="ln-1636" href="#ln-1636"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shod</span><span class="w"></span>
<a id="ln-1637" name="ln-1637" href="#ln-1637"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdoy</span><span class="w"></span>
<a id="ln-1638" name="ln-1638" href="#ln-1638"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smoy</span><span class="w"></span>
<a id="ln-1639" name="ln-1639" href="#ln-1639"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syear</span><span class="w"></span>
<a id="ln-1640" name="ln-1640" href="#ln-1640"></a><span class="w">          </span><span class="k">CASE</span><span class="p">(</span><span class="s1">&#39;GMT&#39;</span><span class="p">)</span><span class="c">! use GMT</span>
<a id="ln-1641" name="ln-1641" href="#ln-1641"></a><span class="w">             </span><span class="c">! hour-of-day = starting hod + offset from GMT time:</span>
<a id="ln-1642" name="ln-1642" href="#ln-1642"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shod</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">longitude</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="mf">2.0</span><span class="w"></span>
<a id="ln-1643" name="ln-1643" href="#ln-1643"></a><span class="w">             </span><span class="c">! Note above that all met%* vars have dim mp,</span>
<a id="ln-1644" name="ln-1644" href="#ln-1644"></a><span class="w">             </span><span class="c">! while longitude and latitude have dimension mland.</span>
<a id="ln-1645" name="ln-1645" href="#ln-1645"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdoy</span><span class="w"></span>
<a id="ln-1646" name="ln-1646" href="#ln-1646"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smoy</span><span class="w"></span>
<a id="ln-1647" name="ln-1647" href="#ln-1647"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">syear</span><span class="w"></span>
<a id="ln-1648" name="ln-1648" href="#ln-1648"></a><span class="w">          </span><span class="k">CASE </span><span class="n">DEFAULT</span><span class="w"></span>
<a id="ln-1649" name="ln-1649" href="#ln-1649"></a><span class="w">             </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unknown time coordinate! &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1650" name="ln-1650" href="#ln-1650"></a><span class="w">                  </span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1651" name="ln-1651" href="#ln-1651"></a><span class="w">          </span><span class="k">END SELECT</span>
<a id="ln-1652" name="ln-1652" href="#ln-1652"></a><span class="k">       ELSE</span><span class="w"></span>
<a id="ln-1653" name="ln-1653" href="#ln-1653"></a><span class="w">          </span><span class="c">! increment hour-of-day by time step size:</span>
<a id="ln-1654" name="ln-1654" href="#ln-1654"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dels</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-1655" name="ln-1655" href="#ln-1655"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-1656" name="ln-1656" href="#ln-1656"></a><span class="w">       </span><span class="c">!</span>
<a id="ln-1657" name="ln-1657" href="#ln-1657"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! may be -ve since longitude</span>
<a id="ln-1658" name="ln-1658" href="#ln-1658"></a><span class="w">          </span><span class="c">! has range [-180,180]</span>
<a id="ln-1659" name="ln-1659" href="#ln-1659"></a><span class="w">          </span><span class="c">! Reduce day-of-year by one and ammend hour-of-day:</span>
<a id="ln-1660" name="ln-1660" href="#ln-1660"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1661" name="ln-1661" href="#ln-1661"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="mf">4.0</span><span class="w"></span>
<a id="ln-1662" name="ln-1662" href="#ln-1662"></a><span class="w">          </span><span class="c">! If a leap year AND we&#39;re using leap year timing:</span>
<a id="ln-1663" name="ln-1663" href="#ln-1663"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">is_leapyear</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1664" name="ln-1664" href="#ln-1664"></a><span class="k">             SELECT CASE</span><span class="p">(</span><span class="nb">INT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"></span>
<a id="ln-1665" name="ln-1665" href="#ln-1665"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c">! ie Dec previous year</span>
<a id="ln-1666" name="ln-1666" href="#ln-1666"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w"></span>
<a id="ln-1667" name="ln-1667" href="#ln-1667"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1668" name="ln-1668" href="#ln-1668"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">365</span><span class="w"> </span><span class="c">! prev year not leap year as this is</span>
<a id="ln-1669" name="ln-1669" href="#ln-1669"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="c">! Jan</span>
<a id="ln-1670" name="ln-1670" href="#ln-1670"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1671" name="ln-1671" href="#ln-1671"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="c">! Feb</span>
<a id="ln-1672" name="ln-1672" href="#ln-1672"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<a id="ln-1673" name="ln-1673" href="#ln-1673"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">91</span><span class="p">)</span><span class="w"> </span><span class="c">! Mar</span>
<a id="ln-1674" name="ln-1674" href="#ln-1674"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<a id="ln-1675" name="ln-1675" href="#ln-1675"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span><span class="w"></span>
<a id="ln-1676" name="ln-1676" href="#ln-1676"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<a id="ln-1677" name="ln-1677" href="#ln-1677"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">152</span><span class="p">)</span><span class="w"></span>
<a id="ln-1678" name="ln-1678" href="#ln-1678"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<a id="ln-1679" name="ln-1679" href="#ln-1679"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">182</span><span class="p">)</span><span class="w"></span>
<a id="ln-1680" name="ln-1680" href="#ln-1680"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<a id="ln-1681" name="ln-1681" href="#ln-1681"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">213</span><span class="p">)</span><span class="w"></span>
<a id="ln-1682" name="ln-1682" href="#ln-1682"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<a id="ln-1683" name="ln-1683" href="#ln-1683"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">244</span><span class="p">)</span><span class="w"></span>
<a id="ln-1684" name="ln-1684" href="#ln-1684"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="ln-1685" name="ln-1685" href="#ln-1685"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">274</span><span class="p">)</span><span class="w"></span>
<a id="ln-1686" name="ln-1686" href="#ln-1686"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<a id="ln-1687" name="ln-1687" href="#ln-1687"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">305</span><span class="p">)</span><span class="w"></span>
<a id="ln-1688" name="ln-1688" href="#ln-1688"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<a id="ln-1689" name="ln-1689" href="#ln-1689"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">335</span><span class="p">)</span><span class="w"></span>
<a id="ln-1690" name="ln-1690" href="#ln-1690"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"></span>
<a id="ln-1691" name="ln-1691" href="#ln-1691"></a><span class="w">             </span><span class="k">END SELECT</span>
<a id="ln-1692" name="ln-1692" href="#ln-1692"></a><span class="k">          ELSE</span><span class="w"> </span><span class="c">! not a leap year or not using leap year timing</span>
<a id="ln-1693" name="ln-1693" href="#ln-1693"></a><span class="w">             </span><span class="k">SELECT CASE</span><span class="p">(</span><span class="nb">INT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"></span>
<a id="ln-1694" name="ln-1694" href="#ln-1694"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c">! ie Dec previous year</span>
<a id="ln-1695" name="ln-1695" href="#ln-1695"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w"></span>
<a id="ln-1696" name="ln-1696" href="#ln-1696"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1697" name="ln-1697" href="#ln-1697"></a><span class="w">                </span><span class="c">! If previous year is a leap year</span>
<a id="ln-1698" name="ln-1698" href="#ln-1698"></a><span class="w">                </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">is_leapyear</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1699" name="ln-1699" href="#ln-1699"></a><span class="k">                   </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">366</span><span class="w"></span>
<a id="ln-1700" name="ln-1700" href="#ln-1700"></a><span class="w">                </span><span class="k">ELSE</span>
<a id="ln-1701" name="ln-1701" href="#ln-1701"></a><span class="k">                   </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">365</span><span class="w"></span>
<a id="ln-1702" name="ln-1702" href="#ln-1702"></a><span class="w">                </span><span class="k">END IF</span>
<a id="ln-1703" name="ln-1703" href="#ln-1703"></a><span class="k">             CASE</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span><span class="w"> </span><span class="c">! Jan</span>
<a id="ln-1704" name="ln-1704" href="#ln-1704"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1705" name="ln-1705" href="#ln-1705"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">59</span><span class="p">)</span><span class="w"> </span><span class="c">! Feb</span>
<a id="ln-1706" name="ln-1706" href="#ln-1706"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<a id="ln-1707" name="ln-1707" href="#ln-1707"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span><span class="w"></span>
<a id="ln-1708" name="ln-1708" href="#ln-1708"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<a id="ln-1709" name="ln-1709" href="#ln-1709"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="w"></span>
<a id="ln-1710" name="ln-1710" href="#ln-1710"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<a id="ln-1711" name="ln-1711" href="#ln-1711"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">151</span><span class="p">)</span><span class="w"></span>
<a id="ln-1712" name="ln-1712" href="#ln-1712"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<a id="ln-1713" name="ln-1713" href="#ln-1713"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">181</span><span class="p">)</span><span class="w"></span>
<a id="ln-1714" name="ln-1714" href="#ln-1714"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<a id="ln-1715" name="ln-1715" href="#ln-1715"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span><span class="w"></span>
<a id="ln-1716" name="ln-1716" href="#ln-1716"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<a id="ln-1717" name="ln-1717" href="#ln-1717"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">243</span><span class="p">)</span><span class="w"></span>
<a id="ln-1718" name="ln-1718" href="#ln-1718"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="ln-1719" name="ln-1719" href="#ln-1719"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">273</span><span class="p">)</span><span class="w"></span>
<a id="ln-1720" name="ln-1720" href="#ln-1720"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<a id="ln-1721" name="ln-1721" href="#ln-1721"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">304</span><span class="p">)</span><span class="w"></span>
<a id="ln-1722" name="ln-1722" href="#ln-1722"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<a id="ln-1723" name="ln-1723" href="#ln-1723"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">334</span><span class="p">)</span><span class="w"></span>
<a id="ln-1724" name="ln-1724" href="#ln-1724"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"></span>
<a id="ln-1725" name="ln-1725" href="#ln-1725"></a><span class="w">             </span><span class="k">END SELECT</span>
<a id="ln-1726" name="ln-1726" href="#ln-1726"></a><span class="k">          END IF</span><span class="w"> </span><span class="c">! if leap year or not</span>
<a id="ln-1727" name="ln-1727" href="#ln-1727"></a><span class="w">       </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">2</span><span class="mf">4.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1728" name="ln-1728" href="#ln-1728"></a><span class="w">          </span><span class="c">! increment or GMT adj has shifted day</span>
<a id="ln-1729" name="ln-1729" href="#ln-1729"></a><span class="w">          </span><span class="c">! Adjust day-of-year and hour-of-day:</span>
<a id="ln-1730" name="ln-1730" href="#ln-1730"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1731" name="ln-1731" href="#ln-1731"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="mf">4.0</span><span class="w"></span>
<a id="ln-1732" name="ln-1732" href="#ln-1732"></a><span class="w">          </span><span class="c">! If a leap year AND we&#39;re using leap year timing:</span>
<a id="ln-1733" name="ln-1733" href="#ln-1733"></a><span class="w">          </span><span class="c">!! vh_js !! use is_leapyear function here instead of multiple conditions</span>
<a id="ln-1734" name="ln-1734" href="#ln-1734"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">is_leapyear</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-1735" name="ln-1735" href="#ln-1735"></a><span class="k">             SELECT CASE</span><span class="p">(</span><span class="nb">INT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"></span>
<a id="ln-1736" name="ln-1736" href="#ln-1736"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="c">! Feb</span>
<a id="ln-1737" name="ln-1737" href="#ln-1737"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<a id="ln-1738" name="ln-1738" href="#ln-1738"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">61</span><span class="p">)</span><span class="w"> </span><span class="c">! Mar</span>
<a id="ln-1739" name="ln-1739" href="#ln-1739"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<a id="ln-1740" name="ln-1740" href="#ln-1740"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">92</span><span class="p">)</span><span class="w"></span>
<a id="ln-1741" name="ln-1741" href="#ln-1741"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<a id="ln-1742" name="ln-1742" href="#ln-1742"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span><span class="w"></span>
<a id="ln-1743" name="ln-1743" href="#ln-1743"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<a id="ln-1744" name="ln-1744" href="#ln-1744"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">153</span><span class="p">)</span><span class="w"></span>
<a id="ln-1745" name="ln-1745" href="#ln-1745"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<a id="ln-1746" name="ln-1746" href="#ln-1746"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">183</span><span class="p">)</span><span class="w"></span>
<a id="ln-1747" name="ln-1747" href="#ln-1747"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<a id="ln-1748" name="ln-1748" href="#ln-1748"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">214</span><span class="p">)</span><span class="w"></span>
<a id="ln-1749" name="ln-1749" href="#ln-1749"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="ln-1750" name="ln-1750" href="#ln-1750"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">245</span><span class="p">)</span><span class="w"></span>
<a id="ln-1751" name="ln-1751" href="#ln-1751"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<a id="ln-1752" name="ln-1752" href="#ln-1752"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">275</span><span class="p">)</span><span class="w"></span>
<a id="ln-1753" name="ln-1753" href="#ln-1753"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<a id="ln-1754" name="ln-1754" href="#ln-1754"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">306</span><span class="p">)</span><span class="w"></span>
<a id="ln-1755" name="ln-1755" href="#ln-1755"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"></span>
<a id="ln-1756" name="ln-1756" href="#ln-1756"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">336</span><span class="p">)</span><span class="w"></span>
<a id="ln-1757" name="ln-1757" href="#ln-1757"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w"></span>
<a id="ln-1758" name="ln-1758" href="#ln-1758"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">367</span><span class="p">)</span><span class="c">! end of year; increment</span>
<a id="ln-1759" name="ln-1759" href="#ln-1759"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1760" name="ln-1760" href="#ln-1760"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1761" name="ln-1761" href="#ln-1761"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1762" name="ln-1762" href="#ln-1762"></a><span class="w">             </span><span class="k">END SELECT</span><span class="w"></span>
<a id="ln-1763" name="ln-1763" href="#ln-1763"></a><span class="w">             </span><span class="c">! ELSE IF not leap year and Dec 31st, increment year</span>
<a id="ln-1764" name="ln-1764" href="#ln-1764"></a><span class="w">          </span><span class="k">ELSE</span>
<a id="ln-1765" name="ln-1765" href="#ln-1765"></a><span class="k">             SELECT CASE</span><span class="p">(</span><span class="nb">INT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)))</span><span class="w"></span>
<a id="ln-1766" name="ln-1766" href="#ln-1766"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="c">! Feb</span>
<a id="ln-1767" name="ln-1767" href="#ln-1767"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<a id="ln-1768" name="ln-1768" href="#ln-1768"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="c">! Mar</span>
<a id="ln-1769" name="ln-1769" href="#ln-1769"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
<a id="ln-1770" name="ln-1770" href="#ln-1770"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">91</span><span class="p">)</span><span class="w"></span>
<a id="ln-1771" name="ln-1771" href="#ln-1771"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<a id="ln-1772" name="ln-1772" href="#ln-1772"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span><span class="w"></span>
<a id="ln-1773" name="ln-1773" href="#ln-1773"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="w"></span>
<a id="ln-1774" name="ln-1774" href="#ln-1774"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">152</span><span class="p">)</span><span class="w"></span>
<a id="ln-1775" name="ln-1775" href="#ln-1775"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="w"></span>
<a id="ln-1776" name="ln-1776" href="#ln-1776"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">182</span><span class="p">)</span><span class="w"></span>
<a id="ln-1777" name="ln-1777" href="#ln-1777"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<a id="ln-1778" name="ln-1778" href="#ln-1778"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">213</span><span class="p">)</span><span class="w"></span>
<a id="ln-1779" name="ln-1779" href="#ln-1779"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<a id="ln-1780" name="ln-1780" href="#ln-1780"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">244</span><span class="p">)</span><span class="w"></span>
<a id="ln-1781" name="ln-1781" href="#ln-1781"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"></span>
<a id="ln-1782" name="ln-1782" href="#ln-1782"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">274</span><span class="p">)</span><span class="w"></span>
<a id="ln-1783" name="ln-1783" href="#ln-1783"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<a id="ln-1784" name="ln-1784" href="#ln-1784"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">305</span><span class="p">)</span><span class="w"></span>
<a id="ln-1785" name="ln-1785" href="#ln-1785"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"></span>
<a id="ln-1786" name="ln-1786" href="#ln-1786"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">335</span><span class="p">)</span><span class="w"></span>
<a id="ln-1787" name="ln-1787" href="#ln-1787"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w"></span>
<a id="ln-1788" name="ln-1788" href="#ln-1788"></a><span class="w">             </span><span class="k">CASE</span><span class="p">(</span><span class="mi">366</span><span class="p">)</span><span class="c">! end of year; increment</span>
<a id="ln-1789" name="ln-1789" href="#ln-1789"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1790" name="ln-1790" href="#ln-1790"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1791" name="ln-1791" href="#ln-1791"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-1792" name="ln-1792" href="#ln-1792"></a><span class="w">             </span><span class="k">END SELECT</span>
<a id="ln-1793" name="ln-1793" href="#ln-1793"></a><span class="k">          END IF</span><span class="w"> </span><span class="c">! if leap year or not</span>
<a id="ln-1794" name="ln-1794" href="#ln-1794"></a><span class="w">       </span><span class="k">END IF</span><span class="w"> </span><span class="c">! if increment has pushed hod to a different day</span>
<a id="ln-1795" name="ln-1795" href="#ln-1795"></a><span class="w">       </span><span class="c">! Now copy these values to all veg/soil patches in the current grid cell:</span>
<a id="ln-1796" name="ln-1796" href="#ln-1796"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-1797" name="ln-1797" href="#ln-1797"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-1798" name="ln-1798" href="#ln-1798"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-1799" name="ln-1799" href="#ln-1799"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">year</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-1800" name="ln-1800" href="#ln-1800"></a><span class="w">    </span><span class="k">ENDDO</span>
<a id="ln-1801" name="ln-1801" href="#ln-1801"></a>
<a id="ln-1802" name="ln-1802" href="#ln-1802"></a><span class="k">    IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1803" name="ln-1803" href="#ln-1803"></a><span class="w">      </span><span class="c">! N.B. not for GSWP runs, therefore only one met file here.</span>
<a id="ln-1804" name="ln-1804" href="#ln-1804"></a><span class="w">      </span><span class="c">! Also, xdimsize and ydimsize are passed from io_variables.</span>
<a id="ln-1805" name="ln-1805" href="#ln-1805"></a>
<a id="ln-1806" name="ln-1806" href="#ln-1806"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">))</span><span class="w"></span>
<a id="ln-1807" name="ln-1807" href="#ln-1807"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1808" name="ln-1808" href="#ln-1808"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1809" name="ln-1809" href="#ln-1809"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat3x</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">))</span><span class="w"></span>
<a id="ln-1810" name="ln-1810" href="#ln-1810"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat4x</span><span class="p">(</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1811" name="ln-1811" href="#ln-1811"></a>
<a id="ln-1812" name="ln-1812" href="#ln-1812"></a><span class="w">       </span><span class="c">! Get SWdown data for mask grid:</span>
<a id="ln-1813" name="ln-1813" href="#ln-1813"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="o">=</span><span class="n">ncid_sw</span><span class="w"> </span><span class="c">! since GSWP3 multiple met files</span>
<a id="ln-1814" name="ln-1814" href="#ln-1814"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">SWdown</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1815" name="ln-1815" href="#ln-1815"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1816" name="ln-1816" href="#ln-1816"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1817" name="ln-1817" href="#ln-1817"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading SWdown in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1818" name="ln-1818" href="#ln-1818"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1819" name="ln-1819" href="#ln-1819"></a><span class="w">       </span><span class="c">! Assign value to met data variable (no units change required):</span>
<a id="ln-1820" name="ln-1820" href="#ln-1820"></a><span class="w">       </span><span class="c">!jhan:quick fix, use (1/2) dimension 1 here arbitrarily</span>
<a id="ln-1821" name="ln-1821" href="#ln-1821"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1822" name="ln-1822" href="#ln-1822"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1823" name="ln-1823" href="#ln-1823"></a><span class="w">               </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1824" name="ln-1824" href="#ln-1824"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1825" name="ln-1825" href="#ln-1825"></a><span class="w">               </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1826" name="ln-1826" href="#ln-1826"></a><span class="w">       </span><span class="k">ENDDO</span><span class="w"></span>
<a id="ln-1827" name="ln-1827" href="#ln-1827"></a>
<a id="ln-1828" name="ln-1828" href="#ln-1828"></a><span class="w">       </span><span class="c">! Get Tair data for mask grid:- - - - - - - - - - - - - - - - - -</span>
<a id="ln-1829" name="ln-1829" href="#ln-1829"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_ta</span><span class="w"> </span><span class="c">! since GSWP3 multiple met files</span>
<a id="ln-1830" name="ln-1830" href="#ln-1830"></a><span class="w">       </span><span class="c">! Find number of dimensions of Tair:</span>
<a id="ln-1831" name="ln-1831" href="#ln-1831"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1832" name="ln-1832" href="#ln-1832"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ndims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! 3D var, either on grid or new ALMA format single site</span>
<a id="ln-1833" name="ln-1833" href="#ln-1833"></a><span class="w">         </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1834" name="ln-1834" href="#ln-1834"></a><span class="w">              </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1835" name="ln-1835" href="#ln-1835"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check for error</span>
<a id="ln-1836" name="ln-1836" href="#ln-1836"></a><span class="w">              </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Tair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1837" name="ln-1837" href="#ln-1837"></a><span class="w">              </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1838" name="ln-1838" href="#ln-1838"></a><span class="w">         </span><span class="c">! Assign value to met data variable with units change:</span>
<a id="ln-1839" name="ln-1839" href="#ln-1839"></a><span class="w">         </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1840" name="ln-1840" href="#ln-1840"></a><span class="w">            </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1841" name="ln-1841" href="#ln-1841"></a><span class="w">                 </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Tair</span><span class="w"></span>
<a id="ln-1842" name="ln-1842" href="#ln-1842"></a><span class="w">         </span><span class="k">ENDDO</span>
<a id="ln-1843" name="ln-1843" href="#ln-1843"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! i.e. ndims==4, the older ALMA format for Tair</span>
<a id="ln-1844" name="ln-1844" href="#ln-1844"></a><span class="w">         </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1845" name="ln-1845" href="#ln-1845"></a><span class="w">              </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1846" name="ln-1846" href="#ln-1846"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1847" name="ln-1847" href="#ln-1847"></a><span class="w">              </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Tair in met data file HERE&#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1848" name="ln-1848" href="#ln-1848"></a><span class="w">              </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1849" name="ln-1849" href="#ln-1849"></a><span class="w">         </span><span class="c">! Assign value to met data variable with units change:</span>
<a id="ln-1850" name="ln-1850" href="#ln-1850"></a><span class="w">         </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1851" name="ln-1851" href="#ln-1851"></a><span class="w">            </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1852" name="ln-1852" href="#ln-1852"></a><span class="w">                 </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Tair</span><span class="w"></span>
<a id="ln-1853" name="ln-1853" href="#ln-1853"></a><span class="w">         </span><span class="k">ENDDO</span>
<a id="ln-1854" name="ln-1854" href="#ln-1854"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-1855" name="ln-1855" href="#ln-1855"></a>
<a id="ln-1856" name="ln-1856" href="#ln-1856"></a><span class="w">       </span><span class="c">! Get PSurf data for mask grid:- - - - - - - - - - - - - - - - - -</span>
<a id="ln-1857" name="ln-1857" href="#ln-1857"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_ps</span><span class="w"> </span><span class="c">! since GSWP3 multiple met files</span>
<a id="ln-1858" name="ln-1858" href="#ln-1858"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">PSurf</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! IF PSurf is in met file:</span>
<a id="ln-1859" name="ln-1859" href="#ln-1859"></a><span class="w">         </span><span class="c">! Find number of dimensions of PSurf:</span>
<a id="ln-1860" name="ln-1860" href="#ln-1860"></a><span class="w">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1861" name="ln-1861" href="#ln-1861"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ndims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! 3D var, either grid or new ALMA format single site</span>
<a id="ln-1862" name="ln-1862" href="#ln-1862"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1863" name="ln-1863" href="#ln-1863"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1864" name="ln-1864" href="#ln-1864"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1865" name="ln-1865" href="#ln-1865"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading PSurf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1866" name="ln-1866" href="#ln-1866"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1867" name="ln-1867" href="#ln-1867"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1868" name="ln-1868" href="#ln-1868"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1869" name="ln-1869" href="#ln-1869"></a><span class="w">                   </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">PSurf</span><span class="w"></span>
<a id="ln-1870" name="ln-1870" href="#ln-1870"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1871" name="ln-1871" href="#ln-1871"></a><span class="k">         ELSE</span><span class="w"> </span><span class="c">! i.e. ndims==4, the older ALMA format for PSurf</span>
<a id="ln-1872" name="ln-1872" href="#ln-1872"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1873" name="ln-1873" href="#ln-1873"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1874" name="ln-1874" href="#ln-1874"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1875" name="ln-1875" href="#ln-1875"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading PSurf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1876" name="ln-1876" href="#ln-1876"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1877" name="ln-1877" href="#ln-1877"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1878" name="ln-1878" href="#ln-1878"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1879" name="ln-1879" href="#ln-1879"></a><span class="w">                   </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">PSurf</span><span class="w"></span>
<a id="ln-1880" name="ln-1880" href="#ln-1880"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1881" name="ln-1881" href="#ln-1881"></a><span class="k">         END IF</span>
<a id="ln-1882" name="ln-1882" href="#ln-1882"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! PSurf must be fixed as a function of site elevation and T:</span>
<a id="ln-1883" name="ln-1883" href="#ln-1883"></a><span class="w">         </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1884" name="ln-1884" href="#ln-1884"></a><span class="w">            </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="o">=</span><span class="mi">101</span><span class="mf">3.25</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1885" name="ln-1885" href="#ln-1885"></a><span class="w">                 </span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.0065</span><span class="o">*</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1886" name="ln-1886" href="#ln-1886"></a><span class="w">                 </span><span class="n">elevation</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="mf">9.80665</span><span class="o">/</span><span class="mi">28</span><span class="mf">7.04</span><span class="o">/</span><span class="mf">0.0065</span><span class="p">)</span><span class="w"></span>
<a id="ln-1887" name="ln-1887" href="#ln-1887"></a><span class="w">         </span><span class="k">ENDDO</span>
<a id="ln-1888" name="ln-1888" href="#ln-1888"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-1889" name="ln-1889" href="#ln-1889"></a>
<a id="ln-1890" name="ln-1890" href="#ln-1890"></a><span class="w">       </span><span class="c">! Get Qair data for mask grid: - - - - - - - - - - - - - - - - - -</span>
<a id="ln-1891" name="ln-1891" href="#ln-1891"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_qa</span><span class="w"> </span><span class="c">! since GSWP3 multiple met files</span>
<a id="ln-1892" name="ln-1892" href="#ln-1892"></a><span class="w">       </span><span class="c">! Find number of dimensions of Qair:</span>
<a id="ln-1893" name="ln-1893" href="#ln-1893"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1894" name="ln-1894" href="#ln-1894"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ndims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! 3D var, either grid or new ALMA format single site</span>
<a id="ln-1895" name="ln-1895" href="#ln-1895"></a><span class="w">         </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! read 3D Qair var</span>
<a id="ln-1896" name="ln-1896" href="#ln-1896"></a><span class="w">              </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1897" name="ln-1897" href="#ln-1897"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! check for error</span>
<a id="ln-1898" name="ln-1898" href="#ln-1898"></a><span class="w">              </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Qair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1899" name="ln-1899" href="#ln-1899"></a><span class="w">              </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1900" name="ln-1900" href="#ln-1900"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">convert</span><span class="p">%</span><span class="n">Qair</span><span class="o">==-</span><span class="mi">99</span><span class="mf">9.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1901" name="ln-1901" href="#ln-1901"></a><span class="w">           </span><span class="c">! Convert relative value using only first veg/soil patch values</span>
<a id="ln-1902" name="ln-1902" href="#ln-1902"></a><span class="w">           </span><span class="c">! (identical)</span>
<a id="ln-1903" name="ln-1903" href="#ln-1903"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1904" name="ln-1904" href="#ln-1904"></a><span class="w">             </span><span class="k">CALL </span><span class="n">rh_sh</span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1905" name="ln-1905" href="#ln-1905"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1906" name="ln-1906" href="#ln-1906"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">),</span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">))</span><span class="w"></span>
<a id="ln-1907" name="ln-1907" href="#ln-1907"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-1908" name="ln-1908" href="#ln-1908"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1909" name="ln-1909" href="#ln-1909"></a><span class="k">         ELSE</span>
<a id="ln-1910" name="ln-1910" href="#ln-1910"></a><span class="k">           DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1911" name="ln-1911" href="#ln-1911"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1912" name="ln-1912" href="#ln-1912"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1913" name="ln-1913" href="#ln-1913"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1914" name="ln-1914" href="#ln-1914"></a><span class="k">         END IF</span>
<a id="ln-1915" name="ln-1915" href="#ln-1915"></a><span class="k">       ELSE</span><span class="w">   </span><span class="c">! i.e. ndims==4, the older ALMA format for Qair</span>
<a id="ln-1916" name="ln-1916" href="#ln-1916"></a><span class="w">         </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1917" name="ln-1917" href="#ln-1917"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1918" name="ln-1918" href="#ln-1918"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1919" name="ln-1919" href="#ln-1919"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Qair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1920" name="ln-1920" href="#ln-1920"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1921" name="ln-1921" href="#ln-1921"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">convert</span><span class="p">%</span><span class="n">Qair</span><span class="o">==-</span><span class="mi">99</span><span class="mf">9.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-1922" name="ln-1922" href="#ln-1922"></a><span class="w">           </span><span class="c">! Convert relative value using only first veg/soil patch values</span>
<a id="ln-1923" name="ln-1923" href="#ln-1923"></a><span class="w">           </span><span class="c">! (identical)</span>
<a id="ln-1924" name="ln-1924" href="#ln-1924"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1925" name="ln-1925" href="#ln-1925"></a><span class="w">              </span><span class="k">CALL </span><span class="n">rh_sh</span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1926" name="ln-1926" href="#ln-1926"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1927" name="ln-1927" href="#ln-1927"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">),</span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">))</span><span class="w"></span>
<a id="ln-1928" name="ln-1928" href="#ln-1928"></a><span class="w">                </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-1929" name="ln-1929" href="#ln-1929"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1930" name="ln-1930" href="#ln-1930"></a><span class="k">         ELSE</span>
<a id="ln-1931" name="ln-1931" href="#ln-1931"></a><span class="k">           DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1932" name="ln-1932" href="#ln-1932"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1933" name="ln-1933" href="#ln-1933"></a><span class="w">                    </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1934" name="ln-1934" href="#ln-1934"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1935" name="ln-1935" href="#ln-1935"></a><span class="k">         END IF</span>
<a id="ln-1936" name="ln-1936" href="#ln-1936"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-1937" name="ln-1937" href="#ln-1937"></a>
<a id="ln-1938" name="ln-1938" href="#ln-1938"></a><span class="w">       </span><span class="c">! Get Wind data for mask grid: - - - - - - - - - - - - - - - - - -</span>
<a id="ln-1939" name="ln-1939" href="#ln-1939"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_wd</span><span class="w"> </span><span class="c">! since GSWP3 multiple met files</span>
<a id="ln-1940" name="ln-1940" href="#ln-1940"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">Wind</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! Scalar Wind</span>
<a id="ln-1941" name="ln-1941" href="#ln-1941"></a><span class="w">         </span><span class="c">! Find number of dimensions of Wind:</span>
<a id="ln-1942" name="ln-1942" href="#ln-1942"></a><span class="w">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1943" name="ln-1943" href="#ln-1943"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ndims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! 3D var, either grid or new ALMA format single site</span>
<a id="ln-1944" name="ln-1944" href="#ln-1944"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1945" name="ln-1945" href="#ln-1945"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1946" name="ln-1946" href="#ln-1946"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1947" name="ln-1947" href="#ln-1947"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1948" name="ln-1948" href="#ln-1948"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1949" name="ln-1949" href="#ln-1949"></a><span class="w">           </span><span class="c">! Assign value to met data variable (no units change required):</span>
<a id="ln-1950" name="ln-1950" href="#ln-1950"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1951" name="ln-1951" href="#ln-1951"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1952" name="ln-1952" href="#ln-1952"></a><span class="w">                   </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1953" name="ln-1953" href="#ln-1953"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1954" name="ln-1954" href="#ln-1954"></a><span class="k">         ELSE</span><span class="w"> </span><span class="c">! i.e. ndims==4, the older ALMA format for Wind</span>
<a id="ln-1955" name="ln-1955" href="#ln-1955"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1956" name="ln-1956" href="#ln-1956"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1957" name="ln-1957" href="#ln-1957"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1958" name="ln-1958" href="#ln-1958"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1959" name="ln-1959" href="#ln-1959"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1960" name="ln-1960" href="#ln-1960"></a><span class="w">           </span><span class="c">! Assign value to met data variable (no units change required):</span>
<a id="ln-1961" name="ln-1961" href="#ln-1961"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1962" name="ln-1962" href="#ln-1962"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1963" name="ln-1963" href="#ln-1963"></a><span class="w">                   </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1964" name="ln-1964" href="#ln-1964"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1965" name="ln-1965" href="#ln-1965"></a><span class="k">         END IF</span><span class="w"> </span><span class="c">! 3 or 4D for &#39;Wind&#39; variable</span>
<a id="ln-1966" name="ln-1966" href="#ln-1966"></a><span class="w">       </span><span class="k">ELSE</span><span class="w"> </span><span class="c">! Vector wind</span>
<a id="ln-1967" name="ln-1967" href="#ln-1967"></a><span class="w">         </span><span class="c">! Find number of dimensions of Wind_N:</span>
<a id="ln-1968" name="ln-1968" href="#ln-1968"></a><span class="w">         </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">ndims</span><span class="o">=</span><span class="n">ndims</span><span class="p">)</span><span class="w"></span>
<a id="ln-1969" name="ln-1969" href="#ln-1969"></a><span class="w">         </span><span class="k">IF</span><span class="p">(</span><span class="n">ndims</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! 3D var, either grid or new ALMA format single site</span>
<a id="ln-1970" name="ln-1970" href="#ln-1970"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1971" name="ln-1971" href="#ln-1971"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1972" name="ln-1972" href="#ln-1972"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1973" name="ln-1973" href="#ln-1973"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind_N in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1974" name="ln-1974" href="#ln-1974"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1975" name="ln-1975" href="#ln-1975"></a><span class="w">           </span><span class="c">! Write part of wind variable to met%ua:</span>
<a id="ln-1976" name="ln-1976" href="#ln-1976"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1977" name="ln-1977" href="#ln-1977"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-1978" name="ln-1978" href="#ln-1978"></a><span class="w">           </span><span class="k">ENDDO</span><span class="w"></span>
<a id="ln-1979" name="ln-1979" href="#ln-1979"></a><span class="w">           </span><span class="c">! Then fetch 3D Wind_E, and combine:</span>
<a id="ln-1980" name="ln-1980" href="#ln-1980"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind_E</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1981" name="ln-1981" href="#ln-1981"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1982" name="ln-1982" href="#ln-1982"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1983" name="ln-1983" href="#ln-1983"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind_E in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1984" name="ln-1984" href="#ln-1984"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1985" name="ln-1985" href="#ln-1985"></a><span class="w">           </span><span class="c">! Write final scalar Wind value:</span>
<a id="ln-1986" name="ln-1986" href="#ln-1986"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-1987" name="ln-1987" href="#ln-1987"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1988" name="ln-1988" href="#ln-1988"></a><span class="w">                   </span><span class="nb">SQRT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1989" name="ln-1989" href="#ln-1989"></a><span class="w">                   </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="ln-1990" name="ln-1990" href="#ln-1990"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-1991" name="ln-1991" href="#ln-1991"></a><span class="k">         ELSE</span><span class="w"> </span><span class="c">! i.e. ndims==4, the older ALMA format for Wind_N and _E</span>
<a id="ln-1992" name="ln-1992" href="#ln-1992"></a><span class="w">           </span><span class="c">! Get 4D Wind_N:</span>
<a id="ln-1993" name="ln-1993" href="#ln-1993"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1994" name="ln-1994" href="#ln-1994"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-1995" name="ln-1995" href="#ln-1995"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1996" name="ln-1996" href="#ln-1996"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind_N in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-1997" name="ln-1997" href="#ln-1997"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-1998" name="ln-1998" href="#ln-1998"></a><span class="w">           </span><span class="c">! Write part of wind variable to met%ua:</span>
<a id="ln-1999" name="ln-1999" href="#ln-1999"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2000" name="ln-2000" href="#ln-2000"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2001" name="ln-2001" href="#ln-2001"></a><span class="w">           </span><span class="k">ENDDO</span><span class="w"></span>
<a id="ln-2002" name="ln-2002" href="#ln-2002"></a><span class="w">           </span><span class="c">! Then fetch 4D Wind_E, and combine:</span>
<a id="ln-2003" name="ln-2003" href="#ln-2003"></a><span class="w">           </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind_E</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2004" name="ln-2004" href="#ln-2004"></a><span class="w">                </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2005" name="ln-2005" href="#ln-2005"></a><span class="w">           </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2006" name="ln-2006" href="#ln-2006"></a><span class="w">                </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind_E in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2007" name="ln-2007" href="#ln-2007"></a><span class="w">                </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2008" name="ln-2008" href="#ln-2008"></a><span class="w">           </span><span class="c">! Write final scalar Wind value:</span>
<a id="ln-2009" name="ln-2009" href="#ln-2009"></a><span class="w">           </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2010" name="ln-2010" href="#ln-2010"></a><span class="w">              </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2011" name="ln-2011" href="#ln-2011"></a><span class="w">                   </span><span class="nb">SQRT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2012" name="ln-2012" href="#ln-2012"></a><span class="w">                   </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="ln-2013" name="ln-2013" href="#ln-2013"></a><span class="w">           </span><span class="k">ENDDO</span>
<a id="ln-2014" name="ln-2014" href="#ln-2014"></a><span class="k">         END IF</span><span class="w"> </span><span class="c">! 3 or 4D for &#39;Wind_N&#39; and &#39;Wind_E&#39; variables</span>
<a id="ln-2015" name="ln-2015" href="#ln-2015"></a><span class="w">       </span><span class="k">END IF</span><span class="w"> </span><span class="c">! scalar or vector wind - &#39;Wind&#39; or &#39;Wind_N&#39;/&#39;Wind_E&#39;</span>
<a id="ln-2016" name="ln-2016" href="#ln-2016"></a>
<a id="ln-2017" name="ln-2017" href="#ln-2017"></a><span class="w">       </span><span class="c">! Get Rainf and Snowf data for mask grid:- - - - - - - - - - - - -</span>
<a id="ln-2018" name="ln-2018" href="#ln-2018"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_rain</span><span class="w"></span>
<a id="ln-2019" name="ln-2019" href="#ln-2019"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Rainf</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2020" name="ln-2020" href="#ln-2020"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2021" name="ln-2021" href="#ln-2021"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2022" name="ln-2022" href="#ln-2022"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Rainf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2023" name="ln-2023" href="#ln-2023"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2024" name="ln-2024" href="#ln-2024"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2025" name="ln-2025" href="#ln-2025"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2026" name="ln-2026" href="#ln-2026"></a><span class="w">               </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! store Rainf</span>
<a id="ln-2027" name="ln-2027" href="#ln-2027"></a><span class="w">       </span><span class="k">ENDDO</span>
<a id="ln-2028" name="ln-2028" href="#ln-2028"></a><span class="k">       IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2029" name="ln-2029" href="#ln-2029"></a><span class="k">          IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_snow</span><span class="w"></span>
<a id="ln-2030" name="ln-2030" href="#ln-2030"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Snowf</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2031" name="ln-2031" href="#ln-2031"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2032" name="ln-2032" href="#ln-2032"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2033" name="ln-2033" href="#ln-2033"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Snowf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2034" name="ln-2034" href="#ln-2034"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2035" name="ln-2035" href="#ln-2035"></a><span class="w">          </span><span class="c">! store Snowf value (EK nov2007)</span>
<a id="ln-2036" name="ln-2036" href="#ln-2036"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2037" name="ln-2037" href="#ln-2037"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2038" name="ln-2038" href="#ln-2038"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2039" name="ln-2039" href="#ln-2039"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2040" name="ln-2040" href="#ln-2040"></a><span class="k">       ELSE</span>
<a id="ln-2041" name="ln-2041" href="#ln-2041"></a><span class="k">          </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-2042" name="ln-2042" href="#ln-2042"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-2043" name="ln-2043" href="#ln-2043"></a><span class="w">       </span><span class="c">! combine Rainf and Snowf data</span>
<a id="ln-2044" name="ln-2044" href="#ln-2044"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"></span>
<a id="ln-2045" name="ln-2045" href="#ln-2045"></a><span class="w">       </span><span class="c">! Convert units:</span>
<a id="ln-2046" name="ln-2046" href="#ln-2046"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-2047" name="ln-2047" href="#ln-2047"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-2048" name="ln-2048" href="#ln-2048"></a><span class="w">       </span><span class="c">! If we&#39;re performing a spinup, the spinup hasn&#39;t converged,</span>
<a id="ln-2049" name="ln-2049" href="#ln-2049"></a><span class="w">       </span><span class="c">! and an avPrecip variable has been found, modify precip to</span>
<a id="ln-2050" name="ln-2050" href="#ln-2050"></a><span class="w">       </span><span class="c">! ensure reasonable equilibration:</span>
<a id="ln-2051" name="ln-2051" href="#ln-2051"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">spinup</span><span class="p">.</span><span class="nb">AND</span><span class="p">.(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">spinConv</span><span class="p">).</span><span class="nb">AND</span><span class="p">.</span><span class="n">exists</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2052" name="ln-2052" href="#ln-2052"></a><span class="w">          </span><span class="c">! Rescale precip to average rainfall for this site:</span>
<a id="ln-2053" name="ln-2053" href="#ln-2053"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2054" name="ln-2054" href="#ln-2054"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2055" name="ln-2055" href="#ln-2055"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PrecipScale</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<a id="ln-2056" name="ln-2056" href="#ln-2056"></a><span class="w">             </span><span class="c">! Added for snow (EK nov2007)</span>
<a id="ln-2057" name="ln-2057" href="#ln-2057"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2058" name="ln-2058" href="#ln-2058"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PrecipScale</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<a id="ln-2059" name="ln-2059" href="#ln-2059"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2060" name="ln-2060" href="#ln-2060"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-2061" name="ln-2061" href="#ln-2061"></a>
<a id="ln-2062" name="ln-2062" href="#ln-2062"></a><span class="w">       </span><span class="c">! Get LWdown data for mask grid: - - - - - - - - - - - - - - - - -</span>
<a id="ln-2063" name="ln-2063" href="#ln-2063"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">GSWP3</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_lw</span><span class="w"></span>
<a id="ln-2064" name="ln-2064" href="#ln-2064"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LWdown</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If LWdown exists in met file</span>
<a id="ln-2065" name="ln-2065" href="#ln-2065"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LWdown</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2066" name="ln-2066" href="#ln-2066"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2067" name="ln-2067" href="#ln-2067"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2068" name="ln-2068" href="#ln-2068"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LWdown in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2069" name="ln-2069" href="#ln-2069"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2070" name="ln-2070" href="#ln-2070"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2071" name="ln-2071" href="#ln-2071"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">fld</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2072" name="ln-2072" href="#ln-2072"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2073" name="ln-2073" href="#ln-2073"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2074" name="ln-2074" href="#ln-2074"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! Synthesise LWdown based on temperature</span>
<a id="ln-2075" name="ln-2075" href="#ln-2075"></a><span class="w">          </span><span class="c">! Use Swinbank formula:</span>
<a id="ln-2076" name="ln-2076" href="#ln-2076"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">fld</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0000094</span><span class="o">*</span><span class="mf">0.0000000567</span><span class="o">*</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(:)</span><span class="o">**</span><span class="mf">6.0</span><span class="p">)</span><span class="w"></span>
<a id="ln-2077" name="ln-2077" href="#ln-2077"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-2078" name="ln-2078" href="#ln-2078"></a>
<a id="ln-2079" name="ln-2079" href="#ln-2079"></a><span class="w">       </span><span class="c">! Get CO2air data for mask grid:- - - - - - - - - - - - - - - - - -</span>
<a id="ln-2080" name="ln-2080" href="#ln-2080"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">CO2air</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If CO2air exists in met file</span>
<a id="ln-2081" name="ln-2081" href="#ln-2081"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">CO2air</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2082" name="ln-2082" href="#ln-2082"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2083" name="ln-2083" href="#ln-2083"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2084" name="ln-2084" href="#ln-2084"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading CO2air in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2085" name="ln-2085" href="#ln-2085"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2086" name="ln-2086" href="#ln-2086"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2087" name="ln-2087" href="#ln-2087"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">ca</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2088" name="ln-2088" href="#ln-2088"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">100000</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-2089" name="ln-2089" href="#ln-2089"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2090" name="ln-2090" href="#ln-2090"></a><span class="k">       ELSE</span><span class="w"></span>
<a id="ln-2091" name="ln-2091" href="#ln-2091"></a><span class="w">          </span><span class="c">! Fix CO2 air concentration:</span>
<a id="ln-2092" name="ln-2092" href="#ln-2092"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">ca</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixedCO2</span><span class="w"> </span><span class="o">/</span><span class="mi">100000</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-2093" name="ln-2093" href="#ln-2093"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-2094" name="ln-2094" href="#ln-2094"></a>
<a id="ln-2095" name="ln-2095" href="#ln-2095"></a><span class="w">       </span><span class="c">! Get LAI, if it&#39;s present, for mask grid:- - - - - - - - - - - - -</span>
<a id="ln-2096" name="ln-2096" href="#ln-2096"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If LAI exists in met file</span>
<a id="ln-2097" name="ln-2097" href="#ln-2097"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_T</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. time dependent LAI</span>
<a id="ln-2098" name="ln-2098" href="#ln-2098"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch dependent LAI</span>
<a id="ln-2099" name="ln-2099" href="#ln-2099"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat4x</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2100" name="ln-2100" href="#ln-2100"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2101" name="ln-2101" href="#ln-2101"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2102" name="ln-2102" href="#ln-2102"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met1 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2103" name="ln-2103" href="#ln-2103"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2104" name="ln-2104" href="#ln-2104"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2105" name="ln-2105" href="#ln-2105"></a><span class="w">                   </span><span class="k">DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="w"></span>
<a id="ln-2106" name="ln-2106" href="#ln-2106"></a><span class="w">                      </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2107" name="ln-2107" href="#ln-2107"></a><span class="w">                           </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4x</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2108" name="ln-2108" href="#ln-2108"></a><span class="w">                   </span><span class="k">ENDDO</span>
<a id="ln-2109" name="ln-2109" href="#ln-2109"></a><span class="k">                ENDDO</span>
<a id="ln-2110" name="ln-2110" href="#ln-2110"></a><span class="k">             ELSE</span><span class="w"> </span><span class="c">! i.e. patch independent LAI</span>
<a id="ln-2111" name="ln-2111" href="#ln-2111"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2112" name="ln-2112" href="#ln-2112"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2113" name="ln-2113" href="#ln-2113"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2114" name="ln-2114" href="#ln-2114"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met2 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2115" name="ln-2115" href="#ln-2115"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2116" name="ln-2116" href="#ln-2116"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2117" name="ln-2117" href="#ln-2117"></a><span class="w">                   </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2118" name="ln-2118" href="#ln-2118"></a><span class="w">                        </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2119" name="ln-2119" href="#ln-2119"></a><span class="w">                </span><span class="k">ENDDO</span>
<a id="ln-2120" name="ln-2120" href="#ln-2120"></a><span class="k">             END IF</span>
<a id="ln-2121" name="ln-2121" href="#ln-2121"></a><span class="k">          </span><span class="n">ELSEIF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_M</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. monthly LAI (BP apr08)</span>
<a id="ln-2122" name="ln-2122" href="#ln-2122"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch dependent LAI</span>
<a id="ln-2123" name="ln-2123" href="#ln-2123"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat4x</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2124" name="ln-2124" href="#ln-2124"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2125" name="ln-2125" href="#ln-2125"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2126" name="ln-2126" href="#ln-2126"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met3 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2127" name="ln-2127" href="#ln-2127"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2128" name="ln-2128" href="#ln-2128"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2129" name="ln-2129" href="#ln-2129"></a><span class="w">                   </span><span class="k">DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="w"></span>
<a id="ln-2130" name="ln-2130" href="#ln-2130"></a><span class="w">                      </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2131" name="ln-2131" href="#ln-2131"></a><span class="w">                           </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat4x</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2132" name="ln-2132" href="#ln-2132"></a><span class="w">                   </span><span class="k">ENDDO</span>
<a id="ln-2133" name="ln-2133" href="#ln-2133"></a><span class="k">                ENDDO</span>
<a id="ln-2134" name="ln-2134" href="#ln-2134"></a><span class="k">             ELSE</span><span class="w"> </span><span class="c">! i.e. patch independent LAI</span>
<a id="ln-2135" name="ln-2135" href="#ln-2135"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2136" name="ln-2136" href="#ln-2136"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2137" name="ln-2137" href="#ln-2137"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2138" name="ln-2138" href="#ln-2138"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met4 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2139" name="ln-2139" href="#ln-2139"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2140" name="ln-2140" href="#ln-2140"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2141" name="ln-2141" href="#ln-2141"></a><span class="w">                   </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2142" name="ln-2142" href="#ln-2142"></a><span class="w">                        </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2143" name="ln-2143" href="#ln-2143"></a><span class="w">                </span><span class="k">ENDDO</span>
<a id="ln-2144" name="ln-2144" href="#ln-2144"></a><span class="k">             END IF</span>
<a id="ln-2145" name="ln-2145" href="#ln-2145"></a><span class="k">          ELSE</span><span class="w"> </span><span class="c">! i.e. time independent LAI</span>
<a id="ln-2146" name="ln-2146" href="#ln-2146"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch dependent LAI</span>
<a id="ln-2147" name="ln-2147" href="#ln-2147"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat3x</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2148" name="ln-2148" href="#ln-2148"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2149" name="ln-2149" href="#ln-2149"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2150" name="ln-2150" href="#ln-2150"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met5 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2151" name="ln-2151" href="#ln-2151"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2152" name="ln-2152" href="#ln-2152"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2153" name="ln-2153" href="#ln-2153"></a><span class="w">                   </span><span class="k">DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nmetpatches</span><span class="w"></span>
<a id="ln-2154" name="ln-2154" href="#ln-2154"></a><span class="w">                      </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2155" name="ln-2155" href="#ln-2155"></a><span class="w">                           </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3x</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">j</span><span class="p">))</span><span class="w"></span>
<a id="ln-2156" name="ln-2156" href="#ln-2156"></a><span class="w">                   </span><span class="k">ENDDO</span>
<a id="ln-2157" name="ln-2157" href="#ln-2157"></a><span class="k">                ENDDO</span>
<a id="ln-2158" name="ln-2158" href="#ln-2158"></a><span class="k">             ELSE</span><span class="w"> </span><span class="c">! i.e. patch independent LAI</span>
<a id="ln-2159" name="ln-2159" href="#ln-2159"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2160" name="ln-2160" href="#ln-2160"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">xdimsize</span><span class="p">,</span><span class="n">ydimsize</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2161" name="ln-2161" href="#ln-2161"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2162" name="ln-2162" href="#ln-2162"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met6 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2163" name="ln-2163" href="#ln-2163"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2164" name="ln-2164" href="#ln-2164"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2165" name="ln-2165" href="#ln-2165"></a><span class="w">                   </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2166" name="ln-2166" href="#ln-2166"></a><span class="w">                        </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">land_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">land_y</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="w"></span>
<a id="ln-2167" name="ln-2167" href="#ln-2167"></a><span class="w">                </span><span class="k">ENDDO</span>
<a id="ln-2168" name="ln-2168" href="#ln-2168"></a><span class="k">             END IF</span>
<a id="ln-2169" name="ln-2169" href="#ln-2169"></a><span class="k">          END IF</span>
<a id="ln-2170" name="ln-2170" href="#ln-2170"></a><span class="k">       ELSE</span><span class="w"></span>
<a id="ln-2171" name="ln-2171" href="#ln-2171"></a><span class="w">          </span><span class="c">! If not in met file, use default LAI value:</span>
<a id="ln-2172" name="ln-2172" href="#ln-2172"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2173" name="ln-2173" href="#ln-2173"></a>
<a id="ln-2174" name="ln-2174" href="#ln-2174"></a><span class="w">             </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2175" name="ln-2175" href="#ln-2175"></a><span class="w">                  </span><span class="n">defaultLAI</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">))</span><span class="w"></span>
<a id="ln-2176" name="ln-2176" href="#ln-2176"></a>
<a id="ln-2177" name="ln-2177" href="#ln-2177"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2178" name="ln-2178" href="#ln-2178"></a><span class="k">       END IF</span>
<a id="ln-2179" name="ln-2179" href="#ln-2179"></a>
<a id="ln-2180" name="ln-2180" href="#ln-2180"></a>
<a id="ln-2181" name="ln-2181" href="#ln-2181"></a><span class="k">       DEALLOCATE</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="n">tmpDat4</span><span class="p">,</span><span class="n">tmpDat3x</span><span class="p">,</span><span class="n">tmpDat4x</span><span class="p">)</span><span class="w"></span>
<a id="ln-2182" name="ln-2182" href="#ln-2182"></a>
<a id="ln-2183" name="ln-2183" href="#ln-2183"></a><span class="w">    </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">metGrid</span><span class="o">==</span><span class="s1">&#39;land&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2184" name="ln-2184" href="#ln-2184"></a>
<a id="ln-2185" name="ln-2185" href="#ln-2185"></a><span class="w">       </span><span class="c">! Collect data from land only grid in netcdf file:</span>
<a id="ln-2186" name="ln-2186" href="#ln-2186"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat1</span><span class="p">(</span><span class="n">mland</span><span class="p">))</span><span class="w"></span>
<a id="ln-2187" name="ln-2187" href="#ln-2187"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2188" name="ln-2188" href="#ln-2188"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat2x</span><span class="p">(</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">))</span><span class="w"></span>
<a id="ln-2189" name="ln-2189" href="#ln-2189"></a><span class="w">       </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2190" name="ln-2190" href="#ln-2190"></a>
<a id="ln-2191" name="ln-2191" href="#ln-2191"></a><span class="w">       </span><span class="c">! Get SWdown data for land-only grid: - - - - - - - - - - - - -</span>
<a id="ln-2192" name="ln-2192" href="#ln-2192"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_sw</span><span class="w"></span>
<a id="ln-2193" name="ln-2193" href="#ln-2193"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">SWdown</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2194" name="ln-2194" href="#ln-2194"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2195" name="ln-2195" href="#ln-2195"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2196" name="ln-2196" href="#ln-2196"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading SWdown in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2197" name="ln-2197" href="#ln-2197"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2198" name="ln-2198" href="#ln-2198"></a><span class="w">       </span><span class="c">! Assign value to met data variable (no units change required):</span>
<a id="ln-2199" name="ln-2199" href="#ln-2199"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2200" name="ln-2200" href="#ln-2200"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2201" name="ln-2201" href="#ln-2201"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2202" name="ln-2202" href="#ln-2202"></a><span class="w">       </span><span class="k">ENDDO</span><span class="w"></span>
<a id="ln-2203" name="ln-2203" href="#ln-2203"></a>
<a id="ln-2204" name="ln-2204" href="#ln-2204"></a><span class="w">       </span><span class="c">! Get Tair data for land-only grid:- - - - - - - - - - - - - - -</span>
<a id="ln-2205" name="ln-2205" href="#ln-2205"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_ta</span><span class="w"></span>
<a id="ln-2206" name="ln-2206" href="#ln-2206"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Tair</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2207" name="ln-2207" href="#ln-2207"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2208" name="ln-2208" href="#ln-2208"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2209" name="ln-2209" href="#ln-2209"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Tair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2210" name="ln-2210" href="#ln-2210"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2211" name="ln-2211" href="#ln-2211"></a><span class="w">       </span><span class="c">! Assign value to met data variable with units change:</span>
<a id="ln-2212" name="ln-2212" href="#ln-2212"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2213" name="ln-2213" href="#ln-2213"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2214" name="ln-2214" href="#ln-2214"></a><span class="w">               </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Tair</span><span class="w"></span>
<a id="ln-2215" name="ln-2215" href="#ln-2215"></a><span class="w">       </span><span class="k">ENDDO</span><span class="w"></span>
<a id="ln-2216" name="ln-2216" href="#ln-2216"></a>
<a id="ln-2217" name="ln-2217" href="#ln-2217"></a><span class="w">       </span><span class="c">! Get PSurf data for land-only grid:- -- - - - - - - - - - - - - -</span>
<a id="ln-2218" name="ln-2218" href="#ln-2218"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_ps</span><span class="w"></span>
<a id="ln-2219" name="ln-2219" href="#ln-2219"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">PSurf</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! IF PSurf is in met file:</span>
<a id="ln-2220" name="ln-2220" href="#ln-2220"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">((</span><span class="n">ncciy</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1986</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">ktau</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2184</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2221" name="ln-2221" href="#ln-2221"></a><span class="w">             </span><span class="c">!hzz to fix the problem of ps data on time step 2184</span>
<a id="ln-2222" name="ln-2222" href="#ln-2222"></a><span class="w">             </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2223" name="ln-2223" href="#ln-2223"></a><span class="w">                  </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">2176</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"> </span><span class="c">! fixing bug in GSWP ps data</span>
<a id="ln-2224" name="ln-2224" href="#ln-2224"></a><span class="w">          </span><span class="k">ELSE</span>
<a id="ln-2225" name="ln-2225" href="#ln-2225"></a><span class="k">             </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">PSurf</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2226" name="ln-2226" href="#ln-2226"></a><span class="w">                  </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2227" name="ln-2227" href="#ln-2227"></a><span class="w">          </span><span class="k">ENDIF</span>
<a id="ln-2228" name="ln-2228" href="#ln-2228"></a><span class="k">          IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2229" name="ln-2229" href="#ln-2229"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading PSurf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2230" name="ln-2230" href="#ln-2230"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2231" name="ln-2231" href="#ln-2231"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2232" name="ln-2232" href="#ln-2232"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2233" name="ln-2233" href="#ln-2233"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">PSurf</span><span class="w"></span>
<a id="ln-2234" name="ln-2234" href="#ln-2234"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2235" name="ln-2235" href="#ln-2235"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! PSurf must be fixed as a function of site elevation and T:</span>
<a id="ln-2236" name="ln-2236" href="#ln-2236"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2237" name="ln-2237" href="#ln-2237"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">101</span><span class="mf">3.25</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2238" name="ln-2238" href="#ln-2238"></a><span class="w">                  </span><span class="o">*</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2239" name="ln-2239" href="#ln-2239"></a><span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="mf">0.0065</span><span class="o">*</span><span class="n">elevation</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span><span class="o">**</span><span class="p">(</span><span class="mf">9.80665</span><span class="o">/</span><span class="mi">28</span><span class="mf">7.04</span><span class="o">/</span><span class="mf">0.0065</span><span class="p">)</span><span class="w"></span>
<a id="ln-2240" name="ln-2240" href="#ln-2240"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2241" name="ln-2241" href="#ln-2241"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-2242" name="ln-2242" href="#ln-2242"></a>
<a id="ln-2243" name="ln-2243" href="#ln-2243"></a><span class="w">       </span><span class="c">! Get Qair data for land-only grid:- - - - - - - - - - - - - - - -</span>
<a id="ln-2244" name="ln-2244" href="#ln-2244"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_qa</span><span class="w"></span>
<a id="ln-2245" name="ln-2245" href="#ln-2245"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Qair</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2246" name="ln-2246" href="#ln-2246"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2247" name="ln-2247" href="#ln-2247"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2248" name="ln-2248" href="#ln-2248"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Qair in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2249" name="ln-2249" href="#ln-2249"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2250" name="ln-2250" href="#ln-2250"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">convert</span><span class="p">%</span><span class="n">Qair</span><span class="o">==-</span><span class="mi">99</span><span class="mf">9.0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2251" name="ln-2251" href="#ln-2251"></a><span class="k">          DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2252" name="ln-2252" href="#ln-2252"></a><span class="w">             </span><span class="k">CALL </span><span class="n">rh_sh</span><span class="p">(</span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2253" name="ln-2253" href="#ln-2253"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">),</span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">))</span><span class="w"></span>
<a id="ln-2254" name="ln-2254" href="#ln-2254"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="o">=</span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"></span>
<a id="ln-2255" name="ln-2255" href="#ln-2255"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2256" name="ln-2256" href="#ln-2256"></a><span class="k">       ELSE</span>
<a id="ln-2257" name="ln-2257" href="#ln-2257"></a><span class="k">          DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2258" name="ln-2258" href="#ln-2258"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2259" name="ln-2259" href="#ln-2259"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2260" name="ln-2260" href="#ln-2260"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-2261" name="ln-2261" href="#ln-2261"></a>
<a id="ln-2262" name="ln-2262" href="#ln-2262"></a><span class="w">       </span><span class="c">! Get Wind data for land-only grid: - - - - - - - - - - - - - - - -</span>
<a id="ln-2263" name="ln-2263" href="#ln-2263"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_wd</span><span class="w"></span>
<a id="ln-2264" name="ln-2264" href="#ln-2264"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">Wind</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! Scalar Wind</span>
<a id="ln-2265" name="ln-2265" href="#ln-2265"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2266" name="ln-2266" href="#ln-2266"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2267" name="ln-2267" href="#ln-2267"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2268" name="ln-2268" href="#ln-2268"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2269" name="ln-2269" href="#ln-2269"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2270" name="ln-2270" href="#ln-2270"></a><span class="w">          </span><span class="c">! Assign value to met data variable (no units change required):</span>
<a id="ln-2271" name="ln-2271" href="#ln-2271"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2272" name="ln-2272" href="#ln-2272"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2273" name="ln-2273" href="#ln-2273"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2274" name="ln-2274" href="#ln-2274"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! Vector wind</span>
<a id="ln-2275" name="ln-2275" href="#ln-2275"></a><span class="w">          </span><span class="c">! Get Wind_N:</span>
<a id="ln-2276" name="ln-2276" href="#ln-2276"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2277" name="ln-2277" href="#ln-2277"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2278" name="ln-2278" href="#ln-2278"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2279" name="ln-2279" href="#ln-2279"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind_N in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2280" name="ln-2280" href="#ln-2280"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2281" name="ln-2281" href="#ln-2281"></a><span class="w">          </span><span class="c">! write part of the wind variable</span>
<a id="ln-2282" name="ln-2282" href="#ln-2282"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(:)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(:,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2283" name="ln-2283" href="#ln-2283"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Wind_E</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2284" name="ln-2284" href="#ln-2284"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2285" name="ln-2285" href="#ln-2285"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2286" name="ln-2286" href="#ln-2286"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Wind_E in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2287" name="ln-2287" href="#ln-2287"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2288" name="ln-2288" href="#ln-2288"></a><span class="w">          </span><span class="c">! Write final scalar Wind value:</span>
<a id="ln-2289" name="ln-2289" href="#ln-2289"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2290" name="ln-2290" href="#ln-2290"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2291" name="ln-2291" href="#ln-2291"></a><span class="w">                  </span><span class="nb">SQRT</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="ln-2292" name="ln-2292" href="#ln-2292"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2293" name="ln-2293" href="#ln-2293"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-2294" name="ln-2294" href="#ln-2294"></a>
<a id="ln-2295" name="ln-2295" href="#ln-2295"></a><span class="w">       </span><span class="c">! Get Rainf and Snowf data for land-only grid: - - - - - - - - - - -</span>
<a id="ln-2296" name="ln-2296" href="#ln-2296"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_rain</span><span class="w"></span>
<a id="ln-2297" name="ln-2297" href="#ln-2297"></a><span class="w">       </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Rainf</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2298" name="ln-2298" href="#ln-2298"></a><span class="w">            </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2299" name="ln-2299" href="#ln-2299"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2300" name="ln-2300" href="#ln-2300"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Rainf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2301" name="ln-2301" href="#ln-2301"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2302" name="ln-2302" href="#ln-2302"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2303" name="ln-2303" href="#ln-2303"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2304" name="ln-2304" href="#ln-2304"></a><span class="w">       </span><span class="k">ENDDO</span>
<a id="ln-2305" name="ln-2305" href="#ln-2305"></a>
<a id="ln-2306" name="ln-2306" href="#ln-2306"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_snow</span><span class="w"></span>
<a id="ln-2307" name="ln-2307" href="#ln-2307"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2308" name="ln-2308" href="#ln-2308"></a><span class="k">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">Snowf</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2309" name="ln-2309" href="#ln-2309"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2310" name="ln-2310" href="#ln-2310"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2311" name="ln-2311" href="#ln-2311"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading Snowf in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2312" name="ln-2312" href="#ln-2312"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2313" name="ln-2313" href="#ln-2313"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2314" name="ln-2314" href="#ln-2314"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2315" name="ln-2315" href="#ln-2315"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2316" name="ln-2316" href="#ln-2316"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2317" name="ln-2317" href="#ln-2317"></a><span class="k">       ELSE</span>
<a id="ln-2318" name="ln-2318" href="#ln-2318"></a><span class="k">          </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-2319" name="ln-2319" href="#ln-2319"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-2320" name="ln-2320" href="#ln-2320"></a>
<a id="ln-2321" name="ln-2321" href="#ln-2321"></a><span class="w">       </span><span class="c">! combine Rainf and Snowf data</span>
<a id="ln-2322" name="ln-2322" href="#ln-2322"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"></span>
<a id="ln-2323" name="ln-2323" href="#ln-2323"></a><span class="w">       </span><span class="c">! Convert units:</span>
<a id="ln-2324" name="ln-2324" href="#ln-2324"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(:)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-2325" name="ln-2325" href="#ln-2325"></a><span class="w">       </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(:)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">convert</span><span class="p">%</span><span class="n">Rainf</span><span class="w"></span>
<a id="ln-2326" name="ln-2326" href="#ln-2326"></a><span class="w">       </span><span class="c">! If we&#39;re performing a spinup, the spinup hasn&#39;t converged,</span>
<a id="ln-2327" name="ln-2327" href="#ln-2327"></a><span class="w">       </span><span class="c">! and an avPrecip variable has been found, modify precip to</span>
<a id="ln-2328" name="ln-2328" href="#ln-2328"></a><span class="w">       </span><span class="c">! ensure reasonable equilibration:</span>
<a id="ln-2329" name="ln-2329" href="#ln-2329"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">spinup</span><span class="p">.</span><span class="nb">AND</span><span class="p">.(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">spinConv</span><span class="p">).</span><span class="nb">AND</span><span class="p">.</span><span class="n">exists</span><span class="p">%</span><span class="n">avPrecip</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2330" name="ln-2330" href="#ln-2330"></a><span class="w">          </span><span class="c">! Rescale precip to average rainfall for this site:</span>
<a id="ln-2331" name="ln-2331" href="#ln-2331"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2332" name="ln-2332" href="#ln-2332"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2333" name="ln-2333" href="#ln-2333"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PrecipScale</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<a id="ln-2334" name="ln-2334" href="#ln-2334"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2335" name="ln-2335" href="#ln-2335"></a><span class="w">                  </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">PrecipScale</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<a id="ln-2336" name="ln-2336" href="#ln-2336"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2337" name="ln-2337" href="#ln-2337"></a><span class="k">       END IF</span><span class="w"></span>
<a id="ln-2338" name="ln-2338" href="#ln-2338"></a>
<a id="ln-2339" name="ln-2339" href="#ln-2339"></a><span class="w">       </span><span class="c">! Get LWdown data for land-only grid: - - - - - - - - - - - - - -</span>
<a id="ln-2340" name="ln-2340" href="#ln-2340"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ncciy</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">ncid_met</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ncid_lw</span><span class="w"></span>
<a id="ln-2341" name="ln-2341" href="#ln-2341"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LWdown</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If LWdown exists in met file</span>
<a id="ln-2342" name="ln-2342" href="#ln-2342"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LWdown</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2343" name="ln-2343" href="#ln-2343"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2344" name="ln-2344" href="#ln-2344"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2345" name="ln-2345" href="#ln-2345"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LWdown in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2346" name="ln-2346" href="#ln-2346"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2347" name="ln-2347" href="#ln-2347"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2348" name="ln-2348" href="#ln-2348"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">fld</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2349" name="ln-2349" href="#ln-2349"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2350" name="ln-2350" href="#ln-2350"></a><span class="k">       ELSE</span><span class="w"> </span><span class="c">! Synthesise LWdown based on temperature</span>
<a id="ln-2351" name="ln-2351" href="#ln-2351"></a><span class="w">          </span><span class="c">! Use Swinbank formula:</span>
<a id="ln-2352" name="ln-2352" href="#ln-2352"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">fld</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0000094</span><span class="o">*</span><span class="mf">0.0000000567</span><span class="o">*</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(:)</span><span class="o">**</span><span class="mf">6.0</span><span class="p">)</span><span class="w"></span>
<a id="ln-2353" name="ln-2353" href="#ln-2353"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-2354" name="ln-2354" href="#ln-2354"></a>
<a id="ln-2355" name="ln-2355" href="#ln-2355"></a><span class="w">       </span><span class="c">! Get CO2air data for land-only grid:- - - - - - - - - - - - - -</span>
<a id="ln-2356" name="ln-2356" href="#ln-2356"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">CO2air</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If CO2air exists in met file</span>
<a id="ln-2357" name="ln-2357" href="#ln-2357"></a><span class="w">          </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">CO2air</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2358" name="ln-2358" href="#ln-2358"></a><span class="w">               </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2359" name="ln-2359" href="#ln-2359"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2360" name="ln-2360" href="#ln-2360"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading CO2air in met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2361" name="ln-2361" href="#ln-2361"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2362" name="ln-2362" href="#ln-2362"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2363" name="ln-2363" href="#ln-2363"></a><span class="w">             </span><span class="n">met</span><span class="p">%</span><span class="n">ca</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2364" name="ln-2364" href="#ln-2364"></a><span class="w">                  </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">100000</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-2365" name="ln-2365" href="#ln-2365"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2366" name="ln-2366" href="#ln-2366"></a><span class="k">       ELSE</span>
<a id="ln-2367" name="ln-2367" href="#ln-2367"></a><span class="k">          </span><span class="n">met</span><span class="p">%</span><span class="n">ca</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fixedCO2</span><span class="w"> </span><span class="o">/</span><span class="mi">100000</span><span class="mf">0.0</span><span class="w"></span>
<a id="ln-2368" name="ln-2368" href="#ln-2368"></a><span class="w">       </span><span class="k">END IF</span><span class="w"></span>
<a id="ln-2369" name="ln-2369" href="#ln-2369"></a>
<a id="ln-2370" name="ln-2370" href="#ln-2370"></a><span class="w">       </span><span class="c">! Get LAI data, if it exists, for land-only grid:- - - - - - - - -</span>
<a id="ln-2371" name="ln-2371" href="#ln-2371"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! If LAI exists in met file</span>
<a id="ln-2372" name="ln-2372" href="#ln-2372"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_T</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. time dependent LAI</span>
<a id="ln-2373" name="ln-2373" href="#ln-2373"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch dependent LAI</span>
<a id="ln-2374" name="ln-2374" href="#ln-2374"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2375" name="ln-2375" href="#ln-2375"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2376" name="ln-2376" href="#ln-2376"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2377" name="ln-2377" href="#ln-2377"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met7 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2378" name="ln-2378" href="#ln-2378"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2379" name="ln-2379" href="#ln-2379"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2380" name="ln-2380" href="#ln-2380"></a><span class="w">                   </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nmetpatches</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2381" name="ln-2381" href="#ln-2381"></a><span class="k">                      PRINT</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;not enough patches at land point &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<a id="ln-2382" name="ln-2382" href="#ln-2382"></a><span class="w">                      </span><span class="k">STOP</span>
<a id="ln-2383" name="ln-2383" href="#ln-2383"></a><span class="k">                   END IF</span>
<a id="ln-2384" name="ln-2384" href="#ln-2384"></a><span class="k">                   DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nmetpatches</span><span class="w"></span>
<a id="ln-2385" name="ln-2385" href="#ln-2385"></a><span class="w">                      </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2386" name="ln-2386" href="#ln-2386"></a><span class="w">                   </span><span class="k">ENDDO</span>
<a id="ln-2387" name="ln-2387" href="#ln-2387"></a><span class="k">                ENDDO</span>
<a id="ln-2388" name="ln-2388" href="#ln-2388"></a><span class="k">             ELSE</span><span class="w"> </span><span class="c">! i.e. patch independent LAI</span>
<a id="ln-2389" name="ln-2389" href="#ln-2389"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2390" name="ln-2390" href="#ln-2390"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">ktau</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2391" name="ln-2391" href="#ln-2391"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2392" name="ln-2392" href="#ln-2392"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met8 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2393" name="ln-2393" href="#ln-2393"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2394" name="ln-2394" href="#ln-2394"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2395" name="ln-2395" href="#ln-2395"></a><span class="w">                   </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2396" name="ln-2396" href="#ln-2396"></a><span class="w">                        </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2397" name="ln-2397" href="#ln-2397"></a><span class="w">                </span><span class="k">ENDDO</span>
<a id="ln-2398" name="ln-2398" href="#ln-2398"></a><span class="k">             END IF</span>
<a id="ln-2399" name="ln-2399" href="#ln-2399"></a><span class="k">          </span><span class="n">ELSEIF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_M</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. monthly LAI (BP apr08)</span>
<a id="ln-2400" name="ln-2400" href="#ln-2400"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch dependent LAI</span>
<a id="ln-2401" name="ln-2401" href="#ln-2401"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2402" name="ln-2402" href="#ln-2402"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2403" name="ln-2403" href="#ln-2403"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2404" name="ln-2404" href="#ln-2404"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met9 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2405" name="ln-2405" href="#ln-2405"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2406" name="ln-2406" href="#ln-2406"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2407" name="ln-2407" href="#ln-2407"></a><span class="w">                   </span><span class="k">DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nmetpatches</span><span class="w"></span>
<a id="ln-2408" name="ln-2408" href="#ln-2408"></a><span class="w">                      </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2409" name="ln-2409" href="#ln-2409"></a><span class="w">                   </span><span class="k">ENDDO</span>
<a id="ln-2410" name="ln-2410" href="#ln-2410"></a><span class="k">                ENDDO</span>
<a id="ln-2411" name="ln-2411" href="#ln-2411"></a><span class="k">             ELSE</span><span class="w"> </span><span class="c">! i.e. patch independent LAI</span>
<a id="ln-2412" name="ln-2412" href="#ln-2412"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2413" name="ln-2413" href="#ln-2413"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2414" name="ln-2414" href="#ln-2414"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2415" name="ln-2415" href="#ln-2415"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met10 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2416" name="ln-2416" href="#ln-2416"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2417" name="ln-2417" href="#ln-2417"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2418" name="ln-2418" href="#ln-2418"></a><span class="w">                   </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2419" name="ln-2419" href="#ln-2419"></a><span class="w">                        </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="w"></span>
<a id="ln-2420" name="ln-2420" href="#ln-2420"></a><span class="w">                </span><span class="k">ENDDO</span>
<a id="ln-2421" name="ln-2421" href="#ln-2421"></a><span class="k">             END IF</span>
<a id="ln-2422" name="ln-2422" href="#ln-2422"></a><span class="k">          ELSE</span><span class="w"> </span><span class="c">! LAI time independent</span>
<a id="ln-2423" name="ln-2423" href="#ln-2423"></a><span class="w">             </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">LAI_P</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! i.e. patch dependent LAI</span>
<a id="ln-2424" name="ln-2424" href="#ln-2424"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat2x</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2425" name="ln-2425" href="#ln-2425"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="p">,</span><span class="n">nmetpatches</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2426" name="ln-2426" href="#ln-2426"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2427" name="ln-2427" href="#ln-2427"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met11 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2428" name="ln-2428" href="#ln-2428"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2429" name="ln-2429" href="#ln-2429"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2430" name="ln-2430" href="#ln-2430"></a><span class="w">                   </span><span class="k">DO </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nmetpatches</span><span class="w"></span>
<a id="ln-2431" name="ln-2431" href="#ln-2431"></a><span class="w">                      </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="o">+</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat2x</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="w"></span>
<a id="ln-2432" name="ln-2432" href="#ln-2432"></a><span class="w">                   </span><span class="k">ENDDO</span>
<a id="ln-2433" name="ln-2433" href="#ln-2433"></a><span class="k">                ENDDO</span>
<a id="ln-2434" name="ln-2434" href="#ln-2434"></a><span class="k">             ELSE</span><span class="w"> </span><span class="c">! i.e. patch independent LAI</span>
<a id="ln-2435" name="ln-2435" href="#ln-2435"></a><span class="w">                </span><span class="n">ok</span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="n">id</span><span class="p">%</span><span class="n">LAI</span><span class="p">,</span><span class="n">tmpDat1</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2436" name="ln-2436" href="#ln-2436"></a><span class="w">                     </span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">mland</span><span class="o">/</span><span class="p">))</span><span class="w"></span>
<a id="ln-2437" name="ln-2437" href="#ln-2437"></a><span class="w">                </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2438" name="ln-2438" href="#ln-2438"></a><span class="w">                     </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error reading LAI in met12 data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2439" name="ln-2439" href="#ln-2439"></a><span class="w">                     </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE get_met_data)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2440" name="ln-2440" href="#ln-2440"></a><span class="w">                </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2441" name="ln-2441" href="#ln-2441"></a><span class="w">                   </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">REAL</span><span class="p">(</span><span class="n">tmpDat1</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"></span>
<a id="ln-2442" name="ln-2442" href="#ln-2442"></a><span class="w">                </span><span class="k">ENDDO</span>
<a id="ln-2443" name="ln-2443" href="#ln-2443"></a><span class="k">             END IF</span>
<a id="ln-2444" name="ln-2444" href="#ln-2444"></a><span class="k">          END IF</span>
<a id="ln-2445" name="ln-2445" href="#ln-2445"></a><span class="k">       ELSE</span><span class="w"></span>
<a id="ln-2446" name="ln-2446" href="#ln-2446"></a><span class="w">          </span><span class="c">! If not in met file, use default LAI value:</span>
<a id="ln-2447" name="ln-2447" href="#ln-2447"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2448" name="ln-2448" href="#ln-2448"></a><span class="w">             </span><span class="c">!! vh_js !! corrected indices of defaultLAI</span>
<a id="ln-2449" name="ln-2449" href="#ln-2449"></a><span class="w">             </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2450" name="ln-2450" href="#ln-2450"></a><span class="w">                  </span><span class="n">defaultLAI</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">,</span><span class="n">met</span><span class="p">%</span><span class="n">moy</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">))</span><span class="w"></span>
<a id="ln-2451" name="ln-2451" href="#ln-2451"></a>
<a id="ln-2452" name="ln-2452" href="#ln-2452"></a>
<a id="ln-2453" name="ln-2453" href="#ln-2453"></a>
<a id="ln-2454" name="ln-2454" href="#ln-2454"></a><span class="w">          </span><span class="k">ENDDO</span>
<a id="ln-2455" name="ln-2455" href="#ln-2455"></a>
<a id="ln-2456" name="ln-2456" href="#ln-2456"></a><span class="k">       END IF</span>
<a id="ln-2457" name="ln-2457" href="#ln-2457"></a><span class="k">       DEALLOCATE</span><span class="p">(</span><span class="n">tmpDat1</span><span class="p">,</span><span class="w"> </span><span class="n">tmpDat2</span><span class="p">,</span><span class="w"> </span><span class="n">tmpDat3</span><span class="p">,</span><span class="w"> </span><span class="n">tmpDat2x</span><span class="p">)</span><span class="w"></span>
<a id="ln-2458" name="ln-2458" href="#ln-2458"></a>
<a id="ln-2459" name="ln-2459" href="#ln-2459"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-2460" name="ln-2460" href="#ln-2460"></a><span class="k">       CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Unrecognised grid type&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2461" name="ln-2461" href="#ln-2461"></a><span class="w">    </span><span class="k">END IF</span><span class="w"> </span><span class="c">! grid type</span>
<a id="ln-2462" name="ln-2462" href="#ln-2462"></a>
<a id="ln-2463" name="ln-2463" href="#ln-2463"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">((.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">exists</span><span class="p">%</span><span class="n">Snowf</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="k">ALL</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">))</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! honour snowf input</span>
<a id="ln-2464" name="ln-2464" href="#ln-2464"></a><span class="w">       </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mland</span><span class="w"> </span><span class="c">! over all land points/grid cells</span>
<a id="ln-2465" name="ln-2465" href="#ln-2465"></a><span class="w">          </span><span class="c">! Set solid precip based on temp</span>
<a id="ln-2466" name="ln-2466" href="#ln-2466"></a><span class="w">          </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="c">! (EK nov2007)</span>
<a id="ln-2467" name="ln-2467" href="#ln-2467"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tfrz</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2468" name="ln-2468" href="#ln-2468"></a><span class="w">               </span><span class="n">met</span><span class="p">%</span><span class="n">precip_sn</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">:</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cend</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2469" name="ln-2469" href="#ln-2469"></a><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cstart</span><span class="p">)</span><span class="w"> </span><span class="c">! (EK nov2007)</span>
<a id="ln-2470" name="ln-2470" href="#ln-2470"></a><span class="w">       </span><span class="k">END DO</span><span class="w"> </span><span class="c">! 1, mland over all land grid points</span>
<a id="ln-2471" name="ln-2471" href="#ln-2471"></a><span class="w">    </span><span class="k">ENDIF</span><span class="w"></span>
<a id="ln-2472" name="ln-2472" href="#ln-2472"></a>
<a id="ln-2473" name="ln-2473" href="#ln-2473"></a><span class="w">    </span><span class="c">! Set cosine of zenith angle (provided by GCM when online):</span>
<a id="ln-2474" name="ln-2474" href="#ln-2474"></a><span class="w">    </span><span class="n">met</span><span class="p">%</span><span class="n">coszen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinbet</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">doy</span><span class="p">,</span><span class="w"> </span><span class="n">rad</span><span class="p">%</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">hod</span><span class="p">)</span><span class="w"></span>
<a id="ln-2475" name="ln-2475" href="#ln-2475"></a><span class="w">    </span><span class="c">! initialise within canopy air temp</span>
<a id="ln-2476" name="ln-2476" href="#ln-2476"></a><span class="w">    </span><span class="n">met</span><span class="p">%</span><span class="n">tvair</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="w"></span>
<a id="ln-2477" name="ln-2477" href="#ln-2477"></a><span class="w">    </span><span class="n">met</span><span class="p">%</span><span class="n">tvrad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="w"></span>
<a id="ln-2478" name="ln-2478" href="#ln-2478"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">check</span><span class="p">%</span><span class="n">ranges</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2479" name="ln-2479" href="#ln-2479"></a><span class="w">       </span><span class="c">! Check ranges are okay:</span>
<a id="ln-2480" name="ln-2480" href="#ln-2480"></a><span class="w">       </span><span class="c">!jhan:quick fix, use dimension 1 here arbitrarily</span>
<a id="ln-2481" name="ln-2481" href="#ln-2481"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2482" name="ln-2482" href="#ln-2482"></a><span class="w">            </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;SWdown out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2483" name="ln-2483" href="#ln-2483"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">fsd</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">SWdown</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2484" name="ln-2484" href="#ln-2484"></a><span class="w">            </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;SWdown out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2485" name="ln-2485" href="#ln-2485"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">fld</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">LWdown</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">fld</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">LWdown</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2486" name="ln-2486" href="#ln-2486"></a><span class="w">            </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;LWdown out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2487" name="ln-2487" href="#ln-2487"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">qv</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Qair</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2488" name="ln-2488" href="#ln-2488"></a><span class="w">            </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Qair out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2489" name="ln-2489" href="#ln-2489"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">precip</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Rainf</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2490" name="ln-2490" href="#ln-2490"></a><span class="k">          CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Rainf out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2491" name="ln-2491" href="#ln-2491"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-2492" name="ln-2492" href="#ln-2492"></a><span class="k">       IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Wind</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">ua</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Wind</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2493" name="ln-2493" href="#ln-2493"></a><span class="w">            </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Wind out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2494" name="ln-2494" href="#ln-2494"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Tair</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">tk</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">Tair</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2495" name="ln-2495" href="#ln-2495"></a><span class="w">            </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Tair out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2496" name="ln-2496" href="#ln-2496"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="o">&lt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nb">OR</span><span class="p">.</span><span class="nb">ANY</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="o">&gt;</span><span class="n">ranges</span><span class="p">%</span><span class="n">PSurf</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2497" name="ln-2497" href="#ln-2497"></a><span class="k">          WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;min, max Psurf&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">MINVAL</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">),</span><span class="w"> </span><span class="nb">MAXVAL</span><span class="p">(</span><span class="n">met</span><span class="p">%</span><span class="n">pmb</span><span class="p">),</span><span class="n">ranges</span><span class="p">%</span><span class="n">Psurf</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">ranges</span><span class="p">%</span><span class="n">Psurf</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"></span>
<a id="ln-2498" name="ln-2498" href="#ln-2498"></a><span class="w">          </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;PSurf out of specified ranges!&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2499" name="ln-2499" href="#ln-2499"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-2500" name="ln-2500" href="#ln-2500"></a><span class="k">    END IF</span>
<a id="ln-2501" name="ln-2501" href="#ln-2501"></a>
<a id="ln-2502" name="ln-2502" href="#ln-2502"></a><span class="k">  END SUBROUTINE </span><span class="n">get_met_data</span><span class="w"></span>
<a id="ln-2503" name="ln-2503" href="#ln-2503"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2504" name="ln-2504" href="#ln-2504"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2505" name="ln-2505" href="#ln-2505"></a><span class="w">  </span><span class="c">! Name: close_met_file</span>
<a id="ln-2506" name="ln-2506" href="#ln-2506"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2507" name="ln-2507" href="#ln-2507"></a><span class="w">  </span><span class="c">! Purpose: Close the file with the meteorological data</span>
<a id="ln-2508" name="ln-2508" href="#ln-2508"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2509" name="ln-2509" href="#ln-2509"></a><span class="w">  </span><span class="c">! CALLed from: cable_offline_driver</span>
<a id="ln-2510" name="ln-2510" href="#ln-2510"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2511" name="ln-2511" href="#ln-2511"></a><span class="w">  </span><span class="c">! CALLs: nc_abort</span>
<a id="ln-2512" name="ln-2512" href="#ln-2512"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2513" name="ln-2513" href="#ln-2513"></a><span class="w">  </span><span class="c">! Input file: [SiteName].nc</span>
<a id="ln-2514" name="ln-2514" href="#ln-2514"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2515" name="ln-2515" href="#ln-2515"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2516" name="ln-2516" href="#ln-2516"></a>
<a id="ln-2517" name="ln-2517" href="#ln-2517"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">close_met_file</span><span class="w"></span>
<a id="ln-2518" name="ln-2518" href="#ln-2518"></a>
<a id="ln-2519" name="ln-2519" href="#ln-2519"></a><span class="w">    </span><span class="n">ok</span><span class="o">=</span><span class="n">NF90_CLOSE</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">)</span><span class="w"></span>
<a id="ln-2520" name="ln-2520" href="#ln-2520"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error closing met data file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2521" name="ln-2521" href="#ln-2521"></a><span class="w">         </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE close_met_file)&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2522" name="ln-2522" href="#ln-2522"></a><span class="w">    </span><span class="c">! Clear lat_all and lon_all variables</span>
<a id="ln-2523" name="ln-2523" href="#ln-2523"></a>
<a id="ln-2524" name="ln-2524" href="#ln-2524"></a><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">close_met_file</span><span class="w"></span>
<a id="ln-2525" name="ln-2525" href="#ln-2525"></a>
<a id="ln-2526" name="ln-2526" href="#ln-2526"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2527" name="ln-2527" href="#ln-2527"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2528" name="ln-2528" href="#ln-2528"></a><span class="w">  </span><span class="c">! Name: load_parameters</span>
<a id="ln-2529" name="ln-2529" href="#ln-2529"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2530" name="ln-2530" href="#ln-2530"></a><span class="w">  </span><span class="c">! Purpose: Checks where parameters and initialisations should be loaded from.</span>
<a id="ln-2531" name="ln-2531" href="#ln-2531"></a><span class="w">  </span><span class="c">!          If they can be found in either the met file or restart file, they</span>
<a id="ln-2532" name="ln-2532" href="#ln-2532"></a><span class="w">  </span><span class="c">!          will load from there, with the met file taking precedence. Otherwise,</span>
<a id="ln-2533" name="ln-2533" href="#ln-2533"></a><span class="w">  </span><span class="c">!          they&#39;ll be chosen from a coarse global grid of veg and soil types,</span>
<a id="ln-2534" name="ln-2534" href="#ln-2534"></a><span class="w">  </span><span class="c">!          based on the lat/lon coordinates.</span>
<a id="ln-2535" name="ln-2535" href="#ln-2535"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2536" name="ln-2536" href="#ln-2536"></a><span class="w">  </span><span class="c">! CALLed from: cable_offline_driver</span>
<a id="ln-2537" name="ln-2537" href="#ln-2537"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2538" name="ln-2538" href="#ln-2538"></a><span class="w">  </span><span class="c">! CALLs: get_default_params</span>
<a id="ln-2539" name="ln-2539" href="#ln-2539"></a><span class="w">  </span><span class="c">!        allocate_cable_vars</span>
<a id="ln-2540" name="ln-2540" href="#ln-2540"></a><span class="w">  </span><span class="c">!        alloc_casavariable</span>
<a id="ln-2541" name="ln-2541" href="#ln-2541"></a><span class="w">  </span><span class="c">!        alloc_phenvariable</span>
<a id="ln-2542" name="ln-2542" href="#ln-2542"></a><span class="w">  </span><span class="c">!        write_default_params</span>
<a id="ln-2543" name="ln-2543" href="#ln-2543"></a><span class="w">  </span><span class="c">!        write_cnp_params</span>
<a id="ln-2544" name="ln-2544" href="#ln-2544"></a><span class="w">  </span><span class="c">!        casa_readbiome</span>
<a id="ln-2545" name="ln-2545" href="#ln-2545"></a><span class="w">  </span><span class="c">!        casa_readphen</span>
<a id="ln-2546" name="ln-2546" href="#ln-2546"></a><span class="w">  </span><span class="c">!        casa_init</span>
<a id="ln-2547" name="ln-2547" href="#ln-2547"></a><span class="w">  </span><span class="c">!        abort</span>
<a id="ln-2548" name="ln-2548" href="#ln-2548"></a><span class="w">  </span><span class="c">!        get_restart_data</span>
<a id="ln-2549" name="ln-2549" href="#ln-2549"></a><span class="w">  </span><span class="c">!        get_parameters_met</span>
<a id="ln-2550" name="ln-2550" href="#ln-2550"></a><span class="w">  </span><span class="c">!        derived_parameters</span>
<a id="ln-2551" name="ln-2551" href="#ln-2551"></a><span class="w">  </span><span class="c">!        check_parameter_values</span>
<a id="ln-2552" name="ln-2552" href="#ln-2552"></a><span class="w">  </span><span class="c">!        report_parameters</span>
<a id="ln-2553" name="ln-2553" href="#ln-2553"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2554" name="ln-2554" href="#ln-2554"></a><span class="w">  </span><span class="c">! Input file: [restart].nc</span>
<a id="ln-2555" name="ln-2555" href="#ln-2555"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2556" name="ln-2556" href="#ln-2556"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2557" name="ln-2557" href="#ln-2557"></a>
<a id="ln-2558" name="ln-2558" href="#ln-2558"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">load_parameters</span><span class="p">(</span><span class="n">met</span><span class="p">,</span><span class="n">air</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">climate</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">canopy</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2559" name="ln-2559" href="#ln-2559"></a><span class="w">       </span><span class="n">sum_flux</span><span class="p">,</span><span class="n">bal</span><span class="p">,</span><span class="n">logn</span><span class="p">,</span><span class="n">vegparmnew</span><span class="p">,</span><span class="n">casabiome</span><span class="p">,</span><span class="n">casapool</span><span class="p">,</span><span class="w">    </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2560" name="ln-2560" href="#ln-2560"></a><span class="w">       </span><span class="n">casaflux</span><span class="p">,</span><span class="n">sum_casapool</span><span class="p">,</span><span class="w"> </span><span class="n">sum_casaflux</span><span class="p">,</span><span class="n">casamet</span><span class="p">,</span><span class="n">casabal</span><span class="p">,</span><span class="n">phen</span><span class="p">,</span><span class="n">POP</span><span class="p">,</span><span class="n">spinup</span><span class="p">,</span><span class="n">EMSOIL</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2561" name="ln-2561" href="#ln-2561"></a><span class="w">       </span><span class="n">TFRZ</span><span class="p">,</span><span class="w"> </span><span class="n">LUC_EXPT</span><span class="p">,</span><span class="w"> </span><span class="n">POPLUC</span><span class="p">)</span><span class="w"></span>
<a id="ln-2562" name="ln-2562" href="#ln-2562"></a><span class="w">    </span><span class="c">! Input variables not listed:</span>
<a id="ln-2563" name="ln-2563" href="#ln-2563"></a><span class="w">    </span><span class="c">!   filename%type  - via cable_IO_vars_module</span>
<a id="ln-2564" name="ln-2564" href="#ln-2564"></a><span class="w">    </span><span class="c">!   exists%type    - via cable_IO_vars_module</span>
<a id="ln-2565" name="ln-2565" href="#ln-2565"></a><span class="w">    </span><span class="c">!   smoy           - via cable_IO_vars_module</span>
<a id="ln-2566" name="ln-2566" href="#ln-2566"></a><span class="w">    </span><span class="c">! Output variables not listed:</span>
<a id="ln-2567" name="ln-2567" href="#ln-2567"></a><span class="w">    </span><span class="c">!   (determined here or from sub get_default_params &lt;- countPatch)</span>
<a id="ln-2568" name="ln-2568" href="#ln-2568"></a><span class="w">    </span><span class="c">!   landpt%type    - via cable_IO_vars_module (nap,cstart,cend,ilon,ilat)</span>
<a id="ln-2569" name="ln-2569" href="#ln-2569"></a><span class="w">    </span><span class="c">!   max_vegpatches - via cable_IO_vars_module</span>
<a id="ln-2570" name="ln-2570" href="#ln-2570"></a><span class="w">    </span><span class="c">!! vh_js !!</span>
<a id="ln-2571" name="ln-2571" href="#ln-2571"></a><span class="w">    </span><span class="k">USE </span><span class="n">POPmodule</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">POP_INIT</span><span class="w"></span>
<a id="ln-2572" name="ln-2572" href="#ln-2572"></a><span class="w">    </span><span class="k">USE </span><span class="n">POPLUC_module</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">POPLUC_INIT</span><span class="w"></span>
<a id="ln-2573" name="ln-2573" href="#ln-2573"></a><span class="w">    </span><span class="k">USE </span><span class="n">CABLE_LUC_EXPT</span><span class="p">,</span><span class="w"> </span><span class="k">ONLY</span><span class="p">:</span><span class="w"> </span><span class="n">LUC_EXPT_TYPE</span><span class="w"></span>
<a id="ln-2574" name="ln-2574" href="#ln-2574"></a>
<a id="ln-2575" name="ln-2575" href="#ln-2575"></a><span class="w">    </span><span class="k">IMPLICIT NONE</span><span class="w"></span>
<a id="ln-2576" name="ln-2576" href="#ln-2576"></a>
<a id="ln-2577" name="ln-2577" href="#ln-2577"></a><span class="w">    </span><span class="c">! Input arguments</span>
<a id="ln-2578" name="ln-2578" href="#ln-2578"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">met_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">met</span><span class="w"></span>
<a id="ln-2579" name="ln-2579" href="#ln-2579"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">air_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">air</span><span class="w"></span>
<a id="ln-2580" name="ln-2580" href="#ln-2580"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">soil_snow_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">ssnow</span><span class="w"></span>
<a id="ln-2581" name="ln-2581" href="#ln-2581"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">veg_parameter_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">veg</span><span class="w"></span>
<a id="ln-2582" name="ln-2582" href="#ln-2582"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">climate_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">climate</span><span class="w"></span>
<a id="ln-2583" name="ln-2583" href="#ln-2583"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">bgc_pool_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">bgc</span><span class="w"></span>
<a id="ln-2584" name="ln-2584" href="#ln-2584"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">soil_parameter_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">soil</span><span class="w"></span>
<a id="ln-2585" name="ln-2585" href="#ln-2585"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">canopy_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">canopy</span><span class="w"></span>
<a id="ln-2586" name="ln-2586" href="#ln-2586"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">roughness_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">rough</span><span class="w"></span>
<a id="ln-2587" name="ln-2587" href="#ln-2587"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">radiation_type</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">rad</span><span class="w"></span>
<a id="ln-2588" name="ln-2588" href="#ln-2588"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">sum_flux_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">sum_flux</span><span class="w"></span>
<a id="ln-2589" name="ln-2589" href="#ln-2589"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">balances_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">bal</span><span class="w"></span>
<a id="ln-2590" name="ln-2590" href="#ln-2590"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_biome</span><span class="p">)</span><span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">casabiome</span><span class="w"></span>
<a id="ln-2591" name="ln-2591" href="#ln-2591"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_pool</span><span class="p">)</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">casapool</span><span class="w"></span>
<a id="ln-2592" name="ln-2592" href="#ln-2592"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_flux</span><span class="p">)</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">casaflux</span><span class="w"></span>
<a id="ln-2593" name="ln-2593" href="#ln-2593"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_pool</span><span class="p">)</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">sum_casapool</span><span class="w"></span>
<a id="ln-2594" name="ln-2594" href="#ln-2594"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_flux</span><span class="p">)</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">sum_casaflux</span><span class="w"></span>
<a id="ln-2595" name="ln-2595" href="#ln-2595"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_met</span><span class="p">)</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">casamet</span><span class="w"></span>
<a id="ln-2596" name="ln-2596" href="#ln-2596"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">casa_balance</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">casabal</span><span class="w"></span>
<a id="ln-2597" name="ln-2597" href="#ln-2597"></a><span class="w">    </span><span class="k">TYPE</span><span class="p">(</span><span class="n">phen_variable</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">        </span><span class="kd">::</span><span class="w"> </span><span class="n">phen</span><span class="w"></span>
<a id="ln-2598" name="ln-2598" href="#ln-2598"></a><span class="w">    </span><span class="k">TYPE</span><span class="p">(</span><span class="w"> </span><span class="n">POP_TYPE</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">POP</span><span class="w"></span>
<a id="ln-2599" name="ln-2599" href="#ln-2599"></a><span class="w">    </span><span class="k">TYPE</span><span class="p">(</span><span class="w"> </span><span class="n">POPLUC_TYPE</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">POPLUC</span><span class="w"></span>
<a id="ln-2600" name="ln-2600" href="#ln-2600"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">LUC_EXPT_TYPE</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">LUC_EXPT</span><span class="w"></span>
<a id="ln-2601" name="ln-2601" href="#ln-2601"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">                      </span><span class="kd">::</span><span class="w"> </span><span class="n">logn</span><span class="w">     </span><span class="c">! log file unit number</span>
<a id="ln-2602" name="ln-2602" href="#ln-2602"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">                      </span><span class="kd">::</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2603" name="ln-2603" href="#ln-2603"></a><span class="w">         </span><span class="n">vegparmnew</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w">  </span><span class="c">! are we using the new format?</span>
<a id="ln-2604" name="ln-2604" href="#ln-2604"></a><span class="w">                                </span><span class="c">!! vh_js !!</span>
<a id="ln-2605" name="ln-2605" href="#ln-2605"></a><span class="w">         </span><span class="n">spinup</span><span class="w">         </span><span class="c">! for POP (initialize pop)</span>
<a id="ln-2606" name="ln-2606" href="#ln-2606"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TFRZ</span><span class="p">,</span><span class="w"> </span><span class="n">EMSOIL</span><span class="w"></span>
<a id="ln-2607" name="ln-2607" href="#ln-2607"></a>
<a id="ln-2608" name="ln-2608" href="#ln-2608"></a><span class="w">    </span><span class="c">! Local variables</span>
<a id="ln-2609" name="ln-2609" href="#ln-2609"></a><span class="w">    </span><span class="kt">REAL</span><span class="p">,</span><span class="k">POINTER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:)</span><span class="w">          </span><span class="kd">::</span><span class="w"> </span><span class="n">pfractmp</span><span class="w"> </span><span class="c">! temp store of patch fraction</span>
<a id="ln-2610" name="ln-2610" href="#ln-2610"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="w">                                 </span><span class="kd">::</span><span class="w"> </span><span class="n">completeSet</span><span class="w"> </span><span class="c">! was a complete parameter set found?</span>
<a id="ln-2611" name="ln-2611" href="#ln-2611"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="w">                            </span><span class="kd">::</span><span class="w"> </span><span class="n">EXRST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span><span class="w"> </span><span class="c">! does a RunIden restart file exist?</span>
<a id="ln-2612" name="ln-2612" href="#ln-2612"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">                            </span><span class="kd">::</span><span class="w">                                  </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2613" name="ln-2613" href="#ln-2613"></a><span class="w">         </span><span class="n">mp_restart</span><span class="p">,</span><span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! total number of patches in restart file</span>
<a id="ln-2614" name="ln-2614" href="#ln-2614"></a><span class="w">         </span><span class="n">mpID</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2615" name="ln-2615" href="#ln-2615"></a><span class="w">         </span><span class="n">napID</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2616" name="ln-2616" href="#ln-2616"></a><span class="w">         </span><span class="n">i</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w">                   </span><span class="c">! do loop variables</span>
<a id="ln-2617" name="ln-2617" href="#ln-2617"></a><span class="w">    </span><span class="c">!! vh_js !!</span>
<a id="ln-2618" name="ln-2618" href="#ln-2618"></a><span class="w">    </span><span class="c">! CHARACTER :: frst_in*100, CYEAR*4</span>
<a id="ln-2619" name="ln-2619" href="#ln-2619"></a><span class="w">    </span><span class="kt">CHARACTER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">frst_in</span><span class="o">*</span><span class="mi">200</span><span class="p">,</span><span class="w"> </span><span class="n">CYEAR</span><span class="o">*</span><span class="mi">4</span><span class="w"></span>
<a id="ln-2620" name="ln-2620" href="#ln-2620"></a>
<a id="ln-2621" name="ln-2621" href="#ln-2621"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">   </span><span class="kd">::</span><span class="w"> </span><span class="n">IOS</span><span class="w"></span>
<a id="ln-2622" name="ln-2622" href="#ln-2622"></a><span class="w">    </span><span class="kt">CHARACTER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">TACC</span><span class="o">*</span><span class="mi">20</span><span class="w"></span>
<a id="ln-2623" name="ln-2623" href="#ln-2623"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="k">DIMENSION</span><span class="p">(:),</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ALLVEG</span><span class="w"></span>
<a id="ln-2624" name="ln-2624" href="#ln-2624"></a><span class="w">    </span><span class="c">!! vh_js !!</span>
<a id="ln-2625" name="ln-2625" href="#ln-2625"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">mp_POP</span><span class="w"></span>
<a id="ln-2626" name="ln-2626" href="#ln-2626"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">DIMENSION</span><span class="p">(:),</span><span class="w"> </span><span class="k">ALLOCATABLE</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">Iwood</span><span class="w"></span>
<a id="ln-2627" name="ln-2627" href="#ln-2627"></a>
<a id="ln-2628" name="ln-2628" href="#ln-2628"></a><span class="w">    </span><span class="c">! Allocate spatial heterogeneity variables:</span>
<a id="ln-2629" name="ln-2629" href="#ln-2629"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">landpt</span><span class="p">(</span><span class="n">mland</span><span class="p">))</span><span class="w"></span>
<a id="ln-2630" name="ln-2630" href="#ln-2630"></a>
<a id="ln-2631" name="ln-2631" href="#ln-2631"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------------------------------&#39;</span><span class="w"></span>
<a id="ln-2632" name="ln-2632" href="#ln-2632"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Looking for parameters and initial states....&#39;</span><span class="w"></span>
<a id="ln-2633" name="ln-2633" href="#ln-2633"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Loading initialisations from default grid.&#39;</span><span class="w"></span>
<a id="ln-2634" name="ln-2634" href="#ln-2634"></a>
<a id="ln-2635" name="ln-2635" href="#ln-2635"></a><span class="w">    </span><span class="c">! Parameter values and some grid info are read in.</span>
<a id="ln-2636" name="ln-2636" href="#ln-2636"></a><span class="w">    </span><span class="c">! They will be overwritten by values from the restart file, if present.</span>
<a id="ln-2637" name="ln-2637" href="#ln-2637"></a><span class="w">    </span><span class="c">! Those variables found in the met file will again overwrite existing ones.</span>
<a id="ln-2638" name="ln-2638" href="#ln-2638"></a>
<a id="ln-2639" name="ln-2639" href="#ln-2639"></a><span class="w">    </span><span class="k">CALL </span><span class="n">get_default_params</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="n">vegparmnew</span><span class="p">,</span><span class="n">LUC_EXPT</span><span class="p">)</span><span class="w"></span>
<a id="ln-2640" name="ln-2640" href="#ln-2640"></a><span class="w">    </span><span class="k">CALL </span><span class="n">allocate_cable_vars</span><span class="p">(</span><span class="n">air</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">canopy</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">bal</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2641" name="ln-2641" href="#ln-2641"></a><span class="w">         </span><span class="n">sum_flux</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span><span class="w"></span>
<a id="ln-2642" name="ln-2642" href="#ln-2642"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; CABLE variables allocated with &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">mp</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; patch(es).&#39;</span><span class="w"></span>
<a id="ln-2643" name="ln-2643" href="#ln-2643"></a>
<a id="ln-2644" name="ln-2644" href="#ln-2644"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">icycle</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">CASA_DUMP_WRITE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2645" name="ln-2645" href="#ln-2645"></a><span class="w">         </span><span class="k">CALL </span><span class="n">alloc_casavariable</span><span class="p">(</span><span class="n">casabiome</span><span class="p">,</span><span class="n">casapool</span><span class="p">,</span><span class="n">casaflux</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2646" name="ln-2646" href="#ln-2646"></a><span class="w">         </span><span class="n">casamet</span><span class="p">,</span><span class="n">casabal</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span><span class="w"></span>
<a id="ln-2647" name="ln-2647" href="#ln-2647"></a><span class="w">    </span><span class="c">!mpdiff</span>
<a id="ln-2648" name="ln-2648" href="#ln-2648"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_sum_casavariable</span><span class="p">(</span><span class="n">sum_casapool</span><span class="p">,</span><span class="n">sum_casaflux</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span><span class="w"></span>
<a id="ln-2649" name="ln-2649" href="#ln-2649"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">icycle</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2650" name="ln-2650" href="#ln-2650"></a><span class="k">       CALL </span><span class="n">alloc_phenvariable</span><span class="p">(</span><span class="n">phen</span><span class="p">,</span><span class="n">mp</span><span class="p">)</span><span class="w"></span>
<a id="ln-2651" name="ln-2651" href="#ln-2651"></a><span class="w">    </span><span class="k">ENDIF</span><span class="w"></span>
<a id="ln-2652" name="ln-2652" href="#ln-2652"></a>
<a id="ln-2653" name="ln-2653" href="#ln-2653"></a><span class="w">    </span><span class="c">! Write parameter values to CABLE&#39;s parameter variables:</span>
<a id="ln-2654" name="ln-2654" href="#ln-2654"></a><span class="w">    </span><span class="k">CALL </span><span class="n">write_default_params</span><span class="p">(</span><span class="n">met</span><span class="p">,</span><span class="n">air</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">canopy</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2655" name="ln-2655" href="#ln-2655"></a><span class="w">         </span><span class="n">rad</span><span class="p">,</span><span class="n">logn</span><span class="p">,</span><span class="n">vegparmnew</span><span class="p">,</span><span class="n">smoy</span><span class="p">,</span><span class="w"> </span><span class="n">TFRZ</span><span class="p">,</span><span class="w"> </span><span class="n">LUC_EXPT</span><span class="p">)</span><span class="w"></span>
<a id="ln-2656" name="ln-2656" href="#ln-2656"></a>
<a id="ln-2657" name="ln-2657" href="#ln-2657"></a>
<a id="ln-2658" name="ln-2658" href="#ln-2658"></a>
<a id="ln-2659" name="ln-2659" href="#ln-2659"></a><span class="w">    </span><span class="c">! Zero out lai where there is no vegetation acc. to veg. index</span>
<a id="ln-2660" name="ln-2660" href="#ln-2660"></a><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">veg</span><span class="p">%</span><span class="n">iveg</span><span class="p">(:)</span><span class="w"> </span><span class="p">.</span><span class="n">GE</span><span class="p">.</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">veg</span><span class="p">%</span><span class="n">vlai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="w"></span>
<a id="ln-2661" name="ln-2661" href="#ln-2661"></a>
<a id="ln-2662" name="ln-2662" href="#ln-2662"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">icycle</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2663" name="ln-2663" href="#ln-2663"></a><span class="k">       CALL </span><span class="n">write_cnp_params</span><span class="p">(</span><span class="n">veg</span><span class="p">,</span><span class="n">casaflux</span><span class="p">,</span><span class="n">casamet</span><span class="p">)</span><span class="w"></span>
<a id="ln-2664" name="ln-2664" href="#ln-2664"></a><span class="w">       </span><span class="k">CALL </span><span class="n">casa_readbiome</span><span class="p">(</span><span class="n">veg</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">casabiome</span><span class="p">,</span><span class="n">casapool</span><span class="p">,</span><span class="n">casaflux</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2665" name="ln-2665" href="#ln-2665"></a><span class="w">            </span><span class="n">casamet</span><span class="p">,</span><span class="n">phen</span><span class="p">)</span><span class="w"></span>
<a id="ln-2666" name="ln-2666" href="#ln-2666"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">PHENOLOGY_SWITCH</span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="s1">&#39;MODIS&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">casa_readphen</span><span class="p">(</span><span class="n">veg</span><span class="p">,</span><span class="n">casamet</span><span class="p">,</span><span class="n">phen</span><span class="p">)</span><span class="w"></span>
<a id="ln-2667" name="ln-2667" href="#ln-2667"></a>
<a id="ln-2668" name="ln-2668" href="#ln-2668"></a><span class="w">       </span><span class="k">CALL </span><span class="n">casa_init</span><span class="p">(</span><span class="n">casabiome</span><span class="p">,</span><span class="n">casamet</span><span class="p">,</span><span class="n">casaflux</span><span class="p">,</span><span class="n">casapool</span><span class="p">,</span><span class="n">casabal</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">phen</span><span class="p">)</span><span class="w"></span>
<a id="ln-2669" name="ln-2669" href="#ln-2669"></a><span class="w">       </span><span class="c">!! vh_js !!</span>
<a id="ln-2670" name="ln-2670" href="#ln-2670"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">CALL_POP</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2671" name="ln-2671" href="#ln-2671"></a><span class="w">          </span><span class="c">! evaluate mp_POP and POP_array</span>
<a id="ln-2672" name="ln-2672" href="#ln-2672"></a><span class="w">          </span><span class="n">mp_POP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">COUNT</span><span class="p">(</span><span class="n">casamet</span><span class="p">%</span><span class="n">iveg2</span><span class="o">==</span><span class="n">forest</span><span class="p">)</span><span class="o">+</span><span class="nb">COUNT</span><span class="p">(</span><span class="n">casamet</span><span class="p">%</span><span class="n">iveg2</span><span class="o">==</span><span class="n">shrub</span><span class="p">)</span><span class="w"></span>
<a id="ln-2673" name="ln-2673" href="#ln-2673"></a>
<a id="ln-2674" name="ln-2674" href="#ln-2674"></a><span class="w">          </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">Iwood</span><span class="p">(</span><span class="n">mp_POP</span><span class="p">))</span><span class="w"></span>
<a id="ln-2675" name="ln-2675" href="#ln-2675"></a><span class="w">          </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<a id="ln-2676" name="ln-2676" href="#ln-2676"></a><span class="w">          </span><span class="k">DO </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mp</span><span class="w"></span>
<a id="ln-2677" name="ln-2677" href="#ln-2677"></a><span class="w">             </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">casamet</span><span class="p">%</span><span class="n">iveg2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="n">forest</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">casamet</span><span class="p">%</span><span class="n">iveg2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="n">shrub</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2678" name="ln-2678" href="#ln-2678"></a><span class="k">                </span><span class="n">Iwood</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<a id="ln-2679" name="ln-2679" href="#ln-2679"></a><span class="w">                </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="w"></span>
<a id="ln-2680" name="ln-2680" href="#ln-2680"></a><span class="w">             </span><span class="k">ENDIF</span>
<a id="ln-2681" name="ln-2681" href="#ln-2681"></a><span class="k">          ENDDO</span>
<a id="ln-2682" name="ln-2682" href="#ln-2682"></a>
<a id="ln-2683" name="ln-2683" href="#ln-2683"></a><span class="k">          CALL </span><span class="n">POP_init</span><span class="p">(</span><span class="w"> </span><span class="n">POP</span><span class="p">,</span><span class="w"> </span><span class="n">veg</span><span class="p">%</span><span class="n">disturbance_interval</span><span class="p">(</span><span class="n">Iwood</span><span class="p">,:),</span><span class="w"> </span><span class="n">mp_POP</span><span class="p">,</span><span class="w"> </span><span class="n">Iwood</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-2684" name="ln-2684" href="#ln-2684"></a><span class="w">          </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">spinup</span><span class="w"> </span><span class="p">.</span><span class="nb">OR</span><span class="p">.</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">POP_fromZero</span><span class="w"> </span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2685" name="ln-2685" href="#ln-2685"></a><span class="w">               </span><span class="k">CALL </span><span class="n">POP_IO</span><span class="p">(</span><span class="w"> </span><span class="n">POP</span><span class="p">,</span><span class="w"> </span><span class="n">casamet</span><span class="p">,</span><span class="w"> </span><span class="n">cable_user</span><span class="p">%</span><span class="n">YearStart</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;READ_rst &quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.)</span><span class="w"></span>
<a id="ln-2686" name="ln-2686" href="#ln-2686"></a>
<a id="ln-2687" name="ln-2687" href="#ln-2687"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-2688" name="ln-2688" href="#ln-2688"></a>
<a id="ln-2689" name="ln-2689" href="#ln-2689"></a><span class="k">       IF</span><span class="w"> </span><span class="p">(</span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">POPLUC</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2690" name="ln-2690" href="#ln-2690"></a>
<a id="ln-2691" name="ln-2691" href="#ln-2691"></a><span class="w">          </span><span class="c">! initialise POPLUC structure and params</span>
<a id="ln-2692" name="ln-2692" href="#ln-2692"></a><span class="w">          </span><span class="c">!zero biomass in secondary forest tiles</span>
<a id="ln-2693" name="ln-2693" href="#ln-2693"></a><span class="w">          </span><span class="c">! read POP_LUC restart file here</span>
<a id="ln-2694" name="ln-2694" href="#ln-2694"></a><span class="w">          </span><span class="c">! set POP%LU here for secondary tiles if cable_user%POPLUC_RunType is not &#39;static&#39;</span>
<a id="ln-2695" name="ln-2695" href="#ln-2695"></a><span class="w">          </span><span class="k">CALL </span><span class="n">POPLUC_init</span><span class="p">(</span><span class="n">POPLUC</span><span class="p">,</span><span class="n">LUC_EXPT</span><span class="p">,</span><span class="w"> </span><span class="n">casapool</span><span class="p">,</span><span class="w"> </span><span class="n">casaflux</span><span class="p">,</span><span class="w"> </span><span class="n">casabiome</span><span class="p">,</span><span class="w"> </span><span class="n">veg</span><span class="p">,</span><span class="w"> </span><span class="n">POP</span><span class="p">,</span><span class="w"> </span><span class="n">mland</span><span class="p">)</span><span class="w"></span>
<a id="ln-2696" name="ln-2696" href="#ln-2696"></a>
<a id="ln-2697" name="ln-2697" href="#ln-2697"></a><span class="w">       </span><span class="k">ENDIF</span>
<a id="ln-2698" name="ln-2698" href="#ln-2698"></a>
<a id="ln-2699" name="ln-2699" href="#ln-2699"></a><span class="k">    ENDIF</span><span class="w"></span>
<a id="ln-2700" name="ln-2700" href="#ln-2700"></a>
<a id="ln-2701" name="ln-2701" href="#ln-2701"></a><span class="w">    </span><span class="c">! removed get_default_inits and get_default_lai as they are already done</span>
<a id="ln-2702" name="ln-2702" href="#ln-2702"></a><span class="w">    </span><span class="c">! in write_default_params</span>
<a id="ln-2703" name="ln-2703" href="#ln-2703"></a><span class="w">    </span><span class="c">!    ! Load default initialisations from Mk3L climatology:</span>
<a id="ln-2704" name="ln-2704" href="#ln-2704"></a><span class="w">    </span><span class="c">!    CALL get_default_inits(met,soil,ssnow,canopy,logn)</span>
<a id="ln-2705" name="ln-2705" href="#ln-2705"></a><span class="w">    </span><span class="c">!</span>
<a id="ln-2706" name="ln-2706" href="#ln-2706"></a><span class="w">    </span><span class="c">!    ! load default LAI values from global data:</span>
<a id="ln-2707" name="ln-2707" href="#ln-2707"></a><span class="w">    </span><span class="c">!    CALL get_default_lai</span>
<a id="ln-2708" name="ln-2708" href="#ln-2708"></a>
<a id="ln-2709" name="ln-2709" href="#ln-2709"></a><span class="w">    </span><span class="c">! Look for explicit restart file (which will have parameters):</span>
<a id="ln-2710" name="ln-2710" href="#ln-2710"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">restart_in</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">filename</span><span class="p">%</span><span class="n">restart_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;./&#39;</span><span class="w"></span>
<a id="ln-2711" name="ln-2711" href="#ln-2711"></a><span class="w">    </span><span class="n">frst_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filename</span><span class="p">%</span><span class="n">restart_in</span><span class="w"></span>
<a id="ln-2712" name="ln-2712" href="#ln-2712"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">),</span><span class="n">NF90_NOWRITE</span><span class="p">,</span><span class="n">ncid_rin</span><span class="p">)</span><span class="w"></span>
<a id="ln-2713" name="ln-2713" href="#ln-2713"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">EXRST</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"></span>
<a id="ln-2714" name="ln-2714" href="#ln-2714"></a>
<a id="ln-2715" name="ln-2715" href="#ln-2715"></a><span class="w">    </span><span class="c">! If not an explicit rstfile, search for RunIden_YEAR...nc</span>
<a id="ln-2716" name="ln-2716" href="#ln-2716"></a><span class="w">    </span><span class="c">! use (filename%restart_in) as path</span>
<a id="ln-2717" name="ln-2717" href="#ln-2717"></a><span class="w">    </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">.</span><span class="nb">NOT</span><span class="p">.</span><span class="w"> </span><span class="n">EXRST</span><span class="w"> </span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="w"> </span><span class="n">CABLE_USER</span><span class="p">%</span><span class="n">YEARSTART</span><span class="w"> </span><span class="p">.</span><span class="n">GT</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2718" name="ln-2718" href="#ln-2718"></a><span class="k">       WRITE</span><span class="p">(</span><span class="w"> </span><span class="n">CYEAR</span><span class="p">,</span><span class="n">FMT</span><span class="o">=</span><span class="s2">&quot;(I4)&quot;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">CurYear</span><span class="w"></span>
<a id="ln-2719" name="ln-2719" href="#ln-2719"></a><span class="w">       </span><span class="n">frst_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">restart_in</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;/&#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">cable_user</span><span class="p">%</span><span class="n">RunIden</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2720" name="ln-2720" href="#ln-2720"></a><span class="w">            </span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="n">CYEAR</span><span class="o">//</span><span class="s1">&#39;_cable_rst.nc&#39;</span><span class="w"></span>
<a id="ln-2721" name="ln-2721" href="#ln-2721"></a><span class="w">       </span><span class="k">INQUIRE</span><span class="p">(</span><span class="w"> </span><span class="k">FILE</span><span class="o">=</span><span class="nb">TRIM</span><span class="p">(</span><span class="w"> </span><span class="n">frst_in</span><span class="w"> </span><span class="p">),</span><span class="w"> </span><span class="n">EXIST</span><span class="o">=</span><span class="n">EXRST</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-2722" name="ln-2722" href="#ln-2722"></a><span class="w">    </span><span class="k">ENDIF</span>
<a id="ln-2723" name="ln-2723" href="#ln-2723"></a>
<a id="ln-2724" name="ln-2724" href="#ln-2724"></a><span class="k">    IF</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">EXRST</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2725" name="ln-2725" href="#ln-2725"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="p">(</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">),</span><span class="n">NF90_NOWRITE</span><span class="p">,</span><span class="n">ncid_rin</span><span class="p">)</span><span class="w"> </span><span class="c">! open restart file</span>
<a id="ln-2726" name="ln-2726" href="#ln-2726"></a><span class="w">       </span><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">HANDLE_ERR</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="w"></span>
<a id="ln-2727" name="ln-2727" href="#ln-2727"></a><span class="w">       </span><span class="c">! Any restart file exists, parameters and init will be loaded from it.</span>
<a id="ln-2728" name="ln-2728" href="#ln-2728"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Overwriting initialisations with values in &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2729" name="ln-2729" href="#ln-2729"></a><span class="w">            </span><span class="s1">&#39;restart file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="w"></span>
<a id="ln-2730" name="ln-2730" href="#ln-2730"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">    </span><span class="s1">&#39; Overwriting initialisations with values in &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2731" name="ln-2731" href="#ln-2731"></a><span class="w">            </span><span class="s1">&#39;restart file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="w"></span>
<a id="ln-2732" name="ln-2732" href="#ln-2732"></a>
<a id="ln-2733" name="ln-2733" href="#ln-2733"></a><span class="w">       </span><span class="c">! Check total number of patches in restart file:</span>
<a id="ln-2734" name="ln-2734" href="#ln-2734"></a><span class="w">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_rin</span><span class="p">,</span><span class="s1">&#39;mp&#39;</span><span class="p">,</span><span class="n">mpID</span><span class="p">)</span><span class="w"></span>
<a id="ln-2735" name="ln-2735" href="#ln-2735"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span>
<a id="ln-2736" name="ln-2736" href="#ln-2736"></a><span class="k">          </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="p">(</span><span class="n">ncid_rin</span><span class="p">,</span><span class="s1">&#39;mp_patch&#39;</span><span class="p">,</span><span class="n">mpID</span><span class="p">)</span><span class="w"></span>
<a id="ln-2737" name="ln-2737" href="#ln-2737"></a><span class="w">          </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w">  </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2738" name="ln-2738" href="#ln-2738"></a><span class="w">               </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding mp or mp_patch dimension in restart file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2739" name="ln-2739" href="#ln-2739"></a><span class="w">               </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE load_parameters) &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2740" name="ln-2740" href="#ln-2740"></a><span class="w">               </span><span class="o">//</span><span class="s1">&#39;Recommend running without restart file.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2741" name="ln-2741" href="#ln-2741"></a><span class="w">       </span><span class="k">END IF</span>
<a id="ln-2742" name="ln-2742" href="#ln-2742"></a><span class="k">       </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="p">(</span><span class="n">ncid_rin</span><span class="p">,</span><span class="n">mpID</span><span class="p">,</span><span class="nb">len</span><span class="o">=</span><span class="n">mp_restart</span><span class="p">)</span><span class="w"></span>
<a id="ln-2743" name="ln-2743" href="#ln-2743"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="n">nc_abort</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2744" name="ln-2744" href="#ln-2744"></a><span class="w">            </span><span class="p">(</span><span class="n">ok</span><span class="p">,</span><span class="s1">&#39;Error finding total number of patches in restart file &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2745" name="ln-2745" href="#ln-2745"></a><span class="w">            </span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; (SUBROUTINE load_parameters) &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2746" name="ln-2746" href="#ln-2746"></a><span class="w">            </span><span class="o">//</span><span class="s1">&#39;Recommend running without restart file.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2747" name="ln-2747" href="#ln-2747"></a><span class="w">       </span><span class="c">! Check that mp_restart = mp from default/met values</span>
<a id="ln-2748" name="ln-2748" href="#ln-2748"></a><span class="w">       </span><span class="k">IF</span><span class="p">(</span><span class="n">mp_restart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">mp</span><span class="p">)</span><span class="w"> </span><span class="k">CALL </span><span class="nb">abort</span><span class="p">(</span><span class="s1">&#39;Number of patches in &#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2749" name="ln-2749" href="#ln-2749"></a><span class="w">            </span><span class="s1">&#39;restart file &#39;</span><span class="o">//</span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; does not equal &#39;</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2750" name="ln-2750" href="#ln-2750"></a><span class="w">            </span><span class="s1">&#39;to number in default/met file settings. (SUB load_parameters) &#39;</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2751" name="ln-2751" href="#ln-2751"></a><span class="w">            </span><span class="o">//</span><span class="s1">&#39;Recommend running without restart file.&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2752" name="ln-2752" href="#ln-2752"></a>
<a id="ln-2753" name="ln-2753" href="#ln-2753"></a><span class="w">       </span><span class="c">! Load initialisations and parameters from restart file:</span>
<a id="ln-2754" name="ln-2754" href="#ln-2754"></a><span class="w">       </span><span class="k">CALL </span><span class="n">get_restart_data</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="n">canopy</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">bal</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2755" name="ln-2755" href="#ln-2755"></a><span class="w">            </span><span class="n">soil</span><span class="p">,</span><span class="n">rad</span><span class="p">,</span><span class="n">vegparmnew</span><span class="p">,</span><span class="w"> </span><span class="n">EMSOIL</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<a id="ln-2756" name="ln-2756" href="#ln-2756"></a>
<a id="ln-2757" name="ln-2757" href="#ln-2757"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"></span>
<a id="ln-2758" name="ln-2758" href="#ln-2758"></a><span class="w">       </span><span class="c">! With no restart file, use default parameters already loaded</span>
<a id="ln-2759" name="ln-2759" href="#ln-2759"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Could neither find restart file &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">restart_in</span><span class="p">)</span><span class="w"></span>
<a id="ln-2760" name="ln-2760" href="#ln-2760"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; nor &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="w"></span>
<a id="ln-2761" name="ln-2761" href="#ln-2761"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Pre-loaded default initialisations are used.&#39;</span><span class="w"></span>
<a id="ln-2762" name="ln-2762" href="#ln-2762"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">    </span><span class="s1">&#39; Could neither find restart file &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">restart_in</span><span class="p">)</span><span class="w"></span>
<a id="ln-2763" name="ln-2763" href="#ln-2763"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">    </span><span class="s1">&#39; nor &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">frst_in</span><span class="p">)</span><span class="w"></span>
<a id="ln-2764" name="ln-2764" href="#ln-2764"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">    </span><span class="s1">&#39; Pre-loaded default initialisations are used.&#39;</span><span class="w"></span>
<a id="ln-2765" name="ln-2765" href="#ln-2765"></a><span class="w">    </span><span class="k">END IF</span><span class="w"> </span><span class="c">! if restart file exists</span>
<a id="ln-2766" name="ln-2766" href="#ln-2766"></a>
<a id="ln-2767" name="ln-2767" href="#ln-2767"></a><span class="w">    </span><span class="c">! Overwrite default values by those available in met file:</span>
<a id="ln-2768" name="ln-2768" href="#ln-2768"></a><span class="w">    </span><span class="k">CALL </span><span class="n">get_parameters_met</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">completeSet</span><span class="p">)</span><span class="w"></span>
<a id="ln-2769" name="ln-2769" href="#ln-2769"></a>
<a id="ln-2770" name="ln-2770" href="#ln-2770"></a><span class="w">    </span><span class="c">! Results of looking for parameters in the met file:</span>
<a id="ln-2771" name="ln-2771" href="#ln-2771"></a><span class="w">    </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<a id="ln-2772" name="ln-2772" href="#ln-2772"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">parameters</span><span class="p">.</span><span class="nb">AND</span><span class="p">.</span><span class="n">completeSet</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2773" name="ln-2773" href="#ln-2773"></a><span class="w">       </span><span class="c">! All pars were found in met file:</span>
<a id="ln-2774" name="ln-2774" href="#ln-2774"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Loaded all parameters from met input file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2775" name="ln-2775" href="#ln-2775"></a><span class="w">            </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">)</span><span class="w"></span>
<a id="ln-2776" name="ln-2776" href="#ln-2776"></a><span class="w">    </span><span class="k">ELSE IF</span><span class="p">(</span><span class="n">exists</span><span class="p">%</span><span class="n">parameters</span><span class="p">.</span><span class="nb">AND</span><span class="p">..</span><span class="nb">NOT</span><span class="p">.</span><span class="n">completeSet</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"></span>
<a id="ln-2777" name="ln-2777" href="#ln-2777"></a><span class="w">       </span><span class="c">! Only some pars were found in met file:</span>
<a id="ln-2778" name="ln-2778" href="#ln-2778"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Loaded some parameters from met input file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2779" name="ln-2779" href="#ln-2779"></a><span class="w">            </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! write to log file</span>
<a id="ln-2780" name="ln-2780" href="#ln-2780"></a><span class="w">            </span><span class="s1">&#39; the rest are default values&#39;</span><span class="w"></span>
<a id="ln-2781" name="ln-2781" href="#ln-2781"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w">    </span><span class="s1">&#39; Loaded some parameters from met input file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2782" name="ln-2782" href="#ln-2782"></a><span class="w">            </span><span class="nb">TRIM</span><span class="p">(</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span><span class="w"> </span><span class="c">! write to screen</span>
<a id="ln-2783" name="ln-2783" href="#ln-2783"></a><span class="w">            </span><span class="s1">&#39; the rest are default values - check log file&#39;</span><span class="w"></span>
<a id="ln-2784" name="ln-2784" href="#ln-2784"></a><span class="w">    </span><span class="k">ELSE</span><span class="w"></span>
<a id="ln-2785" name="ln-2785" href="#ln-2785"></a><span class="w">       </span><span class="c">! No parameters were found in met file:</span>
<a id="ln-2786" name="ln-2786" href="#ln-2786"></a><span class="w">       </span><span class="k">WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Met file has no params; all parameters remain as default.&#39;</span><span class="w"></span>
<a id="ln-2787" name="ln-2787" href="#ln-2787"></a><span class="w">    </span><span class="k">END IF</span>
<a id="ln-2788" name="ln-2788" href="#ln-2788"></a><span class="k">    WRITE</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<a id="ln-2789" name="ln-2789" href="#ln-2789"></a>
<a id="ln-2790" name="ln-2790" href="#ln-2790"></a><span class="w">    </span><span class="c">! Construct derived parameters and zero initialisations, regardless</span>
<a id="ln-2791" name="ln-2791" href="#ln-2791"></a><span class="w">    </span><span class="c">! of where parameters and other initialisations have loaded from:</span>
<a id="ln-2792" name="ln-2792" href="#ln-2792"></a><span class="w">    </span><span class="k">CALL </span><span class="n">derived_parameters</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span><span class="n">sum_flux</span><span class="p">,</span><span class="n">bal</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">rough</span><span class="p">)</span><span class="w"></span>
<a id="ln-2793" name="ln-2793" href="#ln-2793"></a>
<a id="ln-2794" name="ln-2794" href="#ln-2794"></a><span class="w">    </span><span class="c">! Check for basic inconsistencies in parameter values:</span>
<a id="ln-2795" name="ln-2795" href="#ln-2795"></a><span class="w">    </span><span class="k">CALL </span><span class="n">check_parameter_values</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">ssnow</span><span class="p">)</span><span class="w"></span>
<a id="ln-2796" name="ln-2796" href="#ln-2796"></a>
<a id="ln-2797" name="ln-2797" href="#ln-2797"></a><span class="w">    </span><span class="c">! Write per-site parameter values to log file if requested:</span>
<a id="ln-2798" name="ln-2798" href="#ln-2798"></a><span class="w">    </span><span class="k">CALL </span><span class="n">report_parameters</span><span class="p">(</span><span class="n">logn</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="n">canopy</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2799" name="ln-2799" href="#ln-2799"></a><span class="w">         </span><span class="n">casamet</span><span class="p">,</span><span class="n">casapool</span><span class="p">,</span><span class="n">casaflux</span><span class="p">,</span><span class="n">phen</span><span class="p">,</span><span class="n">vegparmnew</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span><span class="w"></span>
<a id="ln-2800" name="ln-2800" href="#ln-2800"></a>
<a id="ln-2801" name="ln-2801" href="#ln-2801"></a>
<a id="ln-2802" name="ln-2802" href="#ln-2802"></a><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">load_parameters</span><span class="w"></span>
<a id="ln-2803" name="ln-2803" href="#ln-2803"></a>
<a id="ln-2804" name="ln-2804" href="#ln-2804"></a>
<a id="ln-2805" name="ln-2805" href="#ln-2805"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2806" name="ln-2806" href="#ln-2806"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2807" name="ln-2807" href="#ln-2807"></a><span class="w">  </span><span class="c">! Name: get_parameters_met</span>
<a id="ln-2808" name="ln-2808" href="#ln-2808"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2809" name="ln-2809" href="#ln-2809"></a><span class="w">  </span><span class="c">! Purpose: This subroutine looks for parameters in the met file, and loads</span>
<a id="ln-2810" name="ln-2810" href="#ln-2810"></a><span class="w">  </span><span class="c">!          those that are found.</span>
<a id="ln-2811" name="ln-2811" href="#ln-2811"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2812" name="ln-2812" href="#ln-2812"></a><span class="w">  </span><span class="c">! CALLed from: load_parameters</span>
<a id="ln-2813" name="ln-2813" href="#ln-2813"></a><span class="w">  </span><span class="c">!              old_load_parameters</span>
<a id="ln-2814" name="ln-2814" href="#ln-2814"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2815" name="ln-2815" href="#ln-2815"></a><span class="w">  </span><span class="c">! CALLs: readpar</span>
<a id="ln-2816" name="ln-2816" href="#ln-2816"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2817" name="ln-2817" href="#ln-2817"></a><span class="w">  </span><span class="c">! Input file: [SiteName].nc</span>
<a id="ln-2818" name="ln-2818" href="#ln-2818"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2819" name="ln-2819" href="#ln-2819"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2820" name="ln-2820" href="#ln-2820"></a>
<a id="ln-2821" name="ln-2821" href="#ln-2821"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">get_parameters_met</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span><span class="n">veg</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">completeSet</span><span class="p">)</span><span class="w"></span>
<a id="ln-2822" name="ln-2822" href="#ln-2822"></a>
<a id="ln-2823" name="ln-2823" href="#ln-2823"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">soil_parameter_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">soil</span><span class="w"></span>
<a id="ln-2824" name="ln-2824" href="#ln-2824"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">veg_parameter_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">veg</span><span class="w"></span>
<a id="ln-2825" name="ln-2825" href="#ln-2825"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">bgc_pool_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">bgc</span><span class="w"></span>
<a id="ln-2826" name="ln-2826" href="#ln-2826"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">roughness_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">rough</span><span class="w"></span>
<a id="ln-2827" name="ln-2827" href="#ln-2827"></a><span class="w">    </span><span class="kt">LOGICAL</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span><span class="w">                      </span><span class="kd">::</span><span class="w"> </span><span class="n">completeSet</span><span class="w"> </span><span class="c">! were all pars found?</span>
<a id="ln-2828" name="ln-2828" href="#ln-2828"></a>
<a id="ln-2829" name="ln-2829" href="#ln-2829"></a><span class="w">    </span><span class="c">! Local variables</span>
<a id="ln-2830" name="ln-2830" href="#ln-2830"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="w">                              </span><span class="kd">::</span><span class="w"> </span><span class="n">parID</span><span class="w"> </span><span class="c">! parameter&#39;s netcdf ID</span>
<a id="ln-2831" name="ln-2831" href="#ln-2831"></a>
<a id="ln-2832" name="ln-2832" href="#ln-2832"></a><span class="w">    </span><span class="c">! removed the following section because already in IGBP types (BP apr08)</span>
<a id="ln-2833" name="ln-2833" href="#ln-2833"></a><span class="w">    </span><span class="c">!    ! First, if user defined surface type ratios are present in the</span>
<a id="ln-2834" name="ln-2834" href="#ln-2834"></a><span class="w">    </span><span class="c">!    ! met file then use them:</span>
<a id="ln-2835" name="ln-2835" href="#ln-2835"></a><span class="w">    </span><span class="c">!    IF(ASSOCIATED(vegfrac_user)) THEN</span>
<a id="ln-2836" name="ln-2836" href="#ln-2836"></a><span class="w">    </span><span class="c">!       DO i=1,mland</span>
<a id="ln-2837" name="ln-2837" href="#ln-2837"></a><span class="w">    </span><span class="c">!          ! Overwrite landpt(i)%*%frac, which will be set either by restart</span>
<a id="ln-2838" name="ln-2838" href="#ln-2838"></a><span class="w">    </span><span class="c">!          ! or default values:</span>
<a id="ln-2839" name="ln-2839" href="#ln-2839"></a><span class="w">    </span><span class="c">!          landpt(i)%veg%frac = vegfrac_user(i)</span>
<a id="ln-2840" name="ln-2840" href="#ln-2840"></a><span class="w">    </span><span class="c">!          landpt(i)%urban%frac = urbanfrac_user(i)</span>
<a id="ln-2841" name="ln-2841" href="#ln-2841"></a><span class="w">    </span><span class="c">!          landpt(i)%lake%frac = lakefrac_user(i)</span>
<a id="ln-2842" name="ln-2842" href="#ln-2842"></a><span class="w">    </span><span class="c">!          landpt(i)%ice%frac = icefrac_user(i)</span>
<a id="ln-2843" name="ln-2843" href="#ln-2843"></a><span class="w">    </span><span class="c">!       END DO</span>
<a id="ln-2844" name="ln-2844" href="#ln-2844"></a><span class="w">    </span><span class="c">!    END IF</span>
<a id="ln-2845" name="ln-2845" href="#ln-2845"></a>
<a id="ln-2846" name="ln-2846" href="#ln-2846"></a><span class="w">    </span><span class="n">completeSet</span><span class="o">=</span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span><span class="w"> </span><span class="c">! initialise (assume all param will load from met file)</span>
<a id="ln-2847" name="ln-2847" href="#ln-2847"></a>
<a id="ln-2848" name="ln-2848" href="#ln-2848"></a><span class="w">    </span><span class="c">! Get parameter values:</span>
<a id="ln-2849" name="ln-2849" href="#ln-2849"></a><span class="w">    </span><span class="c">! Arguments: netcdf file ID; parameter name; complete set check;</span>
<a id="ln-2850" name="ln-2850" href="#ln-2850"></a><span class="w">    </span><span class="c">!   parameter value; filename for error messages; number of veg/soil patches</span>
<a id="ln-2851" name="ln-2851" href="#ln-2851"></a><span class="w">    </span><span class="c">!   in met file; switch to indicate size of dimensions of the parameter.</span>
<a id="ln-2852" name="ln-2852" href="#ln-2852"></a><span class="w">    </span><span class="c">! ! Use &#39;defd&#39; for single dim double precision.</span>
<a id="ln-2853" name="ln-2853" href="#ln-2853"></a><span class="w">    </span><span class="c">! veg and soil types already obtained in sub open_met_file</span>
<a id="ln-2854" name="ln-2854" href="#ln-2854"></a><span class="w">    </span><span class="c">!    CALL readpar(ncid_met,&#39;iveg&#39;,completeSet,veg%iveg,filename%met, &amp;</span>
<a id="ln-2855" name="ln-2855" href="#ln-2855"></a><span class="w">    </span><span class="c">!         nmetpatches,&#39;def&#39;)</span>
<a id="ln-2856" name="ln-2856" href="#ln-2856"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;patchfrac&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">patch</span><span class="p">(:)%</span><span class="n">frac</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">   </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2857" name="ln-2857" href="#ln-2857"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2858" name="ln-2858" href="#ln-2858"></a><span class="w">    </span><span class="c">!    CALL readpar(ncid_met,&#39;isoil&#39;,completeSet,soil%isoilm,filename%met, &amp;</span>
<a id="ln-2859" name="ln-2859" href="#ln-2859"></a><span class="w">    </span><span class="c">!         nmetpatches,&#39;def&#39;)</span>
<a id="ln-2860" name="ln-2860" href="#ln-2860"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;clay&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">clay</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2861" name="ln-2861" href="#ln-2861"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2862" name="ln-2862" href="#ln-2862"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;sand&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">sand</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2863" name="ln-2863" href="#ln-2863"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2864" name="ln-2864" href="#ln-2864"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;silt&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">silt</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2865" name="ln-2865" href="#ln-2865"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2866" name="ln-2866" href="#ln-2866"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;ssat&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">ssat</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2867" name="ln-2867" href="#ln-2867"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2868" name="ln-2868" href="#ln-2868"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;sfc&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">sfc</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2869" name="ln-2869" href="#ln-2869"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2870" name="ln-2870" href="#ln-2870"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;swilt&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">swilt</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">          </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2871" name="ln-2871" href="#ln-2871"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2872" name="ln-2872" href="#ln-2872"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;bch&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">bch</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2873" name="ln-2873" href="#ln-2873"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2874" name="ln-2874" href="#ln-2874"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;hyds&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">hyds</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2875" name="ln-2875" href="#ln-2875"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2876" name="ln-2876" href="#ln-2876"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;sucs&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">sucs</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2877" name="ln-2877" href="#ln-2877"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2878" name="ln-2878" href="#ln-2878"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;css&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">css</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2879" name="ln-2879" href="#ln-2879"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2880" name="ln-2880" href="#ln-2880"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;rhosoil&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">rhosoil</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2881" name="ln-2881" href="#ln-2881"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2882" name="ln-2882" href="#ln-2882"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;rs20&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">rs20</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2883" name="ln-2883" href="#ln-2883"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2884" name="ln-2884" href="#ln-2884"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;albsoil&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">albsoil</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2885" name="ln-2885" href="#ln-2885"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;nrb&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2886" name="ln-2886" href="#ln-2886"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;froot&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">froot</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2887" name="ln-2887" href="#ln-2887"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2888" name="ln-2888" href="#ln-2888"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;hc&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">hc</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">                 </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2889" name="ln-2889" href="#ln-2889"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2890" name="ln-2890" href="#ln-2890"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;canst1&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">canst1</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2891" name="ln-2891" href="#ln-2891"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2892" name="ln-2892" href="#ln-2892"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;dleaf&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">dleaf</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2893" name="ln-2893" href="#ln-2893"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2894" name="ln-2894" href="#ln-2894"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;frac4&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">frac4</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2895" name="ln-2895" href="#ln-2895"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2896" name="ln-2896" href="#ln-2896"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;ejmax&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">ejmax</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2897" name="ln-2897" href="#ln-2897"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2898" name="ln-2898" href="#ln-2898"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;vcmax&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">vcmax</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2899" name="ln-2899" href="#ln-2899"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2900" name="ln-2900" href="#ln-2900"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;rp20&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">rp20</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2901" name="ln-2901" href="#ln-2901"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2902" name="ln-2902" href="#ln-2902"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;rpcoef&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">rpcoef</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2903" name="ln-2903" href="#ln-2903"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2904" name="ln-2904" href="#ln-2904"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;shelrb&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">shelrb</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2905" name="ln-2905" href="#ln-2905"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2906" name="ln-2906" href="#ln-2906"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;xfang&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">xfang</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2907" name="ln-2907" href="#ln-2907"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2908" name="ln-2908" href="#ln-2908"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;wai&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">wai</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">               </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2909" name="ln-2909" href="#ln-2909"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2910" name="ln-2910" href="#ln-2910"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;vegcf&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">vegcf</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2911" name="ln-2911" href="#ln-2911"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2912" name="ln-2912" href="#ln-2912"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;extkn&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">extkn</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2913" name="ln-2913" href="#ln-2913"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2914" name="ln-2914" href="#ln-2914"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;tminvj&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">tminvj</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2915" name="ln-2915" href="#ln-2915"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2916" name="ln-2916" href="#ln-2916"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;tmaxvj&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">tmaxvj</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2917" name="ln-2917" href="#ln-2917"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2918" name="ln-2918" href="#ln-2918"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;vbeta&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">vbeta</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">           </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2919" name="ln-2919" href="#ln-2919"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2920" name="ln-2920" href="#ln-2920"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;xalbnir&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">xalbnir</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">       </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2921" name="ln-2921" href="#ln-2921"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2922" name="ln-2922" href="#ln-2922"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;meth&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">meth</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2923" name="ln-2923" href="#ln-2923"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2924" name="ln-2924" href="#ln-2924"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;g0&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">g0</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">            </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2925" name="ln-2925" href="#ln-2925"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"> </span><span class="c">! Ticket #56</span>
<a id="ln-2926" name="ln-2926" href="#ln-2926"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;g1&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">veg</span><span class="p">%</span><span class="n">g1</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">             </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2927" name="ln-2927" href="#ln-2927"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"> </span><span class="c">! Ticket #56</span>
<a id="ln-2928" name="ln-2928" href="#ln-2928"></a><span class="w">    </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;za&#39;</span><span class="p">,</span><span class="n">parID</span><span class="p">)</span><span class="w"></span>
<a id="ln-2929" name="ln-2929" href="#ln-2929"></a><span class="w">    </span><span class="k">IF</span><span class="p">(</span><span class="n">ok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="c">! if it does exist</span>
<a id="ln-2930" name="ln-2930" href="#ln-2930"></a><span class="w">       </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;za&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">rough</span><span class="p">%</span><span class="n">za_uv</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2931" name="ln-2931" href="#ln-2931"></a><span class="w">            </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2932" name="ln-2932" href="#ln-2932"></a><span class="w">       </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;za&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">rough</span><span class="p">%</span><span class="n">za_tq</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2933" name="ln-2933" href="#ln-2933"></a><span class="w">            </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2934" name="ln-2934" href="#ln-2934"></a><span class="w">    </span><span class="k">ELSE</span>
<a id="ln-2935" name="ln-2935" href="#ln-2935"></a><span class="k">       CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;za_uv&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">rough</span><span class="p">%</span><span class="n">za_uv</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2936" name="ln-2936" href="#ln-2936"></a><span class="w">            </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2937" name="ln-2937" href="#ln-2937"></a><span class="w">       </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;za_tq&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">rough</span><span class="p">%</span><span class="n">za_tq</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">      </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2938" name="ln-2938" href="#ln-2938"></a><span class="w">            </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;def&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2939" name="ln-2939" href="#ln-2939"></a><span class="w">    </span><span class="k">ENDIF</span>
<a id="ln-2940" name="ln-2940" href="#ln-2940"></a><span class="k">    CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;zse&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">soil</span><span class="p">%</span><span class="n">zse</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">              </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2941" name="ln-2941" href="#ln-2941"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2942" name="ln-2942" href="#ln-2942"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;ratecp&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">bgc</span><span class="p">%</span><span class="n">ratecp</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2943" name="ln-2943" href="#ln-2943"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;ncp&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2944" name="ln-2944" href="#ln-2944"></a><span class="w">    </span><span class="k">CALL </span><span class="n">readpar</span><span class="p">(</span><span class="n">ncid_met</span><span class="p">,</span><span class="s1">&#39;ratecs&#39;</span><span class="p">,</span><span class="n">completeSet</span><span class="p">,</span><span class="n">bgc</span><span class="p">%</span><span class="n">ratecs</span><span class="p">,</span><span class="n">filename</span><span class="p">%</span><span class="n">met</span><span class="p">,</span><span class="w">         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2945" name="ln-2945" href="#ln-2945"></a><span class="w">         </span><span class="n">nmetpatches</span><span class="p">,</span><span class="s1">&#39;ncs&#39;</span><span class="p">)</span><span class="w"></span>
<a id="ln-2946" name="ln-2946" href="#ln-2946"></a>
<a id="ln-2947" name="ln-2947" href="#ln-2947"></a><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">get_parameters_met</span><span class="w"></span>
<a id="ln-2948" name="ln-2948" href="#ln-2948"></a>
<a id="ln-2949" name="ln-2949" href="#ln-2949"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2950" name="ln-2950" href="#ln-2950"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2951" name="ln-2951" href="#ln-2951"></a><span class="w">  </span><span class="c">! Name: allocate_cable_vars</span>
<a id="ln-2952" name="ln-2952" href="#ln-2952"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2953" name="ln-2953" href="#ln-2953"></a><span class="w">  </span><span class="c">! Purpose: Allocate CABLE&#39;s main variables.</span>
<a id="ln-2954" name="ln-2954" href="#ln-2954"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2955" name="ln-2955" href="#ln-2955"></a><span class="w">  </span><span class="c">! CALLed from: load_parameters</span>
<a id="ln-2956" name="ln-2956" href="#ln-2956"></a><span class="w">  </span><span class="c">!              old_load_parameters</span>
<a id="ln-2957" name="ln-2957" href="#ln-2957"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2958" name="ln-2958" href="#ln-2958"></a><span class="w">  </span><span class="c">! CALLs: alloc_cbm_var</span>
<a id="ln-2959" name="ln-2959" href="#ln-2959"></a><span class="w">  </span><span class="c">!</span>
<a id="ln-2960" name="ln-2960" href="#ln-2960"></a><span class="w">  </span><span class="c">!==============================================================================</span>
<a id="ln-2961" name="ln-2961" href="#ln-2961"></a>
<a id="ln-2962" name="ln-2962" href="#ln-2962"></a><span class="w">  </span><span class="k">SUBROUTINE </span><span class="n">allocate_cable_vars</span><span class="p">(</span><span class="n">air</span><span class="p">,</span><span class="n">bgc</span><span class="p">,</span><span class="n">canopy</span><span class="p">,</span><span class="n">met</span><span class="p">,</span><span class="n">bal</span><span class="p">,</span><span class="w">                         </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2963" name="ln-2963" href="#ln-2963"></a><span class="w">       </span><span class="n">rad</span><span class="p">,</span><span class="n">rough</span><span class="p">,</span><span class="n">soil</span><span class="p">,</span><span class="n">ssnow</span><span class="p">,</span><span class="n">sum_flux</span><span class="p">,</span><span class="w">                  </span><span class="p">&amp;</span><span class="w"></span>
<a id="ln-2964" name="ln-2964" href="#ln-2964"></a><span class="w">       </span><span class="n">veg</span><span class="p">,</span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2965" name="ln-2965" href="#ln-2965"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">met_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">            </span><span class="kd">::</span><span class="w"> </span><span class="n">met</span><span class="w"></span>
<a id="ln-2966" name="ln-2966" href="#ln-2966"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">air_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">            </span><span class="kd">::</span><span class="w"> </span><span class="n">air</span><span class="w"></span>
<a id="ln-2967" name="ln-2967" href="#ln-2967"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">soil_snow_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">ssnow</span><span class="w"></span>
<a id="ln-2968" name="ln-2968" href="#ln-2968"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">veg_parameter_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">veg</span><span class="w"></span>
<a id="ln-2969" name="ln-2969" href="#ln-2969"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">bgc_pool_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">bgc</span><span class="w"></span>
<a id="ln-2970" name="ln-2970" href="#ln-2970"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">soil_parameter_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">soil</span><span class="w"></span>
<a id="ln-2971" name="ln-2971" href="#ln-2971"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">canopy_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">         </span><span class="kd">::</span><span class="w"> </span><span class="n">canopy</span><span class="w"></span>
<a id="ln-2972" name="ln-2972" href="#ln-2972"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">roughness_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">      </span><span class="kd">::</span><span class="w"> </span><span class="n">rough</span><span class="w"></span>
<a id="ln-2973" name="ln-2973" href="#ln-2973"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">radiation_type</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">rad</span><span class="w"></span>
<a id="ln-2974" name="ln-2974" href="#ln-2974"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">sum_flux_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">sum_flux</span><span class="w"></span>
<a id="ln-2975" name="ln-2975" href="#ln-2975"></a><span class="w">    </span><span class="k">TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">balances_type</span><span class="p">),</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="w">       </span><span class="kd">::</span><span class="w"> </span><span class="n">bal</span><span class="w"></span>
<a id="ln-2976" name="ln-2976" href="#ln-2976"></a><span class="w">    </span><span class="kt">INTEGER</span><span class="p">,</span><span class="w"> </span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="w">                       </span><span class="kd">::</span><span class="w"> </span><span class="n">arraysize</span><span class="w"></span>
<a id="ln-2977" name="ln-2977" href="#ln-2977"></a>
<a id="ln-2978" name="ln-2978" href="#ln-2978"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">air</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2979" name="ln-2979" href="#ln-2979"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">bgc</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2980" name="ln-2980" href="#ln-2980"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">canopy</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2981" name="ln-2981" href="#ln-2981"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">met</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2982" name="ln-2982" href="#ln-2982"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">bal</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2983" name="ln-2983" href="#ln-2983"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">rad</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2984" name="ln-2984" href="#ln-2984"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">rough</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2985" name="ln-2985" href="#ln-2985"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">soil</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2986" name="ln-2986" href="#ln-2986"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">ssnow</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2987" name="ln-2987" href="#ln-2987"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">sum_flux</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2988" name="ln-2988" href="#ln-2988"></a><span class="w">    </span><span class="k">CALL </span><span class="n">alloc_cbm_var</span><span class="p">(</span><span class="n">veg</span><span class="p">,</span><span class="w"> </span><span class="n">arraysize</span><span class="p">)</span><span class="w"></span>
<a id="ln-2989" name="ln-2989" href="#ln-2989"></a>
<a id="ln-2990" name="ln-2990" href="#ln-2990"></a>
<a id="ln-2991" name="ln-2991" href="#ln-2991"></a><span class="w">    </span><span class="c">! Allocate patch fraction variable:</span>
<a id="ln-2992" name="ln-2992" href="#ln-2992"></a><span class="w">    </span><span class="k">ALLOCATE</span><span class="p">(</span><span class="n">patch</span><span class="p">(</span><span class="n">arraysize</span><span class="p">))</span><span class="w"></span>
<a id="ln-2993" name="ln-2993" href="#ln-2993"></a>
<a id="ln-2994" name="ln-2994" href="#ln-2994"></a><span class="w">  </span><span class="k">END SUBROUTINE </span><span class="n">allocate_cable_vars</span><span class="w"></span>
<a id="ln-2995" name="ln-2995" href="#ln-2995"></a>
<a id="ln-2996" name="ln-2996" href="#ln-2996"></a><span class="k">END MODULE </span><span class="n">cable_input_module</span><span class="w"></span>
<a id="ln-2997" name="ln-2997" href="#ln-2997"></a><span class="c">!==============================================================================</span>
</pre></div>

    </section>
    </div>
  </div>

    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-6"><p>CABLE was developed by CABLE community<br>&copy; 2022 
</p>
        </div>
        <div class="col-xs-6 col-md-6">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
          </p>
        </div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
  </body>
</html>